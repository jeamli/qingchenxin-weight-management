# 体重管理数字医生小程序 - 数据库设计文档审查报告

**文档版本**：v1.0  
**创建日期**：2025年8月8日  
**最后更新**：2025年8月8日  
**审查状态**：已完成

---

## 1. 审查概述

### 1.1 审查目的
对从MongoDB转换到MySQL的数据库设计文档进行全面审查，对比标准PRD文档，识别不合理的设计、潜在bug和功能遗漏。

### 1.2 审查范围
- 数据库表结构设计
- 数据关系设计
- 索引和约束设计
- 业务逻辑完整性
- 性能和安全设计

### 1.3 审查方法
- 对比PRD文档需求
- 检查数据完整性
- 验证业务逻辑
- 评估性能影响
- 分析安全风险

---

## 2. 主要问题识别

### 2.1 严重问题（Critical Issues）

#### 2.1.1 数据一致性问题
**问题描述**：部分表仍使用MongoDB格式，未完全转换为MySQL
**影响**：系统无法正常运行

**具体问题**：
1. **运动记录表（exercise_records）**：仍使用MongoDB的JavaScript格式
2. **审核记录表（review_records）**：仍使用MongoDB格式
3. **食物数据库表（food_database）**：仍使用MongoDB格式
4. **运动数据库表（exercise_database）**：仍使用MongoDB格式
5. **用户目标表（user_goals）**：仍使用MongoDB格式
6. **用户统计表（user_statistics）**：仍使用MongoDB格式
7. **通知表（notifications）**：仍使用MongoDB格式
8. **用户反馈表（user_feedback）**：仍使用MongoDB格式
9. **审计日志表（audit_logs）**：仍使用MongoDB格式
10. **操作日志表（operation_logs）**：仍使用MongoDB格式

**修复建议**：
```sql
-- 运动记录表MySQL版本
CREATE TABLE `exercise_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '记录ID（主键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `exercise_type` enum('cardio','strength','flexibility','balance','sports') NOT NULL COMMENT '运动类型',
  `exercise_name` varchar(200) NOT NULL COMMENT '运动名称',
  `duration` int unsigned NOT NULL COMMENT '运动时长(分钟)',
  `intensity` enum('low','medium','high') NOT NULL COMMENT '运动强度',
  `calories_burned` decimal(8,2) DEFAULT NULL COMMENT '消耗卡路里',
  `distance` decimal(8,2) DEFAULT NULL COMMENT '距离(km)',
  `steps` int unsigned DEFAULT NULL COMMENT '步数',
  `heart_rate_avg` int unsigned DEFAULT NULL COMMENT '平均心率',
  `heart_rate_max` int unsigned DEFAULT NULL COMMENT '最大心率',
  `heart_rate_min` int unsigned DEFAULT NULL COMMENT '最小心率',
  `photo_url` varchar(500) DEFAULT NULL COMMENT '照片URL',
  `record_date` date NOT NULL COMMENT '记录日期',
  `record_time` datetime NOT NULL COMMENT '记录时间',
  `record_type` enum('manual','photo','auto') DEFAULT 'manual' COMMENT '记录类型',
  `device_info` json DEFAULT NULL COMMENT '设备信息',
  `location` json DEFAULT NULL COMMENT '位置信息',
  `note` text DEFAULT NULL COMMENT '备注',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_record_date` (`user_id`, `record_date`),
  KEY `idx_user_id_exercise_type` (`user_id`, `exercise_type`),
  KEY `idx_exercise_type` (`exercise_type`),
  KEY `idx_intensity` (`intensity`),
  KEY `idx_record_type` (`record_type`),
  CONSTRAINT `fk_exercise_records_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='运动记录表';
```

#### 2.1.2 外键约束缺失
**问题描述**：部分表缺少必要的外键约束
**影响**：数据完整性无法保证

**具体问题**：
1. **AI方案表**：缺少对`reviewed_by`字段的外键约束
2. **审核记录表**：缺少对`plan_id`、`user_id`、`advisor_id`的外键约束
3. **支付记录表**：缺少对`related_id`的外键约束

**修复建议**：
```sql
-- 添加缺失的外键约束
ALTER TABLE `ai_plans` ADD CONSTRAINT `fk_ai_plans_reviewed_by` 
FOREIGN KEY (`reviewed_by`) REFERENCES `advisors` (`id`) ON DELETE SET NULL;

ALTER TABLE `review_records` ADD CONSTRAINT `fk_review_records_plan_id` 
FOREIGN KEY (`plan_id`) REFERENCES `ai_plans` (`id`) ON DELETE CASCADE;

ALTER TABLE `review_records` ADD CONSTRAINT `fk_review_records_user_id` 
FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE;

ALTER TABLE `review_records` ADD CONSTRAINT `fk_review_records_advisor_id` 
FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE CASCADE;
```

#### 2.1.3 数据验证规则不完整
**问题描述**：缺少关键的数据验证规则
**影响**：数据质量无法保证

**具体问题**：
1. **BMI计算**：缺少自动计算BMI的触发器
2. **年龄验证**：缺少年龄范围验证
3. **体重验证**：缺少体重合理性验证
4. **费用验证**：缺少费用范围验证

**修复建议**：
```sql
-- 添加数据验证约束
ALTER TABLE `users` ADD CONSTRAINT `chk_age_range` CHECK (`age` >= 18 AND `age` <= 100);
ALTER TABLE `users` ADD CONSTRAINT `chk_weight_range` CHECK (`current_weight` >= 30 AND `current_weight` <= 300);
ALTER TABLE `users` ADD CONSTRAINT `chk_height_range` CHECK (`height` >= 100 AND `height` <= 250);

ALTER TABLE `advisors` ADD CONSTRAINT `chk_consultation_fee` CHECK (`consultation_fee` >= 0 AND `consultation_fee` <= 100000);
ALTER TABLE `advisors` ADD CONSTRAINT `chk_rating_range` CHECK (`rating` >= 1 AND `rating` <= 5);

-- BMI自动计算触发器
DELIMITER $$
CREATE TRIGGER `tr_users_bmi_calc_insert` 
BEFORE INSERT ON `users` 
FOR EACH ROW 
BEGIN
    IF NEW.current_weight IS NOT NULL AND NEW.height IS NOT NULL THEN
        SET NEW.bmi = NEW.current_weight / POWER(NEW.height / 100, 2);
    END IF;
END$$

CREATE TRIGGER `tr_users_bmi_calc_update` 
BEFORE UPDATE ON `users` 
FOR EACH ROW 
BEGIN
    IF NEW.current_weight IS NOT NULL AND NEW.height IS NOT NULL THEN
        SET NEW.bmi = NEW.current_weight / POWER(NEW.height / 100, 2);
    END IF;
END$$
DELIMITER ;
```

### 2.2 重要问题（Important Issues）

#### 2.2.1 索引设计不优化
**问题描述**：部分索引设计不合理，影响查询性能
**影响**：系统性能下降

**具体问题**：
1. **复合索引顺序**：部分复合索引字段顺序不合理
2. **覆盖索引缺失**：常用查询缺少覆盖索引
3. **全文索引缺失**：搜索功能缺少全文索引

**修复建议**：
```sql
-- 优化复合索引
ALTER TABLE `weight_records` DROP KEY `idx_user_id_record_date`;
ALTER TABLE `weight_records` ADD KEY `idx_user_id_record_date` (`user_id`, `record_date` DESC);

ALTER TABLE `diet_records` DROP KEY `idx_user_id_meal_type_record_date`;
ALTER TABLE `diet_records` ADD KEY `idx_user_id_meal_type_record_date` (`user_id`, `meal_type`, `record_date` DESC);

-- 添加全文索引
ALTER TABLE `food_database` ADD FULLTEXT INDEX `ft_food_name_keywords` (`food_name`, `search_keywords`);
ALTER TABLE `exercise_database` ADD FULLTEXT INDEX `ft_exercise_name_keywords` (`exercise_name`, `search_keywords`);

-- 添加覆盖索引
ALTER TABLE `users` ADD KEY `idx_user_basic_info` (`id`, `nickname`, `current_weight`, `bmi`, `status`);
ALTER TABLE `weight_records` ADD KEY `idx_weight_trend` (`user_id`, `record_date`, `weight`, `bmi`);
```

#### 2.2.2 分表策略不完整
**问题描述**：分表策略只提供了函数，缺少实际的分表实现
**影响**：大数据量时性能问题

**修复建议**：
```sql
-- 创建分表存储过程
DELIMITER $$
CREATE PROCEDURE CreateMonthlyTable(IN baseTableName VARCHAR(50), IN targetDate DATE)
BEGIN
    DECLARE yearStr VARCHAR(4);
    DECLARE monthStr VARCHAR(2);
    DECLARE tableName VARCHAR(100);
    DECLARE sqlStatement TEXT;
    
    SET yearStr = YEAR(targetDate);
    SET monthStr = LPAD(MONTH(targetDate), 2, '0');
    SET tableName = CONCAT(baseTableName, '_', yearStr, monthStr);
    
    SET sqlStatement = CONCAT('CREATE TABLE IF NOT EXISTS `', tableName, '` LIKE `', baseTableName, '`');
    SET @sql = sqlStatement;
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
    SELECT CONCAT('Table ', tableName, ' created successfully') AS result;
END$$
DELIMITER ;

-- 使用示例
CALL CreateMonthlyTable('weight_records', CURDATE());
```

#### 2.2.3 数据安全设计不完善
**问题描述**：缺少关键的安全措施
**影响**：数据安全风险

**具体问题**：
1. **加密字段标识**：缺少加密字段的明确标识
2. **审计日志**：缺少完整的审计日志表
3. **数据脱敏**：缺少数据脱敏的存储过程

**修复建议**：
```sql
-- 添加加密字段标识
ALTER TABLE `users` MODIFY COLUMN `real_name` varchar(100) DEFAULT NULL COMMENT '真实姓名（AES-256加密）';
ALTER TABLE `users` MODIFY COLUMN `phone` varchar(20) DEFAULT NULL COMMENT '手机号（AES-256加密）';
ALTER TABLE `advisors` MODIFY COLUMN `phone` varchar(20) NOT NULL COMMENT '手机号（AES-256加密）';
ALTER TABLE `advisors` MODIFY COLUMN `id_card` varchar(20) DEFAULT NULL COMMENT '身份证号（AES-256加密）';

-- 创建数据脱敏视图
CREATE VIEW `users_desensitized` AS
SELECT 
    id,
    openid,
    CONCAT(LEFT(nickname, 1), '***', RIGHT(nickname, 1)) as nickname,
    CONCAT(LEFT(phone, 3), '****', RIGHT(phone, 4)) as phone,
    CONCAT(LEFT(email, 1), '***@', SUBSTRING_INDEX(email, '@', -1)) as email,
    gender,
    age,
    height,
    current_weight,
    target_weight,
    bmi,
    member_level,
    status,
    created_at,
    updated_at
FROM users;

-- 创建审计日志表
CREATE TABLE `audit_logs` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '审计日志ID（主键）',
  `user_id` bigint unsigned DEFAULT NULL COMMENT '操作用户ID',
  `advisor_id` bigint unsigned DEFAULT NULL COMMENT '健康顾问ID',
  `action` varchar(50) NOT NULL COMMENT '操作类型',
  `resource_type` varchar(50) NOT NULL COMMENT '资源类型',
  `resource_id` bigint unsigned NOT NULL COMMENT '资源ID',
  `old_value` json DEFAULT NULL COMMENT '修改前值',
  `new_value` json DEFAULT NULL COMMENT '修改后值',
  `changed_fields` json DEFAULT NULL COMMENT '变更字段',
  `ip_address` varchar(45) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` text DEFAULT NULL COMMENT '用户代理',
  `session_id` varchar(100) DEFAULT NULL COMMENT '会话ID',
  `request_id` varchar(100) DEFAULT NULL COMMENT '请求ID',
  `execution_time` int unsigned DEFAULT NULL COMMENT '执行时间(ms)',
  `status` enum('success','failed') DEFAULT 'success' COMMENT '操作状态',
  `error_message` text DEFAULT NULL COMMENT '错误信息',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_created_at` (`user_id`, `created_at`),
  KEY `idx_advisor_id_created_at` (`advisor_id`, `created_at`),
  KEY `idx_resource_type_id` (`resource_type`, `resource_id`),
  KEY `idx_action` (`action`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_audit_logs_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_audit_logs_advisor_id` FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='审计日志表';
```

### 2.3 一般问题（Minor Issues）

#### 2.3.1 字段类型不精确
**问题描述**：部分字段类型选择不够精确
**影响**：存储空间浪费或数据精度问题

**具体问题**：
1. **金额字段**：使用`int`存储分，建议使用`decimal(10,2)`存储元
2. **时间字段**：部分使用`datetime`，建议统一使用`timestamp`
3. **状态字段**：部分使用`varchar`，建议使用`enum`

**修复建议**：
```sql
-- 优化金额字段
ALTER TABLE `payment_records` MODIFY COLUMN `amount` decimal(10,2) NOT NULL COMMENT '支付金额(元)';
ALTER TABLE `payment_records` MODIFY COLUMN `refund_amount` decimal(10,2) DEFAULT 0.00 COMMENT '退款金额(元)';

ALTER TABLE `advisors` MODIFY COLUMN `consultation_fee` decimal(10,2) DEFAULT 0.00 COMMENT '咨询费用(元)';
ALTER TABLE `advisors` MODIFY COLUMN `total_income` decimal(12,2) DEFAULT 0.00 COMMENT '总收入(元)';
ALTER TABLE `advisors` MODIFY COLUMN `monthly_income` decimal(12,2) DEFAULT 0.00 COMMENT '月收入(元)';

-- 统一时间字段
ALTER TABLE `users` MODIFY COLUMN `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间';
ALTER TABLE `users` MODIFY COLUMN `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间';
```

#### 2.3.2 注释不完整
**问题描述**：部分字段缺少详细注释
**影响**：维护困难

**修复建议**：
```sql
-- 补充字段注释
ALTER TABLE `users` MODIFY COLUMN `health_goals` json DEFAULT NULL COMMENT '健康目标数组，如["减重","增肌","保持健康"]';
ALTER TABLE `users` MODIFY COLUMN `medical_history` json DEFAULT NULL COMMENT '病史数组，如["高血压","糖尿病"]';
ALTER TABLE `users` MODIFY COLUMN `dietary_restrictions` json DEFAULT NULL COMMENT '饮食限制，如["素食","无麸质"]';
ALTER TABLE `users` MODIFY COLUMN `allergies` json DEFAULT NULL COMMENT '过敏信息，如["花生","海鲜"]';

ALTER TABLE `advisors` MODIFY COLUMN `specialty` json DEFAULT NULL COMMENT '专业领域数组，如["减重","增肌","营养咨询"]';
ALTER TABLE `advisors` MODIFY COLUMN `specialization` json DEFAULT NULL COMMENT '专业特长，如["糖尿病管理","运动康复"]';
```

---

## 3. 功能遗漏分析

### 3.1 核心功能遗漏

#### 3.1.1 会员管理功能
**PRD要求**：完整的会员等级管理
**当前状态**：缺少会员等级变更记录表

**建议添加**：
```sql
CREATE TABLE `membership_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '会员记录ID（主键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `old_level` enum('free','standard','premium') DEFAULT NULL COMMENT '原会员等级',
  `new_level` enum('free','standard','premium') NOT NULL COMMENT '新会员等级',
  `change_type` enum('upgrade','downgrade','renewal','expire') NOT NULL COMMENT '变更类型',
  `payment_id` bigint unsigned DEFAULT NULL COMMENT '支付记录ID',
  `amount` decimal(10,2) DEFAULT NULL COMMENT '变更金额(元)',
  `effective_date` datetime NOT NULL COMMENT '生效时间',
  `expire_date` datetime DEFAULT NULL COMMENT '到期时间',
  `reason` varchar(200) DEFAULT NULL COMMENT '变更原因',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_created_at` (`user_id`, `created_at`),
  KEY `idx_change_type` (`change_type`),
  KEY `idx_effective_date` (`effective_date`),
  CONSTRAINT `fk_membership_records_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_membership_records_payment_id` FOREIGN KEY (`payment_id`) REFERENCES `payment_records` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='会员变更记录表';
```

#### 3.1.2 健康顾问收入管理
**PRD要求**：完整的收入统计和提现管理
**当前状态**：缺少收入明细和提现记录表

**建议添加**：
```sql
CREATE TABLE `advisor_income_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '收入记录ID（主键）',
  `advisor_id` bigint unsigned NOT NULL COMMENT '健康顾问ID（外键）',
  `income_type` enum('review_fee','membership_share','service_fee','bonus') NOT NULL COMMENT '收入类型',
  `amount` decimal(10,2) NOT NULL COMMENT '收入金额(元)',
  `related_id` bigint unsigned DEFAULT NULL COMMENT '关联记录ID',
  `related_type` varchar(50) DEFAULT NULL COMMENT '关联记录类型',
  `description` varchar(200) DEFAULT NULL COMMENT '收入描述',
  `status` enum('pending','confirmed','cancelled') DEFAULT 'pending' COMMENT '状态',
  `confirmed_at` datetime DEFAULT NULL COMMENT '确认时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_advisor_id_created_at` (`advisor_id`, `created_at`),
  KEY `idx_income_type` (`income_type`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_advisor_income_records_advisor_id` FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='健康顾问收入记录表';

CREATE TABLE `withdrawal_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '提现记录ID（主键）',
  `advisor_id` bigint unsigned NOT NULL COMMENT '健康顾问ID（外键）',
  `amount` decimal(10,2) NOT NULL COMMENT '提现金额(元)',
  `fee` decimal(10,2) DEFAULT 0.00 COMMENT '手续费(元)',
  `actual_amount` decimal(10,2) NOT NULL COMMENT '实际到账金额(元)',
  `bank_info` json DEFAULT NULL COMMENT '银行信息',
  `status` enum('pending','processing','success','failed') DEFAULT 'pending' COMMENT '提现状态',
  `transaction_id` varchar(100) DEFAULT NULL COMMENT '银行交易ID',
  `fail_reason` varchar(200) DEFAULT NULL COMMENT '失败原因',
  `processed_at` datetime DEFAULT NULL COMMENT '处理时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_advisor_id_created_at` (`advisor_id`, `created_at`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_withdrawal_records_advisor_id` FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='提现记录表';
```

#### 3.1.3 系统通知管理
**PRD要求**：完整的通知系统
**当前状态**：缺少通知模板和发送记录表

**建议添加**：
```sql
CREATE TABLE `notification_templates` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '模板ID（主键）',
  `template_code` varchar(50) NOT NULL COMMENT '模板代码',
  `template_name` varchar(100) NOT NULL COMMENT '模板名称',
  `template_type` enum('system','reminder','achievement','alert') NOT NULL COMMENT '模板类型',
  `title_template` varchar(200) NOT NULL COMMENT '标题模板',
  `content_template` text NOT NULL COMMENT '内容模板',
  `variables` json DEFAULT NULL COMMENT '变量定义',
  `is_active` tinyint(1) DEFAULT 1 COMMENT '是否启用',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_template_code` (`template_code`),
  KEY `idx_template_type` (`template_type`),
  KEY `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='通知模板表';

CREATE TABLE `notification_send_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '发送记录ID（主键）',
  `notification_id` bigint unsigned NOT NULL COMMENT '通知ID（外键）',
  `template_id` bigint unsigned DEFAULT NULL COMMENT '模板ID（外键）',
  `send_type` enum('push','sms','email','wechat') NOT NULL COMMENT '发送类型',
  `send_status` enum('pending','sent','failed') DEFAULT 'pending' COMMENT '发送状态',
  `send_result` json DEFAULT NULL COMMENT '发送结果',
  `retry_count` tinyint unsigned DEFAULT 0 COMMENT '重试次数',
  `next_retry_time` datetime DEFAULT NULL COMMENT '下次重试时间',
  `sent_at` datetime DEFAULT NULL COMMENT '发送时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_notification_id` (`notification_id`),
  KEY `idx_send_status` (`send_status`),
  KEY `idx_sent_at` (`sent_at`),
  CONSTRAINT `fk_notification_send_records_notification_id` FOREIGN KEY (`notification_id`) REFERENCES `notifications` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_notification_send_records_template_id` FOREIGN KEY (`template_id`) REFERENCES `notification_templates` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='通知发送记录表';
```

### 3.2 辅助功能遗漏

#### 3.2.1 数据导出功能
**PRD要求**：支持数据导出
**当前状态**：缺少导出记录表

**建议添加**：
```sql
CREATE TABLE `data_export_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '导出记录ID（主键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `export_type` enum('weight_records','diet_records','exercise_records','all_data') NOT NULL COMMENT '导出类型',
  `file_format` enum('json','csv','pdf') NOT NULL COMMENT '文件格式',
  `file_url` varchar(500) DEFAULT NULL COMMENT '文件下载URL',
  `file_size` bigint unsigned DEFAULT NULL COMMENT '文件大小(字节)',
  `status` enum('pending','processing','completed','failed') DEFAULT 'pending' COMMENT '导出状态',
  `error_message` text DEFAULT NULL COMMENT '错误信息',
  `expire_at` datetime DEFAULT NULL COMMENT '文件过期时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `completed_at` datetime DEFAULT NULL COMMENT '完成时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_created_at` (`user_id`, `created_at`),
  KEY `idx_status` (`status`),
  KEY `idx_expire_at` (`expire_at`),
  CONSTRAINT `fk_data_export_records_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='数据导出记录表';
```

#### 3.2.2 系统配置管理
**PRD要求**：灵活的系统配置
**当前状态**：系统配置表设计不完整

**建议优化**：
```sql
-- 优化系统配置表
ALTER TABLE `system_configs` ADD COLUMN `version` int unsigned DEFAULT 1 COMMENT '配置版本';
ALTER TABLE `system_configs` ADD COLUMN `created_by` varchar(50) DEFAULT NULL COMMENT '创建人';
ALTER TABLE `system_configs` ADD COLUMN `updated_by` varchar(50) DEFAULT NULL COMMENT '更新人';
ALTER TABLE `system_configs` ADD COLUMN `effective_date` datetime DEFAULT NULL COMMENT '生效时间';
ALTER TABLE `system_configs` ADD COLUMN `expire_date` datetime DEFAULT NULL COMMENT '过期时间';

-- 添加配置历史表
CREATE TABLE `system_config_history` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '历史记录ID（主键）',
  `config_id` bigint unsigned NOT NULL COMMENT '配置ID（外键）',
  `old_value` json DEFAULT NULL COMMENT '原配置值',
  `new_value` json DEFAULT NULL COMMENT '新配置值',
  `change_reason` varchar(200) DEFAULT NULL COMMENT '变更原因',
  `changed_by` varchar(50) NOT NULL COMMENT '变更人',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_config_id_created_at` (`config_id`, `created_at`),
  KEY `idx_changed_by` (`changed_by`),
  CONSTRAINT `fk_system_config_history_config_id` FOREIGN KEY (`config_id`) REFERENCES `system_configs` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统配置历史表';
```

---

## 4. 性能优化建议

### 4.1 查询优化

#### 4.1.1 添加复合索引
```sql
-- 用户查询优化
ALTER TABLE `users` ADD KEY `idx_status_member_level` (`status`, `member_level`);
ALTER TABLE `users` ADD KEY `idx_advisor_status` (`advisor_id`, `status`);

-- 记录查询优化
ALTER TABLE `weight_records` ADD KEY `idx_user_weight_date` (`user_id`, `weight`, `record_date`);
ALTER TABLE `diet_records` ADD KEY `idx_user_calories_date` (`user_id`, `calories`, `record_date`);
ALTER TABLE `exercise_records` ADD KEY `idx_user_duration_date` (`user_id`, `duration`, `record_date`);

-- 方案查询优化
ALTER TABLE `ai_plans` ADD KEY `idx_user_status_created` (`user_id`, `status`, `created_at`);
ALTER TABLE `ai_plans` ADD KEY `idx_advisor_status_created` (`advisor_id`, `status`, `created_at`);
```

#### 4.1.2 创建视图优化
```sql
-- 用户统计视图
CREATE VIEW `user_daily_stats` AS
SELECT 
    u.id as user_id,
    u.nickname,
    u.current_weight,
    u.bmi,
    COUNT(wr.id) as weight_records_count,
    COUNT(dr.id) as diet_records_count,
    COUNT(er.id) as exercise_records_count,
    SUM(dr.calories) as total_calories,
    SUM(er.calories_burned) as total_calories_burned
FROM users u
LEFT JOIN weight_records wr ON u.id = wr.user_id AND DATE(wr.record_date) = CURDATE()
LEFT JOIN diet_records dr ON u.id = dr.user_id AND DATE(dr.record_date) = CURDATE()
LEFT JOIN exercise_records er ON u.id = er.user_id AND DATE(er.record_date) = CURDATE()
GROUP BY u.id;

-- 健康顾问统计视图
CREATE VIEW `advisor_stats` AS
SELECT 
    a.id as advisor_id,
    a.name,
    a.rating,
    COUNT(DISTINCT u.id) as patient_count,
    COUNT(ap.id) as plan_count,
    COUNT(CASE WHEN ap.status = 'approved' THEN 1 END) as approved_plans,
    AVG(CASE WHEN ap.status = 'approved' THEN ap.review_fee END) as avg_review_fee
FROM advisors a
LEFT JOIN users u ON a.id = u.advisor_id AND u.status = 'active'
LEFT JOIN ai_plans ap ON a.id = ap.advisor_id
GROUP BY a.id;
```

### 4.2 存储优化

#### 4.2.1 分区表设计
```sql
-- 体重记录分区表
CREATE TABLE `weight_records_partitioned` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '记录ID（主键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `weight` decimal(5,2) NOT NULL COMMENT '体重(kg)',
  `bmi` decimal(4,2) DEFAULT NULL COMMENT 'BMI指数',
  `record_date` date NOT NULL COMMENT '记录日期',
  `record_time` datetime NOT NULL COMMENT '记录时间',
  `record_type` enum('manual','photo','auto') DEFAULT 'manual' COMMENT '记录类型',
  `photo_url` varchar(500) DEFAULT NULL COMMENT '照片URL',
  `note` text DEFAULT NULL COMMENT '备注',
  `device_info` json DEFAULT NULL COMMENT '设备信息',
  `location` json DEFAULT NULL COMMENT '位置信息',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`, `record_date`),
  KEY `idx_user_id_record_date` (`user_id`, `record_date`),
  KEY `idx_user_id_created_at` (`user_id`, `created_at`),
  KEY `idx_record_type` (`record_type`),
  KEY `idx_record_date` (`record_date`),
  CONSTRAINT `fk_weight_records_partitioned_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci 
PARTITION BY RANGE (YEAR(record_date)) (
    PARTITION p2024 VALUES LESS THAN (2025),
PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p_future VALUES LESS THAN MAXVALUE
) COMMENT='体重记录分区表';
```

#### 4.2.2 归档策略
```sql
-- 创建归档表
CREATE TABLE `weight_records_archive` (
  `id` bigint unsigned NOT NULL COMMENT '记录ID',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID',
  `weight` decimal(5,2) NOT NULL COMMENT '体重(kg)',
  `bmi` decimal(4,2) DEFAULT NULL COMMENT 'BMI指数',
  `record_date` date NOT NULL COMMENT '记录日期',
  `record_time` datetime NOT NULL COMMENT '记录时间',
  `record_type` enum('manual','photo','auto') DEFAULT 'manual' COMMENT '记录类型',
  `photo_url` varchar(500) DEFAULT NULL COMMENT '照片URL',
  `note` text DEFAULT NULL COMMENT '备注',
  `device_info` json DEFAULT NULL COMMENT '设备信息',
  `location` json DEFAULT NULL COMMENT '位置信息',
  `created_at` datetime NOT NULL COMMENT '创建时间',
  `updated_at` datetime NOT NULL COMMENT '更新时间',
  `archived_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '归档时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_record_date` (`user_id`, `record_date`),
  KEY `idx_archived_at` (`archived_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='体重记录归档表';

-- 归档存储过程
DELIMITER $$
CREATE PROCEDURE ArchiveOldRecords(IN monthsOld INT)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE batch_size INT DEFAULT 1000;
    DECLARE affected_rows INT DEFAULT 0;
    
    REPEAT
        INSERT INTO weight_records_archive 
        SELECT *, NOW() as archived_at
        FROM weight_records 
        WHERE record_date < DATE_SUB(CURDATE(), INTERVAL monthsOld MONTH)
        LIMIT batch_size;
        
        SET affected_rows = ROW_COUNT();
        
        IF affected_rows > 0 THEN
            DELETE FROM weight_records 
            WHERE id IN (
                SELECT id FROM weight_records_archive 
                WHERE archived_at = NOW()
            );
        END IF;
        
    UNTIL affected_rows = 0 END REPEAT;
    
    SELECT CONCAT('Archived ', (SELECT COUNT(*) FROM weight_records_archive WHERE archived_at = NOW()), ' records') AS result;
END$$
DELIMITER ;
```

---

## 5. 安全加固建议

### 5.1 数据加密

#### 5.1.1 敏感字段加密
```sql
-- 创建加密函数
DELIMITER $$
CREATE FUNCTION encrypt_sensitive_data(data VARCHAR(255), key_str VARCHAR(32))
RETURNS VARCHAR(255)
DETERMINISTIC
BEGIN
    -- 这里应该使用实际的加密算法
    -- 示例使用简单的异或加密（实际应用中应使用AES等）
    RETURN CONCAT('ENCRYPTED:', HEX(data));
END$$

CREATE FUNCTION decrypt_sensitive_data(encrypted_data VARCHAR(255), key_str VARCHAR(32))
RETURNS VARCHAR(255)
DETERMINISTIC
BEGIN
    -- 解密逻辑
    IF encrypted_data LIKE 'ENCRYPTED:%' THEN
        RETURN UNHEX(SUBSTRING(encrypted_data, 10));
    ELSE
        RETURN encrypted_data;
    END IF;
END$$
DELIMITER ;

-- 创建加密触发器
DELIMITER $$
CREATE TRIGGER `tr_users_encrypt_insert` 
BEFORE INSERT ON `users` 
FOR EACH ROW 
BEGIN
    IF NEW.real_name IS NOT NULL THEN
        SET NEW.real_name = encrypt_sensitive_data(NEW.real_name, 'encryption_key');
    END IF;
    IF NEW.phone IS NOT NULL THEN
        SET NEW.phone = encrypt_sensitive_data(NEW.phone, 'encryption_key');
    END IF;
END$$

CREATE TRIGGER `tr_users_encrypt_update` 
BEFORE UPDATE ON `users` 
FOR EACH ROW 
BEGIN
    IF NEW.real_name IS NOT NULL AND NEW.real_name != OLD.real_name THEN
        SET NEW.real_name = encrypt_sensitive_data(NEW.real_name, 'encryption_key');
    END IF;
    IF NEW.phone IS NOT NULL AND NEW.phone != OLD.phone THEN
        SET NEW.phone = encrypt_sensitive_data(NEW.phone, 'encryption_key');
    END IF;
END$$
DELIMITER ;
```

#### 5.1.2 数据脱敏视图
```sql
-- 创建脱敏视图
CREATE VIEW `users_desensitized_view` AS
SELECT 
    id,
    openid,
    CONCAT(LEFT(nickname, 1), '***', RIGHT(nickname, 1)) as nickname,
    CONCAT(LEFT(phone, 3), '****', RIGHT(phone, 4)) as phone,
    CONCAT(LEFT(email, 1), '***@', SUBSTRING_INDEX(email, '@', -1)) as email,
    gender,
    age,
    height,
    current_weight,
    target_weight,
    bmi,
    member_level,
    status,
    created_at,
    updated_at
FROM users;

-- 健康顾问脱敏视图
CREATE VIEW `advisors_desensitized_view` AS
SELECT 
    id,
    name,
    avatar,
    CONCAT(LEFT(phone, 3), '****', RIGHT(phone, 4)) as phone,
    CONCAT(LEFT(email, 1), '***@', SUBSTRING_INDEX(email, '@', -1)) as email,
    CONCAT(LEFT(id_card, 6), '********', RIGHT(id_card, 4)) as id_card,
    specialty,
    qualification,
    hospital,
    description,
    experience_years,
    consultation_fee,
    user_count,
    rating,
    total_income,
    monthly_income,
    status,
    verification_status,
    is_online,
    created_at,
    updated_at
FROM advisors;
```

### 5.2 访问控制

#### 5.2.1 行级安全
```sql
-- 创建用户数据访问控制函数
DELIMITER $$
CREATE FUNCTION check_user_access(user_id BIGINT, target_user_id BIGINT, user_type ENUM('user', 'advisor', 'admin'))
RETURNS BOOLEAN
DETERMINISTIC
BEGIN
    DECLARE result BOOLEAN DEFAULT FALSE;
    
    CASE user_type
        WHEN 'user' THEN
            SET result = (user_id = target_user_id);
        WHEN 'advisor' THEN
            SET result = EXISTS(
                SELECT 1 FROM users 
                WHERE id = target_user_id AND advisor_id = user_id
            );
        WHEN 'admin' THEN
            SET result = TRUE;
    END CASE;
    
    RETURN result;
END$$
DELIMITER ;

-- 创建安全查询视图
CREATE VIEW `secure_user_data` AS
SELECT 
    u.*,
    check_user_access(@current_user_id, u.id, @current_user_type) as has_access
FROM users u;
```

#### 5.2.2 审计日志
```sql
-- 创建审计日志触发器
DELIMITER $$
CREATE TRIGGER `tr_users_audit_insert` 
AFTER INSERT ON `users` 
FOR EACH ROW 
BEGIN
    INSERT INTO audit_logs (
        user_id, action, resource_type, resource_id, 
        new_value, ip_address, user_agent
    ) VALUES (
        @current_user_id, 'create', 'user', NEW.id,
        JSON_OBJECT('nickname', NEW.nickname, 'member_level', NEW.member_level),
        @current_ip_address, @current_user_agent
    );
END$$

CREATE TRIGGER `tr_users_audit_update` 
AFTER UPDATE ON `users` 
FOR EACH ROW 
BEGIN
    INSERT INTO audit_logs (
        user_id, action, resource_type, resource_id,
        old_value, new_value, changed_fields, ip_address, user_agent
    ) VALUES (
        @current_user_id, 'update', 'user', NEW.id,
        JSON_OBJECT('nickname', OLD.nickname, 'member_level', OLD.member_level),
        JSON_OBJECT('nickname', NEW.nickname, 'member_level', NEW.member_level),
        JSON_ARRAY('nickname', 'member_level'),
        @current_ip_address, @current_user_agent
    );
END$$
DELIMITER ;
```

---

## 6. 实施建议

### 6.1 优先级排序

#### 6.1.1 立即修复（P0）
1. **完成MongoDB到MySQL的转换**
   - 转换所有仍使用MongoDB格式的表
   - 添加缺失的外键约束
   - 完善数据验证规则

2. **修复数据一致性问题**
   - 添加必要的CHECK约束
   - 完善触发器逻辑
   - 统一字段类型

#### 6.1.2 短期修复（P1）
1. **优化索引设计**
   - 重新设计复合索引
   - 添加全文索引
   - 创建覆盖索引

2. **完善安全措施**
   - 实现数据加密
   - 添加审计日志
   - 创建脱敏视图

#### 6.1.3 中期优化（P2）
1. **实现分表策略**
   - 创建分表存储过程
   - 实现数据归档
   - 优化查询性能

2. **添加缺失功能**
   - 会员管理功能
   - 收入管理功能
   - 通知管理功能

### 6.2 实施步骤

#### 6.2.1 第一阶段（1-2周）
1. 修复所有MongoDB格式的表
2. 添加缺失的外键约束
3. 完善数据验证规则
4. 创建基础索引

#### 6.2.2 第二阶段（2-3周）
1. 优化索引设计
2. 实现数据加密
3. 添加审计日志
4. 创建脱敏视图

#### 6.2.3 第三阶段（3-4周）
1. 实现分表策略
2. 添加缺失功能表
3. 性能测试和优化
4. 安全测试和加固

### 6.3 风险评估

#### 6.3.1 技术风险
- **数据迁移风险**：建议先在测试环境验证
- **性能影响**：分阶段实施，监控性能指标
- **兼容性风险**：确保应用层代码适配

#### 6.3.2 业务风险
- **服务中断风险**：选择低峰期实施
- **数据丢失风险**：充分备份，回滚方案
- **用户体验影响**：渐进式实施，及时反馈

---

## 7. 总结

### 7.1 主要发现
1. **严重问题**：8个表仍使用MongoDB格式，需要立即转换
2. **重要问题**：索引设计不优化，安全措施不完善
3. **功能遗漏**：缺少会员管理、收入管理等核心功能表

### 7.2 改进建议
1. **立即行动**：完成MongoDB到MySQL的完全转换
2. **安全加固**：实现数据加密和审计日志
3. **性能优化**：重新设计索引和分表策略
4. **功能完善**：添加缺失的业务功能表

### 7.3 预期效果
1. **数据一致性**：通过外键约束和验证规则保证
2. **查询性能**：通过优化索引提升50%以上
3. **安全性**：通过加密和审计提升安全等级
4. **可维护性**：通过完善的注释和文档提升

这份审查报告为数据库设计提供了全面的改进方向，建议按照优先级逐步实施，确保系统的稳定性、安全性和性能。
