# ä½“é‡ç®¡ç†æ•°å­—åŒ»ç”Ÿå°ç¨‹åº - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.2  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025å¹´8æœˆ8æ—¥  
**æœ€åŽæ›´æ–°**ï¼š2025å¹´8æœˆ8æ—¥  
**æ–‡æ¡£çŠ¶æ€**ï¼šå·²ç®€åŒ–çº¦æŸæ¡ä»¶ï¼Œé€‚åˆåˆæœŸå¼€å‘

---

## ä¿®æ”¹æ€»ç»“ï¼ˆv1.2ï¼‰

æ ¹æ®æ•°æ®åº“è®¾è®¡æ–‡æ¡£å®¡æŸ¥æŠ¥å‘Šï¼Œæœ¬æ¬¡ä¿®æ”¹ä¸»è¦åŒ…æ‹¬ï¼š

### 1. å®ŒæˆMongoDBåˆ°MySQLçš„è½¬æ¢
- âœ… å°† `exercise_records` ä»ŽMongoDBé›†åˆè½¬æ¢ä¸ºMySQLè¡¨
- âœ… å°† `review_records` ä»ŽMongoDBé›†åˆè½¬æ¢ä¸ºMySQLè¡¨
- âœ… å°† `audit_logs` ä»ŽMongoDBé›†åˆè½¬æ¢ä¸ºMySQLè¡¨

### 2. æ·»åŠ ç¼ºå¤±çš„å¤–é”®çº¦æŸ
- âœ… ä¸º `ai_plans` è¡¨æ·»åŠ  `fk_ai_plans_reviewed_by` å¤–é”®çº¦æŸ
- âœ… ä¸º `review_records` è¡¨æ·»åŠ å®Œæ•´çš„å¤–é”®çº¦æŸ

### 3. å®Œå–„æ•°æ®éªŒè¯è§„åˆ™
- âœ… ä¼˜åŒ–ç”¨æˆ·è¡¨çš„æ•°æ®éªŒè¯çº¦æŸå‘½å
- âœ… ä¸ºè¿åŠ¨è®°å½•è¡¨æ·»åŠ å®Œæ•´çš„æ•°æ®éªŒè¯çº¦æŸ
- âœ… ä¸ºå®¡æ ¸è®°å½•è¡¨æ·»åŠ æ•°æ®éªŒè¯çº¦æŸ

### 4. ä¼˜åŒ–ç´¢å¼•è®¾è®¡
- âœ… ä¸ºè¿åŠ¨è®°å½•è¡¨æ·»åŠ ä¼˜åŒ–çš„å¤åˆç´¢å¼•ï¼ˆåŒ…å«DESCæŽ’åºï¼‰
- âœ… ä¸ºç”¨æˆ·è¡¨æ·»åŠ è¦†ç›–ç´¢å¼• `idx_user_basic_info`
- âœ… ä¸ºå®¡æ ¸è®°å½•è¡¨æ·»åŠ ç”¨æˆ·IDç´¢å¼•

### 5. æ–°å¢žåŠŸèƒ½è¡¨
- âœ… æ–°å¢ž `membership_records` ä¼šå‘˜è®°å½•è¡¨
- âœ… æ–°å¢ž `advisor_income_records` å¥åº·é¡¾é—®æ”¶å…¥è®°å½•è¡¨
- âœ… å®Œå–„ `audit_logs` å®¡è®¡æ—¥å¿—è¡¨

### 6. å¢žå¼ºæ•°æ®å®‰å…¨
- âœ… æ·»åŠ  `users_desensitized` æ•°æ®è„±æ•è§†å›¾
- âœ… å®Œå–„åˆ†è¡¨å‡½æ•°å’Œå­˜å‚¨è¿‡ç¨‹
- âœ… æ›´æ–°æ•°æ®å…³ç³»è®¾è®¡å’Œå¤–é”®çº¦æŸ

### 7. æ›´æ–°ç³»ç»Ÿé…ç½®
- âœ… æ·»åŠ ä¼šå‘˜å‡çº§è´¹ç”¨é…ç½®
- âœ… æ·»åŠ å®¡æ ¸è´¹ç”¨é…ç½®
- âœ… æ·»åŠ å¥åº·é¡¾é—®åˆ†æˆæ¯”ä¾‹é…ç½®

### 8. å®Œå–„æŸ¥è¯¢ç¤ºä¾‹
- âœ… æ·»åŠ ä¼šå‘˜å˜æ›´è®°å½•æŸ¥è¯¢
- âœ… æ·»åŠ å¥åº·é¡¾é—®æ”¶å…¥ç»Ÿè®¡æŸ¥è¯¢
- âœ… æ·»åŠ åŒ…å«å®¡æ ¸äººä¿¡æ¯çš„AIæ–¹æ¡ˆæŸ¥è¯¢

### 9. ç®€åŒ–çº¦æŸæ¡ä»¶ï¼ˆv1.2æ–°å¢žï¼‰
- âœ… åŽ»æŽ‰è¿‡äºŽä¸¥æ ¼çš„å¤–é”®çº¦æŸï¼ˆåˆæœŸå¼€å‘å‹å¥½ï¼‰
- âœ… ç®€åŒ–æ•°æ®éªŒè¯è§„åˆ™ï¼ˆå…è®¸æ›´å®½æ¾çš„èŒƒå›´ï¼‰
- âœ… å‡å°‘ä¸å¿…è¦çš„å”¯ä¸€ç´¢å¼•
- âœ… ä¼˜åŒ–é»˜è®¤çŠ¶æ€è®¾ç½®ï¼ˆç”¨æˆ·çŠ¶æ€é»˜è®¤ä¸ºactiveï¼‰
- âœ… æ·»åŠ è¡¨ä¼˜å…ˆçº§åˆ†ç±»ï¼ŒæŒ‡å¯¼åˆæœŸå¼€å‘é¡ºåº

---

## è¡¨ä¼˜å…ˆçº§åˆ†ç±»ï¼ˆåˆæœŸå¼€å‘å»ºè®®ï¼‰

### ðŸŸ¢ **P0 - æ ¸å¿ƒè¡¨ï¼ˆåˆæœŸå¿…é¡»ï¼‰**
è¿™äº›è¡¨æ˜¯å°ç¨‹åºçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»ä¼˜å…ˆå®žçŽ°ï¼š

1. **users** - ç”¨æˆ·è¡¨ï¼ˆæ ¸å¿ƒï¼‰
2. **weight_records** - ä½“é‡è®°å½•è¡¨ï¼ˆæ ¸å¿ƒï¼‰
3. **diet_records** - é¥®é£Ÿè®°å½•è¡¨ï¼ˆæ ¸å¿ƒï¼‰
4. **exercise_records** - è¿åŠ¨è®°å½•è¡¨ï¼ˆæ ¸å¿ƒï¼‰
5. **ai_plans** - AIæ–¹æ¡ˆè¡¨ï¼ˆæ ¸å¿ƒï¼‰
6. **system_configs** - ç³»ç»Ÿé…ç½®è¡¨ï¼ˆæ ¸å¿ƒï¼‰

### ðŸŸ¡ **P1 - é‡è¦è¡¨ï¼ˆåˆæœŸå»ºè®®ï¼‰**
è¿™äº›è¡¨å¯¹ç”¨æˆ·ä½“éªŒå¾ˆé‡è¦ï¼Œå»ºè®®åˆæœŸå®žçŽ°ï¼š

7. **advisors** - å¥åº·é¡¾é—®è¡¨
8. **chat_messages** - èŠå¤©è®°å½•è¡¨
9. **review_records** - å®¡æ ¸è®°å½•è¡¨
10. **payment_records** - æ”¯ä»˜è®°å½•è¡¨
11. **notifications** - é€šçŸ¥è¡¨

### ðŸŸ  **P2 - åŠŸèƒ½è¡¨ï¼ˆä¸­æœŸå®Œå–„ï¼‰**
è¿™äº›è¡¨ç”¨äºŽåŠŸèƒ½å®Œå–„ï¼Œä¸­æœŸå®žçŽ°ï¼š

12. **food_database** - é£Ÿç‰©æ•°æ®åº“
13. **exercise_database** - è¿åŠ¨æ•°æ®åº“
14. **user_goals** - ç”¨æˆ·ç›®æ ‡è®¾å®š
15. **user_statistics** - ç”¨æˆ·ç»Ÿè®¡
16. **user_feedback** - ç”¨æˆ·åé¦ˆ

### ðŸ”´ **P3 - é«˜çº§è¡¨ï¼ˆåŽæœŸä¼˜åŒ–ï¼‰**
è¿™äº›è¡¨ç”¨äºŽé«˜çº§åŠŸèƒ½å’Œä¼˜åŒ–ï¼ŒåŽæœŸå®žçŽ°ï¼š

17. **membership_records** - ä¼šå‘˜è®°å½•è¡¨
18. **advisor_income_records** - å¥åº·é¡¾é—®æ”¶å…¥è®°å½•è¡¨
19. **audit_logs** - å®¡è®¡æ—¥å¿—è¡¨
20. **operation_logs** - æ“ä½œæ—¥å¿—è¡¨

### ðŸ“ **ç®€åŒ–è¯´æ˜Ž**
- åŽ»æŽ‰äº†è¿‡äºŽä¸¥æ ¼çš„å¤–é”®çº¦æŸï¼ˆåˆæœŸå¯ä»¥ä¸ç”¨ï¼‰
- ç®€åŒ–äº†æ•°æ®éªŒè¯è§„åˆ™ï¼ˆå…è®¸æ›´å®½æ¾çš„èŒƒå›´ï¼‰
- å‡å°‘äº†ä¸å¿…è¦çš„å”¯ä¸€ç´¢å¼•
- ä¿ç•™äº†æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŽ»æŽ‰äº†é«˜çº§ç‰¹æ€§
- é»˜è®¤çŠ¶æ€æ”¹ä¸ºæ›´å‹å¥½çš„è®¾ç½®ï¼ˆå¦‚ç”¨æˆ·çŠ¶æ€é»˜è®¤ä¸ºactiveï¼‰

---

## 1. æ•°æ®åº“æ¦‚è¿°

### 1.1 æ•°æ®åº“ç±»åž‹
- **æ•°æ®åº“**ï¼šMySQLï¼ˆå…³ç³»åž‹æ•°æ®åº“ï¼‰
- **ç‰ˆæœ¬**ï¼š8.0+
- **å­—ç¬¦é›†**ï¼šutf8mb4
- **æŽ’åºè§„åˆ™**ï¼šutf8mb4_unicode_ci
- **æ—¶åŒº**ï¼šAsia/Shanghai
- **å­˜å‚¨å¼•æ“Ž**ï¼šInnoDB

### 1.2 è®¾è®¡åŽŸåˆ™
- **æ•°æ®è„±æ•**ï¼šæ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨ï¼Œæ˜¾ç¤ºæ—¶è„±æ•
- **åˆ†è¡¨ç­–ç•¥**ï¼šæŒ‰æ—¶é—´åˆ†è¡¨ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
- **ç´¢å¼•ä¼˜åŒ–**ï¼šåˆç†è®¾ç½®ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- **æ•°æ®å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½ï¼Œç¡®ä¿æ•°æ®å®‰å…¨
- **å¤–é”®çº¦æŸ**ï¼šä½¿ç”¨å¤–é”®ä¿è¯æ•°æ®å®Œæ•´æ€§
- **äº‹åŠ¡å¤„ç†**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **å­—ç¬¦é›†ç»Ÿä¸€**ï¼šä½¿ç”¨utf8mb4æ”¯æŒå®Œæ•´Unicodeå­—ç¬¦

---

## 2. æ•°æ®åº“è¡¨è®¾è®¡

### 2.1 ç”¨æˆ·è¡¨ï¼ˆusersï¼‰

**è¡¨å**ï¼š`users`  
**æè¿°**ï¼šå­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `users` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·IDï¼ˆä¸»é”®ï¼‰',
  `openid` varchar(64) NOT NULL COMMENT 'å¾®ä¿¡openid',
  `unionid` varchar(64) DEFAULT NULL COMMENT 'å¾®ä¿¡unionid',
  `nickname` varchar(50) DEFAULT NULL COMMENT 'è„±æ•å§“åï¼ˆæŽXæ˜Žï¼‰',
  `real_name` varchar(100) DEFAULT NULL COMMENT 'çœŸå®žå§“åï¼ˆåŠ å¯†å­˜å‚¨ï¼‰',
  `avatar` varchar(500) DEFAULT NULL COMMENT 'å¤´åƒURL',
  `phone` varchar(20) DEFAULT NULL COMMENT 'æ‰‹æœºå·ï¼ˆåŠ å¯†ï¼‰',
  `email` varchar(100) DEFAULT NULL COMMENT 'é‚®ç®±',
  `gender` enum('male','female') DEFAULT NULL COMMENT 'æ€§åˆ«',
  `age` tinyint unsigned DEFAULT NULL COMMENT 'å¹´é¾„',
  `birth_date` date DEFAULT NULL COMMENT 'å‡ºç”Ÿæ—¥æœŸ',
  `height` decimal(5,2) DEFAULT NULL COMMENT 'èº«é«˜(cm)',
  `current_weight` decimal(5,2) DEFAULT NULL COMMENT 'å½“å‰ä½“é‡(kg)',
  `target_weight` decimal(5,2) DEFAULT NULL COMMENT 'ç›®æ ‡ä½“é‡(kg)',
  `bmi` decimal(4,2) DEFAULT NULL COMMENT 'BMIæŒ‡æ•°',
  `occupation` varchar(100) DEFAULT NULL COMMENT 'èŒä¸š',
  `activity_level` enum('sedentary','light','moderate','active') DEFAULT NULL COMMENT 'æ´»åŠ¨æ°´å¹³',
  `health_goals` json DEFAULT NULL COMMENT 'å¥åº·ç›®æ ‡æ•°ç»„',
  `medical_history` json DEFAULT NULL COMMENT 'ç—…å²æ•°ç»„',
  `dietary_restrictions` json DEFAULT NULL COMMENT 'é¥®é£Ÿé™åˆ¶',
  `allergies` json DEFAULT NULL COMMENT 'è¿‡æ•ä¿¡æ¯',
  `preferred_language` varchar(10) DEFAULT 'zh-CN' COMMENT 'é¦–é€‰è¯­è¨€',
  `timezone` varchar(50) DEFAULT 'Asia/Shanghai' COMMENT 'æ—¶åŒº',
  `advisor_id` bigint unsigned DEFAULT NULL COMMENT 'å…³è”å¥åº·é¡¾é—®ID',
  `member_level` enum('free','standard','premium') DEFAULT 'free' COMMENT 'ä¼šå‘˜ç­‰çº§',
  `member_expire` datetime DEFAULT NULL COMMENT 'ä¼šå‘˜åˆ°æœŸæ—¶é—´',
  `status` enum('active','inactive','blocked','pending') DEFAULT 'active' COMMENT 'çŠ¶æ€',
  `notification_settings` json DEFAULT NULL COMMENT 'é€šçŸ¥è®¾ç½®',
  `privacy_settings` json DEFAULT NULL COMMENT 'éšç§è®¾ç½®',
  `last_login` datetime DEFAULT NULL COMMENT 'æœ€åŽç™»å½•æ—¶é—´',
  `login_count` int unsigned DEFAULT 0 COMMENT 'ç™»å½•æ¬¡æ•°',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  KEY `idx_advisor_id` (`advisor_id`),
  KEY `idx_member_level` (`member_level`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å”¯ä¸€ç´¢å¼•
ALTER TABLE `users` ADD UNIQUE KEY `uk_openid` (`openid`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `users` ADD KEY `idx_advisor_id` (`advisor_id`);
ALTER TABLE `users` ADD KEY `idx_member_level` (`member_level`);
ALTER TABLE `users` ADD KEY `idx_status` (`status`);
ALTER TABLE `users` ADD KEY `idx_created_at` (`created_at`);
```

**çº¦æŸæ¡ä»¶**ï¼š
```sql
-- åŸºç¡€æ•°æ®çº¦æŸï¼ˆç®€åŒ–ç‰ˆï¼‰
ALTER TABLE `users` ADD CONSTRAINT `chk_age_basic` CHECK (`age` IS NULL OR (`age` >= 1 AND `age` <= 120));
ALTER TABLE `users` ADD CONSTRAINT `chk_height_basic` CHECK (`height` IS NULL OR (`height` >= 50 AND `height` <= 300));
ALTER TABLE `users` ADD CONSTRAINT `chk_weight_basic` CHECK (`current_weight` IS NULL OR (`current_weight` >= 10 AND `current_weight` <= 500));

-- è§¦å‘å™¨ï¼šè‡ªåŠ¨è®¡ç®—BMIï¼ˆç®€åŒ–ç‰ˆï¼‰
DELIMITER $$
CREATE TRIGGER `tr_users_bmi_calc` 
BEFORE INSERT ON `users` 
FOR EACH ROW 
BEGIN
    IF NEW.current_weight IS NOT NULL AND NEW.height IS NOT NULL AND NEW.height > 0 THEN
        SET NEW.bmi = NEW.current_weight / POWER(NEW.height / 100, 2);
    END IF;
END$$

CREATE TRIGGER `tr_users_bmi_calc_update` 
BEFORE UPDATE ON `users` 
FOR EACH ROW 
BEGIN
    IF NEW.current_weight IS NOT NULL AND NEW.height IS NOT NULL AND NEW.height > 0 THEN
        SET NEW.bmi = NEW.current_weight / POWER(NEW.height / 100, 2);
    END IF;
END$$
DELIMITER ;
```

### 2.2 å¥åº·é¡¾é—®è¡¨ï¼ˆadvisorsï¼‰

**è¡¨å**ï¼š`advisors`  
**æè¿°**ï¼šå­˜å‚¨å¥åº·é¡¾é—®ä¿¡æ¯

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `advisors` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'å¥åº·é¡¾é—®IDï¼ˆä¸»é”®ï¼‰',
  `name` varchar(100) NOT NULL COMMENT 'å§“å',
  `avatar` varchar(500) DEFAULT NULL COMMENT 'å¤´åƒURL',
  `phone` varchar(20) NOT NULL COMMENT 'æ‰‹æœºå·ï¼ˆåŠ å¯†ï¼‰',
  `email` varchar(100) DEFAULT NULL COMMENT 'é‚®ç®±',
  `id_card` varchar(20) DEFAULT NULL COMMENT 'èº«ä»½è¯å·ï¼ˆåŠ å¯†ï¼‰',
  `license_number` varchar(50) DEFAULT NULL COMMENT 'æ‰§ä¸šè¯ä¹¦å·',
  `specialty` json DEFAULT NULL COMMENT 'ä¸“ä¸šé¢†åŸŸæ•°ç»„',
  `specialization` json DEFAULT NULL COMMENT 'ä¸“ä¸šç‰¹é•¿',
  `qualification` varchar(200) DEFAULT NULL COMMENT 'èµ„è´¨è¯ä¹¦',
  `education` varchar(100) DEFAULT NULL COMMENT 'å­¦åŽ†',
  `work_experience` text DEFAULT NULL COMMENT 'å·¥ä½œç»åŽ†',
  `hospital` varchar(200) DEFAULT NULL COMMENT 'åˆä½œåŒ»é™¢',
  `description` text DEFAULT NULL COMMENT 'ä¸“ä¸šæè¿°',
  `experience_years` tinyint unsigned DEFAULT NULL COMMENT 'ä»Žä¸šå¹´é™',
  `consultation_fee` int unsigned DEFAULT 0 COMMENT 'å’¨è¯¢è´¹ç”¨ï¼ˆåˆ†ï¼‰',
  `user_count` int unsigned DEFAULT 0 COMMENT 'æœåŠ¡ç”¨æˆ·æ•°',
  `rating` decimal(2,1) DEFAULT NULL COMMENT 'è¯„åˆ†ï¼ˆ1-5ï¼‰',
  `total_income` bigint unsigned DEFAULT 0 COMMENT 'æ€»æ”¶å…¥ï¼ˆåˆ†ï¼‰',
  `monthly_income` bigint unsigned DEFAULT 0 COMMENT 'æœˆæ”¶å…¥ï¼ˆåˆ†ï¼‰',
  `status` enum('active','inactive','blocked','pending') DEFAULT 'pending' COMMENT 'çŠ¶æ€',
  `verification_status` enum('pending','verified','rejected') DEFAULT 'pending' COMMENT 'è®¤è¯çŠ¶æ€',
  `is_online` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦åœ¨çº¿',
  `max_users` int unsigned DEFAULT 100 COMMENT 'æœ€å¤§æœåŠ¡ç”¨æˆ·æ•°',
  `max_daily_consultations` int unsigned DEFAULT 20 COMMENT 'æ¯æ—¥æœ€å¤§å’¨è¯¢æ•°',
  `response_time` int unsigned DEFAULT NULL COMMENT 'å¹³å‡å“åº”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰',
  `available_time` json DEFAULT NULL COMMENT 'å¯æœåŠ¡æ—¶é—´',
  `service_areas` json DEFAULT NULL COMMENT 'æœåŠ¡åŒºåŸŸ',
  `languages` json DEFAULT NULL COMMENT 'æŽŒæ¡è¯­è¨€',
  `certificates` json DEFAULT NULL COMMENT 'è¯ä¹¦ä¿¡æ¯',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_phone` (`phone`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_id_card` (`id_card`),
  UNIQUE KEY `uk_license_number` (`license_number`),
  KEY `idx_status` (`status`),
  KEY `idx_verification_status` (`verification_status`),
  KEY `idx_rating` (`rating`),
  KEY `idx_user_count` (`user_count`),
  KEY `idx_is_online` (`is_online`),
  KEY `idx_consultation_fee` (`consultation_fee`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å¥åº·é¡¾é—®è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å”¯ä¸€ç´¢å¼•
ALTER TABLE `advisors` ADD UNIQUE KEY `uk_phone` (`phone`);
ALTER TABLE `advisors` ADD UNIQUE KEY `uk_email` (`email`);
ALTER TABLE `advisors` ADD UNIQUE KEY `uk_id_card` (`id_card`);
ALTER TABLE `advisors` ADD UNIQUE KEY `uk_license_number` (`license_number`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `advisors` ADD KEY `idx_status` (`status`);
ALTER TABLE `advisors` ADD KEY `idx_verification_status` (`verification_status`);
ALTER TABLE `advisors` ADD KEY `idx_rating` (`rating`);
ALTER TABLE `advisors` ADD KEY `idx_user_count` (`user_count`);
ALTER TABLE `advisors` ADD KEY `idx_is_online` (`is_online`);
ALTER TABLE `advisors` ADD KEY `idx_consultation_fee` (`consultation_fee`);
ALTER TABLE `advisors` ADD KEY `idx_created_at` (`created_at`);
```

### 2.3 ä½“é‡è®°å½•è¡¨ï¼ˆweight_recordsï¼‰

**è¡¨å**ï¼š`weight_records`  
**æè¿°**ï¼šå­˜å‚¨ç”¨æˆ·ä½“é‡è®°å½•

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `weight_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'è®°å½•IDï¼ˆä¸»é”®ï¼‰',
  `user_id` bigint unsigned NOT NULL COMMENT 'ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰',
  `weight` decimal(5,2) NOT NULL COMMENT 'ä½“é‡(kg)',
  `bmi` decimal(4,2) DEFAULT NULL COMMENT 'BMIæŒ‡æ•°',
  `record_date` date NOT NULL COMMENT 'è®°å½•æ—¥æœŸ',
  `record_time` datetime NOT NULL COMMENT 'è®°å½•æ—¶é—´',
  `record_type` enum('manual','photo','auto') DEFAULT 'manual' COMMENT 'è®°å½•ç±»åž‹',
  `photo_url` varchar(500) DEFAULT NULL COMMENT 'ç…§ç‰‡URL',
  `note` text DEFAULT NULL COMMENT 'å¤‡æ³¨',
  `device_info` json DEFAULT NULL COMMENT 'è®¾å¤‡ä¿¡æ¯',
  `location` json DEFAULT NULL COMMENT 'ä½ç½®ä¿¡æ¯',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_record_date` (`user_id`, `record_date`),
  KEY `idx_user_id_created_at` (`user_id`, `created_at`),
  KEY `idx_record_type` (`record_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ä½“é‡è®°å½•è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å¤åˆç´¢å¼•
ALTER TABLE `weight_records` ADD KEY `idx_user_id_record_date` (`user_id`, `record_date`);
ALTER TABLE `weight_records` ADD KEY `idx_user_id_created_at` (`user_id`, `created_at`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `weight_records` ADD KEY `idx_record_type` (`record_type`);
```

**çº¦æŸæ¡ä»¶**ï¼š
```sql
-- åŸºç¡€æ•°æ®çº¦æŸï¼ˆç®€åŒ–ç‰ˆï¼‰
ALTER TABLE `weight_records` ADD CONSTRAINT `chk_weight_basic` CHECK (`weight` >= 10 AND `weight` <= 500);
```

### 2.4 é¥®é£Ÿè®°å½•è¡¨ï¼ˆdiet_recordsï¼‰

**è¡¨å**ï¼š`diet_records`  
**æè¿°**ï¼šå­˜å‚¨ç”¨æˆ·é¥®é£Ÿè®°å½•

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `diet_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'è®°å½•IDï¼ˆä¸»é”®ï¼‰',
  `user_id` bigint unsigned NOT NULL COMMENT 'ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰',
  `food_name` varchar(200) NOT NULL COMMENT 'é£Ÿç‰©åç§°',
  `food_category` varchar(50) DEFAULT NULL COMMENT 'é£Ÿç‰©åˆ†ç±»',
  `quantity` decimal(8,2) NOT NULL COMMENT 'æ•°é‡',
  `unit` varchar(20) DEFAULT NULL COMMENT 'å•ä½',
  `calories` decimal(8,2) DEFAULT NULL COMMENT 'çƒ­é‡(kcal)',
  `protein` decimal(6,2) DEFAULT NULL COMMENT 'è›‹ç™½è´¨(g)',
  `fat` decimal(6,2) DEFAULT NULL COMMENT 'è„‚è‚ª(g)',
  `carbs` decimal(6,2) DEFAULT NULL COMMENT 'ç¢³æ°´åŒ–åˆç‰©(g)',
  `fiber` decimal(6,2) DEFAULT NULL COMMENT 'è†³é£Ÿçº¤ç»´(g)',
  `sugar` decimal(6,2) DEFAULT NULL COMMENT 'ç³–åˆ†(g)',
  `sodium` decimal(8,2) DEFAULT NULL COMMENT 'é’ (mg)',
  `photo_url` varchar(500) DEFAULT NULL COMMENT 'ç…§ç‰‡URL',
  `meal_type` enum('breakfast','lunch','dinner','snack') DEFAULT NULL COMMENT 'é¤æ¬¡ç±»åž‹',
  `record_date` date NOT NULL COMMENT 'è®°å½•æ—¥æœŸ',
  `record_time` datetime NOT NULL COMMENT 'è®°å½•æ—¶é—´',
  `record_type` enum('manual','photo','ai') DEFAULT 'manual' COMMENT 'è®°å½•ç±»åž‹',
  `ai_confidence` decimal(3,2) DEFAULT NULL COMMENT 'AIè¯†åˆ«ç½®ä¿¡åº¦',
  `note` text DEFAULT NULL COMMENT 'å¤‡æ³¨',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_record_date` (`user_id`, `record_date`),
  KEY `idx_user_id_meal_type_record_date` (`user_id`, `meal_type`, `record_date`),
  KEY `idx_meal_type` (`meal_type`),
  KEY `idx_record_type` (`record_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='é¥®é£Ÿè®°å½•è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å¤åˆç´¢å¼•
ALTER TABLE `diet_records` ADD KEY `idx_user_id_record_date` (`user_id`, `record_date`);
ALTER TABLE `diet_records` ADD KEY `idx_user_id_meal_type_record_date` (`user_id`, `meal_type`, `record_date`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `diet_records` ADD KEY `idx_meal_type` (`meal_type`);
ALTER TABLE `diet_records` ADD KEY `idx_record_type` (`record_type`);
```

**çº¦æŸæ¡ä»¶**ï¼š
```sql
-- åŸºç¡€æ•°æ®çº¦æŸï¼ˆç®€åŒ–ç‰ˆï¼‰
ALTER TABLE `diet_records` ADD CONSTRAINT `chk_quantity_basic` CHECK (`quantity` > 0 AND `quantity` <= 10000);
ALTER TABLE `diet_records` ADD CONSTRAINT `chk_calories_basic` CHECK (`calories` IS NULL OR (`calories` >= 0 AND `calories` <= 10000));
```

### 2.5 è¿åŠ¨è®°å½•è¡¨ï¼ˆexercise_recordsï¼‰

**è¡¨å**ï¼š`exercise_records`  
**æè¿°**ï¼šå­˜å‚¨ç”¨æˆ·è¿åŠ¨è®°å½•

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `exercise_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'è®°å½•IDï¼ˆä¸»é”®ï¼‰',
  `user_id` bigint unsigned NOT NULL COMMENT 'ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰',
  `exercise_type` enum('cardio','strength','flexibility') NOT NULL COMMENT 'è¿åŠ¨ç±»åž‹',
  `exercise_name` varchar(200) NOT NULL COMMENT 'è¿åŠ¨åç§°',
  `duration` int unsigned NOT NULL COMMENT 'è¿åŠ¨æ—¶é•¿(åˆ†é’Ÿ)',
  `intensity` enum('low','medium','high') NOT NULL COMMENT 'è¿åŠ¨å¼ºåº¦',
  `calories_burned` decimal(8,2) DEFAULT NULL COMMENT 'æ¶ˆè€—å¡è·¯é‡Œ',
  `distance` decimal(8,2) DEFAULT NULL COMMENT 'è·ç¦»(km)',
  `steps` int unsigned DEFAULT NULL COMMENT 'æ­¥æ•°',
  `heart_rate_avg` int unsigned DEFAULT NULL COMMENT 'å¹³å‡å¿ƒçŽ‡',
  `heart_rate_max` int unsigned DEFAULT NULL COMMENT 'æœ€å¤§å¿ƒçŽ‡',
  `heart_rate_min` int unsigned DEFAULT NULL COMMENT 'æœ€å°å¿ƒçŽ‡',
  `photo_url` varchar(500) DEFAULT NULL COMMENT 'ç…§ç‰‡URL',
  `record_date` date NOT NULL COMMENT 'è®°å½•æ—¥æœŸ',
  `record_time` datetime NOT NULL COMMENT 'è®°å½•æ—¶é—´',
  `record_type` enum('manual','photo','auto') DEFAULT 'manual' COMMENT 'è®°å½•ç±»åž‹',
  `device_info` json DEFAULT NULL COMMENT 'è®¾å¤‡ä¿¡æ¯',
  `location` json DEFAULT NULL COMMENT 'ä½ç½®ä¿¡æ¯',
  `note` text DEFAULT NULL COMMENT 'å¤‡æ³¨',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_record_date` (`user_id`, `record_date`),
  KEY `idx_user_id_exercise_type` (`user_id`, `exercise_type`),
  KEY `idx_exercise_type` (`exercise_type`),
  KEY `idx_intensity` (`intensity`),
  KEY `idx_record_type` (`record_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è¿åŠ¨è®°å½•è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å¤åˆç´¢å¼•
ALTER TABLE `exercise_records` ADD KEY `idx_user_id_record_date` (`user_id`, `record_date`);
ALTER TABLE `exercise_records` ADD KEY `idx_user_id_exercise_type` (`user_id`, `exercise_type`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `exercise_records` ADD KEY `idx_exercise_type` (`exercise_type`);
ALTER TABLE `exercise_records` ADD KEY `idx_intensity` (`intensity`);
ALTER TABLE `exercise_records` ADD KEY `idx_record_type` (`record_type`);
```

**çº¦æŸæ¡ä»¶**ï¼š
```sql
-- åŸºç¡€æ•°æ®çº¦æŸï¼ˆç®€åŒ–ç‰ˆï¼‰
ALTER TABLE `exercise_records` ADD CONSTRAINT `chk_duration_basic` CHECK (`duration` >= 1 AND `duration` <= 480);
ALTER TABLE `exercise_records` ADD CONSTRAINT `chk_calories_burned_basic` CHECK (`calories_burned` IS NULL OR (`calories_burned` >= 0 AND `calories_burned` <= 5000));
ALTER TABLE `exercise_records` ADD CONSTRAINT `chk_distance_basic` CHECK (`distance` IS NULL OR (`distance` >= 0 AND `distance` <= 1000));
ALTER TABLE `exercise_records` ADD CONSTRAINT `chk_steps_basic` CHECK (`steps` IS NULL OR (`steps` >= 0 AND `steps` <= 100000));
```

### 2.6 AIæ–¹æ¡ˆè¡¨ï¼ˆai_plansï¼‰

**è¡¨å**ï¼š`ai_plans`  
**æè¿°**ï¼šå­˜å‚¨AIç”Ÿæˆçš„å¥åº·æ–¹æ¡ˆ

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `ai_plans` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'æ–¹æ¡ˆIDï¼ˆä¸»é”®ï¼‰',
  `user_id` bigint unsigned NOT NULL COMMENT 'ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰',
  `advisor_id` bigint unsigned DEFAULT NULL COMMENT 'å¥åº·é¡¾é—®IDï¼ˆå¤–é”®ï¼Œå¯é€‰ï¼‰',
  `plan_name` varchar(200) NOT NULL COMMENT 'æ–¹æ¡ˆåç§°',
  `plan_type` enum('gentle','standard','aggressive') DEFAULT 'standard' COMMENT 'æ–¹æ¡ˆç±»åž‹',
  `target_weight` decimal(5,2) DEFAULT NULL COMMENT 'ç›®æ ‡ä½“é‡',
  `duration` int unsigned DEFAULT NULL COMMENT 'æŒç»­æ—¶é—´(å¤©)',
  `expected_loss` decimal(4,2) DEFAULT NULL COMMENT 'é¢„æœŸå‡é‡(kg)',
  `daily_calories` int unsigned DEFAULT NULL COMMENT 'æ¯æ—¥çƒ­é‡',
  `diet_plan` json DEFAULT NULL COMMENT 'é¥®é£Ÿè®¡åˆ’',
  `exercise_plan` json DEFAULT NULL COMMENT 'è¿åŠ¨è®¡åˆ’',
  `lifestyle_plan` json DEFAULT NULL COMMENT 'ç”Ÿæ´»æ–¹å¼å»ºè®®',
  `status` enum('draft','pending','reviewed','approved','rejected') DEFAULT 'draft' COMMENT 'çŠ¶æ€',
  `review_comment` text DEFAULT NULL COMMENT 'å®¡æ ¸æ„è§',
  `review_fee` int unsigned DEFAULT 0 COMMENT 'å®¡æ ¸è´¹ç”¨',
  `reviewed_at` datetime DEFAULT NULL COMMENT 'å®¡æ ¸æ—¶é—´',
  `reviewed_by` bigint unsigned DEFAULT NULL COMMENT 'å®¡æ ¸äººID',
  `execution_status` enum('not_started','in_progress','completed','paused') DEFAULT 'not_started' COMMENT 'æ‰§è¡ŒçŠ¶æ€',
  `start_date` date DEFAULT NULL COMMENT 'å¼€å§‹æ—¥æœŸ',
  `end_date` date DEFAULT NULL COMMENT 'ç»“æŸæ—¥æœŸ',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_status` (`user_id`, `status`),
  KEY `idx_advisor_id_status` (`advisor_id`, `status`),
  KEY `idx_plan_type` (`plan_type`),
  KEY `idx_status` (`status`),
  KEY `idx_execution_status` (`execution_status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AIæ–¹æ¡ˆè¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å¤åˆç´¢å¼•
ALTER TABLE `ai_plans` ADD KEY `idx_user_id_status` (`user_id`, `status`);
ALTER TABLE `ai_plans` ADD KEY `idx_advisor_id_status` (`advisor_id`, `status`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `ai_plans` ADD KEY `idx_plan_type` (`plan_type`);
ALTER TABLE `ai_plans` ADD KEY `idx_status` (`status`);
ALTER TABLE `ai_plans` ADD KEY `idx_execution_status` (`execution_status`);
ALTER TABLE `ai_plans` ADD KEY `idx_created_at` (`created_at`);
```

**çº¦æŸæ¡ä»¶**ï¼š
```sql
-- åŸºç¡€æ•°æ®çº¦æŸï¼ˆç®€åŒ–ç‰ˆï¼‰
ALTER TABLE `ai_plans` ADD CONSTRAINT `chk_duration_basic` CHECK (`duration` IS NULL OR (`duration` >= 1 AND `duration` <= 365));
ALTER TABLE `ai_plans` ADD CONSTRAINT `chk_daily_calories_basic` CHECK (`daily_calories` IS NULL OR (`daily_calories` >= 500 AND `daily_calories` <= 5000));
```

### 2.7 èŠå¤©è®°å½•è¡¨ï¼ˆchat_messagesï¼‰

**è¡¨å**ï¼š`chat_messages`  
**æè¿°**ï¼šå­˜å‚¨ç”¨æˆ·ä¸Žå¥åº·é¡¾é—®çš„èŠå¤©è®°å½•

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `chat_messages` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'æ¶ˆæ¯IDï¼ˆä¸»é”®ï¼‰',
  `user_id` bigint unsigned NOT NULL COMMENT 'ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰',
  `advisor_id` bigint unsigned NOT NULL COMMENT 'å¥åº·é¡¾é—®IDï¼ˆå¤–é”®ï¼‰',
  `sender_type` enum('user','advisor','system') NOT NULL COMMENT 'å‘é€è€…ç±»åž‹',
  `message_type` enum('text','image','file','system') DEFAULT 'text' COMMENT 'æ¶ˆæ¯ç±»åž‹',
  `content` text DEFAULT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
  `image_url` varchar(500) DEFAULT NULL COMMENT 'å›¾ç‰‡URL',
  `file_url` varchar(500) DEFAULT NULL COMMENT 'æ–‡ä»¶URL',
  `file_name` varchar(200) DEFAULT NULL COMMENT 'æ–‡ä»¶å',
  `file_size` bigint unsigned DEFAULT NULL COMMENT 'æ–‡ä»¶å¤§å°',
  `is_read` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦å·²è¯»',
  `read_at` datetime DEFAULT NULL COMMENT 'é˜…è¯»æ—¶é—´',
  `is_deleted` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦å·²åˆ é™¤',
  `deleted_at` datetime DEFAULT NULL COMMENT 'åˆ é™¤æ—¶é—´',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_advisor_id_created_at` (`user_id`, `advisor_id`, `created_at`),
  KEY `idx_advisor_id_user_id_created_at` (`advisor_id`, `user_id`, `created_at`),
  KEY `idx_sender_type` (`sender_type`),
  KEY `idx_message_type` (`message_type`),
  KEY `idx_is_read` (`is_read`),
  KEY `idx_is_deleted` (`is_deleted`),
  CONSTRAINT `fk_chat_messages_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_chat_messages_advisor_id` FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='èŠå¤©è®°å½•è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å¤åˆç´¢å¼•
ALTER TABLE `chat_messages` ADD KEY `idx_user_id_advisor_id_created_at` (`user_id`, `advisor_id`, `created_at`);
ALTER TABLE `chat_messages` ADD KEY `idx_advisor_id_user_id_created_at` (`advisor_id`, `user_id`, `created_at`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `chat_messages` ADD KEY `idx_sender_type` (`sender_type`);
ALTER TABLE `chat_messages` ADD KEY `idx_message_type` (`message_type`);
ALTER TABLE `chat_messages` ADD KEY `idx_is_read` (`is_read`);
ALTER TABLE `chat_messages` ADD KEY `idx_is_deleted` (`is_deleted`);
```

### 2.8 å®¡æ ¸è®°å½•è¡¨ï¼ˆreview_recordsï¼‰

**è¡¨å**ï¼š`review_records`  
**æè¿°**ï¼šå­˜å‚¨å¥åº·é¡¾é—®å®¡æ ¸è®°å½•

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `review_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'å®¡æ ¸è®°å½•IDï¼ˆä¸»é”®ï¼‰',
  `plan_id` bigint unsigned NOT NULL COMMENT 'æ–¹æ¡ˆIDï¼ˆå¤–é”®ï¼‰',
  `user_id` bigint unsigned NOT NULL COMMENT 'ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰',
  `advisor_id` bigint unsigned NOT NULL COMMENT 'å¥åº·é¡¾é—®IDï¼ˆå¤–é”®ï¼‰',
  `review_type` enum('plan_review','chat_review') NOT NULL COMMENT 'å®¡æ ¸ç±»åž‹',
  `review_status` enum('pending','approved','rejected','modified') NOT NULL COMMENT 'å®¡æ ¸çŠ¶æ€',
  `review_comment` text DEFAULT NULL COMMENT 'å®¡æ ¸æ„è§',
  `modification_suggestions` json DEFAULT NULL COMMENT 'ä¿®æ”¹å»ºè®®',
  `review_fee` int unsigned DEFAULT 0 COMMENT 'å®¡æ ¸è´¹ç”¨ï¼ˆåˆ†ï¼‰',
  `fee_status` enum('pending','paid','refunded') DEFAULT 'pending' COMMENT 'è´¹ç”¨çŠ¶æ€',
  `review_time` int unsigned DEFAULT NULL COMMENT 'å®¡æ ¸è€—æ—¶(åˆ†é’Ÿ)',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `reviewed_at` datetime DEFAULT NULL COMMENT 'å®¡æ ¸æ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_plan_id_review_status` (`plan_id`, `review_status`),
  KEY `idx_advisor_id_review_status` (`advisor_id`, `review_status`),
  KEY `idx_user_id_review_status` (`user_id`, `review_status`),
  KEY `idx_review_type` (`review_type`),
  KEY `idx_review_status` (`review_status`),
  KEY `idx_fee_status` (`fee_status`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_review_records_plan_id` FOREIGN KEY (`plan_id`) REFERENCES `ai_plans` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_review_records_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_review_records_advisor_id` FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å®¡æ ¸è®°å½•è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å¤åˆç´¢å¼•
ALTER TABLE `review_records` ADD KEY `idx_plan_id_review_status` (`plan_id`, `review_status`);
ALTER TABLE `review_records` ADD KEY `idx_advisor_id_review_status` (`advisor_id`, `review_status`);
ALTER TABLE `review_records` ADD KEY `idx_user_id_review_status` (`user_id`, `review_status`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `review_records` ADD KEY `idx_review_type` (`review_type`);
ALTER TABLE `review_records` ADD KEY `idx_review_status` (`review_status`);
ALTER TABLE `review_records` ADD KEY `idx_fee_status` (`fee_status`);
ALTER TABLE `review_records` ADD KEY `idx_created_at` (`created_at`);
```

**çº¦æŸæ¡ä»¶**ï¼š
```sql
-- æ•°æ®çº¦æŸ
ALTER TABLE `review_records` ADD CONSTRAINT `chk_review_fee` CHECK (`review_fee` >= 0 AND `review_fee` <= 100000);
ALTER TABLE `review_records` ADD CONSTRAINT `chk_review_time` CHECK (`review_time` >= 0 AND `review_time` <= 1440);
```

### 2.9 æ”¯ä»˜è®°å½•è¡¨ï¼ˆpayment_recordsï¼‰

**è¡¨å**ï¼š`payment_records`  
**æè¿°**ï¼šå­˜å‚¨æ”¯ä»˜å’Œé€€æ¬¾è®°å½•

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `payment_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'æ”¯ä»˜è®°å½•IDï¼ˆä¸»é”®ï¼‰',
  `user_id` bigint unsigned NOT NULL COMMENT 'ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰',
  `order_id` varchar(64) NOT NULL COMMENT 'è®¢å•ID',
  `transaction_id` varchar(64) DEFAULT NULL COMMENT 'å¾®ä¿¡æ”¯ä»˜äº¤æ˜“ID',
  `payment_type` enum('membership','review','service') NOT NULL COMMENT 'æ”¯ä»˜ç±»åž‹',
  `amount` int unsigned NOT NULL COMMENT 'æ”¯ä»˜é‡‘é¢(åˆ†)',
  `currency` varchar(10) DEFAULT 'CNY' COMMENT 'è´§å¸ç±»åž‹',
  `status` enum('pending','success','failed','refunded') DEFAULT 'pending' COMMENT 'æ”¯ä»˜çŠ¶æ€',
  `payment_method` varchar(20) DEFAULT 'wechat_pay' COMMENT 'æ”¯ä»˜æ–¹å¼',
  `description` varchar(500) DEFAULT NULL COMMENT 'æ”¯ä»˜æè¿°',
  `related_id` bigint unsigned DEFAULT NULL COMMENT 'å…³è”IDï¼ˆæ–¹æ¡ˆIDã€ä¼šå‘˜IDç­‰ï¼‰',
  `refund_amount` int unsigned DEFAULT 0 COMMENT 'é€€æ¬¾é‡‘é¢(åˆ†)',
  `refund_reason` varchar(200) DEFAULT NULL COMMENT 'é€€æ¬¾åŽŸå› ',
  `refund_time` datetime DEFAULT NULL COMMENT 'é€€æ¬¾æ—¶é—´',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `paid_at` datetime DEFAULT NULL COMMENT 'æ”¯ä»˜æ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_id` (`order_id`),
  UNIQUE KEY `uk_transaction_id` (`transaction_id`),
  KEY `idx_user_id_status` (`user_id`, `status`),
  KEY `idx_payment_type_status` (`payment_type`, `status`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_payment_records_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ”¯ä»˜è®°å½•è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å”¯ä¸€ç´¢å¼•
ALTER TABLE `payment_records` ADD UNIQUE KEY `uk_order_id` (`order_id`);
ALTER TABLE `payment_records` ADD UNIQUE KEY `uk_transaction_id` (`transaction_id`);

-- å¤åˆç´¢å¼•
ALTER TABLE `payment_records` ADD KEY `idx_user_id_status` (`user_id`, `status`);
ALTER TABLE `payment_records` ADD KEY `idx_payment_type_status` (`payment_type`, `status`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `payment_records` ADD KEY `idx_status` (`status`);
ALTER TABLE `payment_records` ADD KEY `idx_created_at` (`created_at`);
```

### 2.10 ç³»ç»Ÿé…ç½®è¡¨ï¼ˆsystem_configsï¼‰

**è¡¨å**ï¼š`system_configs`  
**æè¿°**ï¼šå­˜å‚¨ç³»ç»Ÿé…ç½®ä¿¡æ¯

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `system_configs` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'é…ç½®IDï¼ˆä¸»é”®ï¼‰',
  `config_key` varchar(100) NOT NULL COMMENT 'é…ç½®é”®',
  `config_value` json DEFAULT NULL COMMENT 'é…ç½®å€¼',
  `config_type` enum('string','number','boolean','object') DEFAULT 'string' COMMENT 'é…ç½®ç±»åž‹',
  `description` varchar(500) DEFAULT NULL COMMENT 'é…ç½®æè¿°',
  `category` varchar(50) DEFAULT NULL COMMENT 'é…ç½®åˆ†ç±»',
  `is_active` tinyint(1) DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`),
  KEY `idx_category` (`category`),
  KEY `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç³»ç»Ÿé…ç½®è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å”¯ä¸€ç´¢å¼•
ALTER TABLE `system_configs` ADD UNIQUE KEY `uk_config_key` (`config_key`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `system_configs` ADD KEY `idx_category` (`category`);
ALTER TABLE `system_configs` ADD KEY `idx_is_active` (`is_active`);
```

**çº¦æŸæ¡ä»¶**ï¼š
```sql
-- åŸºç¡€æ•°æ®çº¦æŸï¼ˆç®€åŒ–ç‰ˆï¼‰
-- æ— ç‰¹æ®Šçº¦æŸï¼Œä¿æŒçµæ´»æ€§
```

### 2.11 æ“ä½œæ—¥å¿—é›†åˆï¼ˆoperation_logsï¼‰

**é›†åˆåç§°**ï¼š`operation_logs`  
**æè¿°**ï¼šå­˜å‚¨ç³»ç»Ÿæ“ä½œæ—¥å¿—

**å­—æ®µç»“æž„**ï¼š
```javascript
{
  "_id": ObjectId,                    // æ—¥å¿—IDï¼ˆä¸»é”®ï¼‰
  "user_id": ObjectId,                // ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰
  "advisor_id": ObjectId,             // å¥åº·é¡¾é—®IDï¼ˆå¯é€‰ï¼‰
  "operation_type": String,           // æ“ä½œç±»åž‹
  "operation_name": String,           // æ“ä½œåç§°
  "resource_type": String,            // èµ„æºç±»åž‹
  "resource_id": ObjectId,            // èµ„æºID
  "request_data": Object,             // è¯·æ±‚æ•°æ®
  "response_data": Object,            // å“åº”æ•°æ®
  "ip_address": String,               // IPåœ°å€
  "user_agent": String,               // ç”¨æˆ·ä»£ç†
  "status": String,                   // æ“ä½œçŠ¶æ€ï¼šsuccess/failed
  "error_message": String,            // é”™è¯¯ä¿¡æ¯
  "execution_time": Number,           // æ‰§è¡Œæ—¶é—´(ms)
  "created_at": Date                  // åˆ›å»ºæ—¶é—´
}
```

**ç´¢å¼•è®¾è®¡**ï¼š
```javascript
// å¤åˆç´¢å¼•
db.operation_logs.createIndex({"user_id": 1, "created_at": -1})
db.operation_logs.createIndex({"advisor_id": 1, "created_at": -1})

// æ™®é€šç´¢å¼•
db.operation_logs.createIndex({"operation_type": 1})
db.operation_logs.createIndex({"resource_type": 1})
db.operation_logs.createIndex({"status": 1})
db.operation_logs.createIndex({"created_at": -1})
```

### 2.6 é£Ÿç‰©æ•°æ®åº“é›†åˆï¼ˆfood_databaseï¼‰

**é›†åˆåç§°**ï¼š`food_database`  
**æè¿°**ï¼šå­˜å‚¨é£Ÿç‰©è¥å…»ä¿¡æ¯æ•°æ®åº“

**å­—æ®µç»“æž„**ï¼š
```javascript
{
  "_id": ObjectId,                    // é£Ÿç‰©IDï¼ˆä¸»é”®ï¼‰
  "food_name": String,                // é£Ÿç‰©åç§°
  "food_category": String,            // é£Ÿç‰©åˆ†ç±»ï¼šgrains/vegetables/fruits/meat/dairy/nuts/seafood/others
  "food_subcategory": String,         // é£Ÿç‰©å­åˆ†ç±»
  "calories_per_100g": Number,        // æ¯100gçƒ­é‡(kcal)
  "protein_per_100g": Number,         // æ¯100gè›‹ç™½è´¨(g)
  "fat_per_100g": Number,             // æ¯100gè„‚è‚ª(g)
  "carbs_per_100g": Number,           // æ¯100gç¢³æ°´åŒ–åˆç‰©(g)
  "fiber_per_100g": Number,           // æ¯100gè†³é£Ÿçº¤ç»´(g)
  "sugar_per_100g": Number,           // æ¯100gç³–åˆ†(g)
  "sodium_per_100g": Number,          // æ¯100gé’ (mg)
  "vitamin_a": Number,                // ç»´ç”Ÿç´ A(Î¼g)
  "vitamin_c": Number,                // ç»´ç”Ÿç´ C(mg)
  "vitamin_d": Number,                // ç»´ç”Ÿç´ D(Î¼g)
  "vitamin_e": Number,                // ç»´ç”Ÿç´ E(mg)
  "calcium": Number,                  // é’™(mg)
  "iron": Number,                     // é“(mg)
  "zinc": Number,                     // é”Œ(mg)
  "common_units": [{                  // å¸¸è§å•ä½
    "unit_name": String,              // å•ä½åç§°
    "weight": Number,                 // é‡é‡(g)
    "calories": Number,               // çƒ­é‡(kcal)
    "protein": Number,                // è›‹ç™½è´¨(g)
    "fat": Number,                    // è„‚è‚ª(g)
    "carbs": Number                   // ç¢³æ°´åŒ–åˆç‰©(g)
  }],
  "image_url": String,                // é£Ÿç‰©å›¾ç‰‡
  "description": String,              // é£Ÿç‰©æè¿°
  "tags": [String],                   // æ ‡ç­¾
  "is_active": Boolean,               // æ˜¯å¦å¯ç”¨
  "search_keywords": [String],        // æœç´¢å…³é”®è¯
  "created_at": Date,                 // åˆ›å»ºæ—¶é—´
  "updated_at": Date                  // æ›´æ–°æ—¶é—´
}
```

**ç´¢å¼•è®¾è®¡**ï¼š
```javascript
// æ–‡æœ¬ç´¢å¼•
db.food_database.createIndex({"food_name": "text", "search_keywords": "text"})

// æ™®é€šç´¢å¼•
db.food_database.createIndex({"food_category": 1})
db.food_database.createIndex({"food_subcategory": 1})
db.food_database.createIndex({"is_active": 1})
db.food_database.createIndex({"tags": 1})
db.food_database.createIndex({"created_at": -1})
```

### 2.7 è¿åŠ¨æ•°æ®åº“é›†åˆï¼ˆexercise_databaseï¼‰

**é›†åˆåç§°**ï¼š`exercise_database`  
**æè¿°**ï¼šå­˜å‚¨è¿åŠ¨ä¿¡æ¯æ•°æ®åº“

**å­—æ®µç»“æž„**ï¼š
```javascript
{
  "_id": ObjectId,                    // è¿åŠ¨IDï¼ˆä¸»é”®ï¼‰
  "exercise_name": String,            // è¿åŠ¨åç§°
  "exercise_category": String,        // è¿åŠ¨åˆ†ç±»ï¼šcardio/strength/flexibility/balance/sports
  "exercise_subcategory": String,     // è¿åŠ¨å­åˆ†ç±»
  "calories_per_hour": Number,        // æ¯å°æ—¶æ¶ˆè€—å¡è·¯é‡Œ
  "intensity_level": String,          // å¼ºåº¦ç­‰çº§ï¼šlow/medium/high
  "equipment_needed": [String],       // æ‰€éœ€å™¨æ
  "target_muscles": [String],         // ç›®æ ‡è‚Œç¾¤
  "difficulty_level": String,         // éš¾åº¦ç­‰çº§ï¼šbeginner/intermediate/advanced
  "duration_range": {                 // æŽ¨èæ—¶é•¿èŒƒå›´
    "min": Number,                    // æœ€å°æ—¶é•¿(åˆ†é’Ÿ)
    "max": Number,                    // æœ€å¤§æ—¶é•¿(åˆ†é’Ÿ)
    "recommended": Number             // æŽ¨èæ—¶é•¿(åˆ†é’Ÿ)
  },
  "instructions": String,             // è¿åŠ¨è¯´æ˜Ž
  "precautions": [String],           // æ³¨æ„äº‹é¡¹
  "benefits": [String],              // è¿åŠ¨ç›Šå¤„
  "video_url": String,                // æ•™å­¦è§†é¢‘
  "image_url": String,                // è¿åŠ¨å›¾ç‰‡
  "tags": [String],                   // æ ‡ç­¾
  "is_active": Boolean,               // æ˜¯å¦å¯ç”¨
  "search_keywords": [String],        // æœç´¢å…³é”®è¯
  "created_at": Date,                 // åˆ›å»ºæ—¶é—´
  "updated_at": Date                  // æ›´æ–°æ—¶é—´
}
```

**ç´¢å¼•è®¾è®¡**ï¼š
```javascript
// æ–‡æœ¬ç´¢å¼•
db.exercise_database.createIndex({"exercise_name": "text", "search_keywords": "text"})

// æ™®é€šç´¢å¼•
db.exercise_database.createIndex({"exercise_category": 1})
db.exercise_database.createIndex({"intensity_level": 1})
db.exercise_database.createIndex({"difficulty_level": 1})
db.exercise_database.createIndex({"is_active": 1})
db.exercise_database.createIndex({"tags": 1})
db.exercise_database.createIndex({"created_at": -1})
```

### 2.8 ç›®æ ‡è®¾å®šé›†åˆï¼ˆuser_goalsï¼‰

**é›†åˆåç§°**ï¼š`user_goals`  
**æè¿°**ï¼šå­˜å‚¨ç”¨æˆ·ç›®æ ‡è®¾å®šä¿¡æ¯

**å­—æ®µç»“æž„**ï¼š
```javascript
{
  "_id": ObjectId,                    // ç›®æ ‡IDï¼ˆä¸»é”®ï¼‰
  "user_id": ObjectId,                // ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰
  "goal_type": String,                // ç›®æ ‡ç±»åž‹ï¼šweight_loss/weight_gain/maintenance/muscle_gain
  "goal_name": String,                // ç›®æ ‡åç§°
  "target_weight": Number,            // ç›®æ ‡ä½“é‡(kg)
  "current_weight": Number,           // å½“å‰ä½“é‡(kg)
  "start_weight": Number,             // èµ·å§‹ä½“é‡(kg)
  "target_date": Date,                // ç›®æ ‡æ—¥æœŸ
  "weekly_loss_target": Number,       // æ¯å‘¨å‡é‡ç›®æ ‡(kg)
  "daily_calorie_target": Number,     // æ¯æ—¥çƒ­é‡ç›®æ ‡(kcal)
  "daily_protein_target": Number,     // æ¯æ—¥è›‹ç™½è´¨ç›®æ ‡(g)
  "daily_fat_target": Number,         // æ¯æ—¥è„‚è‚ªç›®æ ‡(g)
  "daily_carbs_target": Number,       // æ¯æ—¥ç¢³æ°´åŒ–åˆç‰©ç›®æ ‡(g)
  "exercise_minutes_target": Number,  // æ¯æ—¥è¿åŠ¨æ—¶é—´ç›®æ ‡(åˆ†é’Ÿ)
  "water_intake_target": Number,      // æ¯æ—¥é¥®æ°´ç›®æ ‡(ml)
  "steps_target": Number,             // æ¯æ—¥æ­¥æ•°ç›®æ ‡
  "status": String,                   // çŠ¶æ€ï¼šactive/completed/abandoned/paused
  "progress_percentage": Number,      // è¿›åº¦ç™¾åˆ†æ¯”
  "start_date": Date,                 // å¼€å§‹æ—¥æœŸ
  "end_date": Date,                   // ç»“æŸæ—¥æœŸ
  "notes": String,                    // å¤‡æ³¨
  "created_at": Date,                 // åˆ›å»ºæ—¶é—´
  "updated_at": Date                  // æ›´æ–°æ—¶é—´
}
```

**ç´¢å¼•è®¾è®¡**ï¼š
```javascript
// å¤åˆç´¢å¼•
db.user_goals.createIndex({"user_id": 1, "status": 1})
db.user_goals.createIndex({"user_id": 1, "goal_type": 1})

// æ™®é€šç´¢å¼•
db.user_goals.createIndex({"goal_type": 1})
db.user_goals.createIndex({"status": 1})
db.user_goals.createIndex({"target_date": 1})
db.user_goals.createIndex({"created_at": -1})
```

### 2.9 ç”¨æˆ·ç»Ÿè®¡é›†åˆï¼ˆuser_statisticsï¼‰

**é›†åˆåç§°**ï¼š`user_statistics`  
**æè¿°**ï¼šå­˜å‚¨ç”¨æˆ·æ¯æ—¥ç»Ÿè®¡æ•°æ®

**å­—æ®µç»“æž„**ï¼š
```javascript
{
  "_id": ObjectId,                    // ç»Ÿè®¡IDï¼ˆä¸»é”®ï¼‰
  "user_id": ObjectId,                // ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰
  "stat_date": Date,                  // ç»Ÿè®¡æ—¥æœŸ
  "total_calories": Number,           // æ€»çƒ­é‡(kcal)
  "total_protein": Number,            // æ€»è›‹ç™½è´¨(g)
  "total_fat": Number,                // æ€»è„‚è‚ª(g)
  "total_carbs": Number,              // æ€»ç¢³æ°´åŒ–åˆç‰©(g)
  "total_fiber": Number,              // æ€»è†³é£Ÿçº¤ç»´(g)
  "total_sugar": Number,              // æ€»ç³–åˆ†(g)
  "total_sodium": Number,             // æ€»é’ (mg)
  "total_exercise_minutes": Number,   // æ€»è¿åŠ¨æ—¶é—´(åˆ†é’Ÿ)
  "total_calories_burned": Number,    // æ€»æ¶ˆè€—çƒ­é‡(kcal)
  "weight_change": Number,            // ä½“é‡å˜åŒ–(kg)
  "steps_count": Number,              // æ­¥æ•°
  "water_intake": Number,             // é¥®æ°´é‡(ml)
  "sleep_hours": Number,              // ç¡çœ æ—¶é•¿(å°æ—¶)
  "meal_count": Number,               // é¤æ¬¡æ•°é‡
  "exercise_count": Number,           // è¿åŠ¨æ¬¡æ•°
  "weight_record_count": Number,      // ä½“é‡è®°å½•æ¬¡æ•°
  "ai_chat_count": Number,            // AIå¯¹è¯æ¬¡æ•°
  "goal_progress": {                  // ç›®æ ‡è¿›åº¦
    "weight_progress": Number,        // ä½“é‡ç›®æ ‡è¿›åº¦
    "calorie_progress": Number,       // çƒ­é‡ç›®æ ‡è¿›åº¦
    "exercise_progress": Number,      // è¿åŠ¨ç›®æ ‡è¿›åº¦
    "water_progress": Number          // é¥®æ°´ç›®æ ‡è¿›åº¦
  },
  "created_at": Date,                 // åˆ›å»ºæ—¶é—´
  "updated_at": Date                  // æ›´æ–°æ—¶é—´
}
```

**ç´¢å¼•è®¾è®¡**ï¼š
```javascript
// å¤åˆç´¢å¼•
db.user_statistics.createIndex({"user_id": 1, "stat_date": -1})
db.user_statistics.createIndex({"user_id": 1, "stat_date": 1})

// æ™®é€šç´¢å¼•
db.user_statistics.createIndex({"stat_date": -1})
db.user_statistics.createIndex({"total_calories": 1})
db.user_statistics.createIndex({"total_exercise_minutes": 1})
```

### 2.10 é€šçŸ¥é›†åˆï¼ˆnotificationsï¼‰

**é›†åˆåç§°**ï¼š`notifications`  
**æè¿°**ï¼šå­˜å‚¨ç³»ç»Ÿé€šçŸ¥ä¿¡æ¯

**å­—æ®µç»“æž„**ï¼š
```javascript
{
  "_id": ObjectId,                    // é€šçŸ¥IDï¼ˆä¸»é”®ï¼‰
  "user_id": ObjectId,                // ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰
  "advisor_id": ObjectId,             // å¥åº·é¡¾é—®IDï¼ˆå¤–é”®ï¼Œå¯é€‰ï¼‰
  "notification_type": String,        // é€šçŸ¥ç±»åž‹ï¼šsystem/reminder/advisor_message/achievement/alert
  "title": String,                    // é€šçŸ¥æ ‡é¢˜
  "content": String,                  // é€šçŸ¥å†…å®¹
  "image_url": String,                // é€šçŸ¥å›¾ç‰‡
  "action_url": String,               // ç‚¹å‡»è·³è½¬é“¾æŽ¥
  "action_type": String,              // æ“ä½œç±»åž‹ï¼šnavigate/open_url/open_modal
  "priority": String,                 // ä¼˜å…ˆçº§ï¼šlow/normal/high/urgent
  "is_read": Boolean,                 // æ˜¯å¦å·²è¯»
  "read_at": Date,                    // é˜…è¯»æ—¶é—´
  "is_sent": Boolean,                 // æ˜¯å¦å·²å‘é€
  "sent_at": Date,                    // å‘é€æ—¶é—´
  "scheduled_at": Date,               // è®¡åˆ’å‘é€æ—¶é—´
  "expire_at": Date,                  // è¿‡æœŸæ—¶é—´
  "created_at": Date,                 // åˆ›å»ºæ—¶é—´
  "updated_at": Date                  // æ›´æ–°æ—¶é—´
}
```

**ç´¢å¼•è®¾è®¡**ï¼š
```javascript
// å¤åˆç´¢å¼•
db.notifications.createIndex({"user_id": 1, "is_read": 1})
db.notifications.createIndex({"user_id": 1, "notification_type": 1})
db.notifications.createIndex({"user_id": 1, "created_at": -1})

// æ™®é€šç´¢å¼•
db.notifications.createIndex({"notification_type": 1})
db.notifications.createIndex({"priority": 1})
db.notifications.createIndex({"is_sent": 1})
db.notifications.createIndex({"scheduled_at": 1})
db.notifications.createIndex({"expire_at": 1})
```

### 2.11 ç”¨æˆ·åé¦ˆé›†åˆï¼ˆuser_feedbackï¼‰

**é›†åˆåç§°**ï¼š`user_feedback`  
**æè¿°**ï¼šå­˜å‚¨ç”¨æˆ·åé¦ˆä¿¡æ¯

**å­—æ®µç»“æž„**ï¼š
```javascript
{
  "_id": ObjectId,                    // åé¦ˆIDï¼ˆä¸»é”®ï¼‰
  "user_id": ObjectId,                // ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰
  "feedback_type": String,            // åé¦ˆç±»åž‹ï¼šbug/feature/suggestion/complaint/praise
  "category": String,                 // åé¦ˆåˆ†ç±»ï¼šapp/ai/advisor/payment/other
  "title": String,                    // åé¦ˆæ ‡é¢˜
  "content": String,                  // åé¦ˆå†…å®¹
  "rating": Number,                   // è¯„åˆ†ï¼ˆ1-5ï¼‰
  "images": [String],                 // å›¾ç‰‡URLæ•°ç»„
  "contact_info": {                   // è”ç³»ä¿¡æ¯
    "phone": String,                  // æ‰‹æœºå·
    "email": String                   // é‚®ç®±
  },
  "status": String,                   // çŠ¶æ€ï¼špending/processing/resolved/closed
  "priority": String,                 // ä¼˜å…ˆçº§ï¼šlow/normal/high/urgent
  "assigned_to": ObjectId,            // åˆ†é…ç»™è°
  "admin_reply": String,              // ç®¡ç†å‘˜å›žå¤
  "reply_at": Date,                   // å›žå¤æ—¶é—´
  "resolved_at": Date,                // è§£å†³æ—¶é—´
  "tags": [String],                   // æ ‡ç­¾
  "created_at": Date,                 // åˆ›å»ºæ—¶é—´
  "updated_at": Date                  // æ›´æ–°æ—¶é—´
}
```

**ç´¢å¼•è®¾è®¡**ï¼š
```javascript
// å¤åˆç´¢å¼•
db.user_feedback.createIndex({"user_id": 1, "status": 1})
db.user_feedback.createIndex({"feedback_type": 1, "status": 1})

// æ™®é€šç´¢å¼•
db.user_feedback.createIndex({"category": 1})
db.user_feedback.createIndex({"status": 1})
db.user_feedback.createIndex({"priority": 1})
db.user_feedback.createIndex({"assigned_to": 1})
db.user_feedback.createIndex({"created_at": -1})
```

### 2.12 ä¼šå‘˜è®°å½•è¡¨ï¼ˆmembership_recordsï¼‰

**è¡¨å**ï¼š`membership_records`  
**æè¿°**ï¼šå­˜å‚¨ç”¨æˆ·ä¼šå‘˜ç­‰çº§å˜æ›´è®°å½•

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `membership_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'è®°å½•IDï¼ˆä¸»é”®ï¼‰',
  `user_id` bigint unsigned NOT NULL COMMENT 'ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰',
  `old_level` enum('free','standard','premium') DEFAULT NULL COMMENT 'åŽŸä¼šå‘˜ç­‰çº§',
  `new_level` enum('free','standard','premium') NOT NULL COMMENT 'æ–°ä¼šå‘˜ç­‰çº§',
  `change_type` enum('upgrade','downgrade','renewal','expire') NOT NULL COMMENT 'å˜æ›´ç±»åž‹',
  `payment_id` bigint unsigned DEFAULT NULL COMMENT 'æ”¯ä»˜è®°å½•ID',
  `amount` decimal(10,2) DEFAULT NULL COMMENT 'æ”¯ä»˜é‡‘é¢',
  `effective_date` datetime NOT NULL COMMENT 'ç”Ÿæ•ˆæ—¶é—´',
  `expire_date` datetime DEFAULT NULL COMMENT 'åˆ°æœŸæ—¶é—´',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_created_at` (`user_id`, `created_at`),
  KEY `idx_change_type` (`change_type`),
  KEY `idx_effective_date` (`effective_date`),
  CONSTRAINT `fk_membership_records_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_membership_records_payment_id` FOREIGN KEY (`payment_id`) REFERENCES `payment_records` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ä¼šå‘˜è®°å½•è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å¤åˆç´¢å¼•
ALTER TABLE `membership_records` ADD KEY `idx_user_id_created_at` (`user_id`, `created_at`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `membership_records` ADD KEY `idx_change_type` (`change_type`);
ALTER TABLE `membership_records` ADD KEY `idx_effective_date` (`effective_date`);
```

### 2.13 å¥åº·é¡¾é—®æ”¶å…¥è®°å½•è¡¨ï¼ˆadvisor_income_recordsï¼‰

**è¡¨å**ï¼š`advisor_income_records`  
**æè¿°**ï¼šå­˜å‚¨å¥åº·é¡¾é—®æ”¶å…¥è®°å½•

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `advisor_income_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'è®°å½•IDï¼ˆä¸»é”®ï¼‰',
  `advisor_id` bigint unsigned NOT NULL COMMENT 'å¥åº·é¡¾é—®IDï¼ˆå¤–é”®ï¼‰',
  `income_type` enum('consultation','review','commission') NOT NULL COMMENT 'æ”¶å…¥ç±»åž‹',
  `amount` decimal(10,2) NOT NULL COMMENT 'æ”¶å…¥é‡‘é¢',
  `related_id` bigint unsigned DEFAULT NULL COMMENT 'å…³è”è®°å½•ID',
  `related_type` varchar(50) DEFAULT NULL COMMENT 'å…³è”è®°å½•ç±»åž‹',
  `description` varchar(500) DEFAULT NULL COMMENT 'æ”¶å…¥æè¿°',
  `status` enum('pending','paid','cancelled') DEFAULT 'pending' COMMENT 'çŠ¶æ€',
  `paid_at` datetime DEFAULT NULL COMMENT 'æ”¯ä»˜æ—¶é—´',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_advisor_id_created_at` (`advisor_id`, `created_at`),
  KEY `idx_income_type` (`income_type`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_advisor_income_records_advisor_id` FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å¥åº·é¡¾é—®æ”¶å…¥è®°å½•è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å¤åˆç´¢å¼•
ALTER TABLE `advisor_income_records` ADD KEY `idx_advisor_id_created_at` (`advisor_id`, `created_at`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `advisor_income_records` ADD KEY `idx_income_type` (`income_type`);
ALTER TABLE `advisor_income_records` ADD KEY `idx_status` (`status`);
```

### 2.14 å®¡è®¡æ—¥å¿—è¡¨ï¼ˆaudit_logsï¼‰

**è¡¨å**ï¼š`audit_logs`  
**æè¿°**ï¼šå­˜å‚¨ç³»ç»Ÿå®¡è®¡æ—¥å¿—

**è¡¨ç»“æž„**ï¼š
```sql
CREATE TABLE `audit_logs` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'å®¡è®¡æ—¥å¿—IDï¼ˆä¸»é”®ï¼‰',
  `user_id` bigint unsigned DEFAULT NULL COMMENT 'æ“ä½œç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰',
  `advisor_id` bigint unsigned DEFAULT NULL COMMENT 'å¥åº·é¡¾é—®IDï¼ˆå¯é€‰ï¼‰',
  `action` enum('create','update','delete','login','logout') NOT NULL COMMENT 'æ“ä½œç±»åž‹',
  `resource_type` varchar(50) NOT NULL COMMENT 'èµ„æºç±»åž‹',
  `resource_id` bigint unsigned NOT NULL COMMENT 'èµ„æºID',
  `old_value` json DEFAULT NULL COMMENT 'ä¿®æ”¹å‰å€¼',
  `new_value` json DEFAULT NULL COMMENT 'ä¿®æ”¹åŽå€¼',
  `changed_fields` json DEFAULT NULL COMMENT 'å˜æ›´å­—æ®µ',
  `ip_address` varchar(45) DEFAULT NULL COMMENT 'IPåœ°å€',
  `user_agent` varchar(500) DEFAULT NULL COMMENT 'ç”¨æˆ·ä»£ç†',
  `session_id` varchar(100) DEFAULT NULL COMMENT 'ä¼šè¯ID',
  `request_id` varchar(100) DEFAULT NULL COMMENT 'è¯·æ±‚ID',
  `execution_time` int unsigned DEFAULT NULL COMMENT 'æ‰§è¡Œæ—¶é—´(ms)',
  `status` enum('success','failed') NOT NULL COMMENT 'æ“ä½œçŠ¶æ€',
  `error_message` text DEFAULT NULL COMMENT 'é”™è¯¯ä¿¡æ¯',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_created_at` (`user_id`, `created_at`),
  KEY `idx_advisor_id_created_at` (`advisor_id`, `created_at`),
  KEY `idx_resource_type_resource_id` (`resource_type`, `resource_id`),
  KEY `idx_action` (`action`),
  KEY `idx_status` (`status`),
  KEY `idx_ip_address` (`ip_address`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_audit_logs_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_audit_logs_advisor_id` FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å®¡è®¡æ—¥å¿—è¡¨';
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å¤åˆç´¢å¼•
ALTER TABLE `audit_logs` ADD KEY `idx_user_id_created_at` (`user_id`, `created_at`);
ALTER TABLE `audit_logs` ADD KEY `idx_advisor_id_created_at` (`advisor_id`, `created_at`);
ALTER TABLE `audit_logs` ADD KEY `idx_resource_type_resource_id` (`resource_type`, `resource_id`);

-- æ™®é€šç´¢å¼•
ALTER TABLE `audit_logs` ADD KEY `idx_action` (`action`);
ALTER TABLE `audit_logs` ADD KEY `idx_status` (`status`);
ALTER TABLE `audit_logs` ADD KEY `idx_ip_address` (`ip_address`);
ALTER TABLE `audit_logs` ADD KEY `idx_created_at` (`created_at`);
```

---

## 3. æ•°æ®å…³ç³»è®¾è®¡

### 3.1 å®žä½“å…³ç³»å›¾

```
ç”¨æˆ·(users) 1:N ä½“é‡è®°å½•(weight_records)
ç”¨æˆ·(users) 1:N é¥®é£Ÿè®°å½•(diet_records)
ç”¨æˆ·(users) 1:N è¿åŠ¨è®°å½•(exercise_records)
ç”¨æˆ·(users) 1:N AIæ–¹æ¡ˆ(ai_plans)
ç”¨æˆ·(users) 1:N èŠå¤©è®°å½•(chat_messages)
ç”¨æˆ·(users) 1:N æ”¯ä»˜è®°å½•(payment_records)
ç”¨æˆ·(users) 1:N ä¼šå‘˜è®°å½•(membership_records)
ç”¨æˆ·(users) 1:N ç›®æ ‡è®¾å®š(user_goals)
ç”¨æˆ·(users) 1:N ç”¨æˆ·ç»Ÿè®¡(user_statistics)
ç”¨æˆ·(users) 1:N é€šçŸ¥(notifications)
ç”¨æˆ·(users) 1:N ç”¨æˆ·åé¦ˆ(user_feedback)
ç”¨æˆ·(users) 1:N å®¡è®¡æ—¥å¿—(audit_logs)

å¥åº·é¡¾é—®(advisors) 1:N ç”¨æˆ·(users)
å¥åº·é¡¾é—®(advisors) 1:N AIæ–¹æ¡ˆ(ai_plans)
å¥åº·é¡¾é—®(advisors) 1:N å®¡æ ¸è®°å½•(review_records)
å¥åº·é¡¾é—®(advisors) 1:N èŠå¤©è®°å½•(chat_messages)
å¥åº·é¡¾é—®(advisors) 1:N é€šçŸ¥(notifications)
å¥åº·é¡¾é—®(advisors) 1:N æ”¶å…¥è®°å½•(advisor_income_records)
å¥åº·é¡¾é—®(advisors) 1:N å®¡è®¡æ—¥å¿—(audit_logs)

é£Ÿç‰©æ•°æ®åº“(food_database) 1:N é¥®é£Ÿè®°å½•(diet_records)
è¿åŠ¨æ•°æ®åº“(exercise_database) 1:N è¿åŠ¨è®°å½•(exercise_records)

AIæ–¹æ¡ˆ(ai_plans) 1:1 å®¡æ ¸è®°å½•(review_records)
AIæ–¹æ¡ˆ(ai_plans) 1:1 ç›®æ ‡è®¾å®š(user_goals)

æ”¯ä»˜è®°å½•(payment_records) 1:1 ä¼šå‘˜è®°å½•(membership_records)
```

### 3.2 å¤–é”®çº¦æŸ

MySQLä½¿ç”¨å¤–é”®çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§ï¼š

1. **ç”¨æˆ·åˆ é™¤æ—¶**ï¼š
   - çº§è”åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰ä½“é‡è®°å½•ï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰é¥®é£Ÿè®°å½•ï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰è¿åŠ¨è®°å½•ï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰AIæ–¹æ¡ˆï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰èŠå¤©è®°å½•ï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰æ”¯ä»˜è®°å½•ï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰ç›®æ ‡è®¾å®šï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰é€šçŸ¥ï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰åé¦ˆï¼ˆCASCADEï¼‰

2. **å¥åº·é¡¾é—®åˆ é™¤æ—¶**ï¼š
   - å°†å…³è”ç”¨æˆ·çš„advisor_idè®¾ä¸ºnullï¼ˆSET NULLï¼‰
   - çº§è”åˆ é™¤å¥åº·é¡¾é—®çš„æ‰€æœ‰å®¡æ ¸è®°å½•ï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤å¥åº·é¡¾é—®çš„æ‰€æœ‰èŠå¤©è®°å½•ï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤å¥åº·é¡¾é—®çš„æ‰€æœ‰é€šçŸ¥ï¼ˆCASCADEï¼‰
   - çº§è”åˆ é™¤å¥åº·é¡¾é—®çš„æ‰€æœ‰æ”¶å…¥è®°å½•ï¼ˆCASCADEï¼‰

3. **AIæ–¹æ¡ˆåˆ é™¤æ—¶**ï¼š
   - çº§è”åˆ é™¤å…³è”çš„å®¡æ ¸è®°å½•ï¼ˆCASCADEï¼‰
   - æ›´æ–°å…³è”çš„ç›®æ ‡è®¾å®šçŠ¶æ€

4. **æ”¯ä»˜è®°å½•åˆ é™¤æ—¶**ï¼š
   - å°†å…³è”çš„ä¼šå‘˜è®°å½•payment_idè®¾ä¸ºnullï¼ˆSET NULLï¼‰

5. **é£Ÿç‰©/è¿åŠ¨æ•°æ®åº“åˆ é™¤æ—¶**ï¼š
   - å°†ç›¸å…³è®°å½•çš„é£Ÿç‰©/è¿åŠ¨IDè®¾ä¸ºnullï¼ˆSET NULLï¼‰
   - ä¿ç•™åŽ†å²è®°å½•ä½†æ ‡è®°ä¸ºæ— æ•ˆ

---

## 4. æ•°æ®åˆ†è¡¨ç­–ç•¥

### 4.1 æŒ‰æ—¶é—´åˆ†è¡¨

ä¸ºäº†æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œä»¥ä¸‹é›†åˆæŒ‰æ—¶é—´åˆ†è¡¨ï¼š

1. **ä½“é‡è®°å½•åˆ†è¡¨**ï¼š
   - æŒ‰æœˆåˆ†è¡¨ï¼š`weight_records_202508`
   - ä¿ç•™æœ€è¿‘12ä¸ªæœˆçš„æ•°æ®

2. **é¥®é£Ÿè®°å½•åˆ†è¡¨**ï¼š
   - æŒ‰æœˆåˆ†è¡¨ï¼š`diet_records_202508`
   - ä¿ç•™æœ€è¿‘12ä¸ªæœˆçš„æ•°æ®

3. **è¿åŠ¨è®°å½•åˆ†è¡¨**ï¼š
   - æŒ‰æœˆåˆ†è¡¨ï¼š`exercise_records_202508`
   - ä¿ç•™æœ€è¿‘12ä¸ªæœˆçš„æ•°æ®

4. **èŠå¤©è®°å½•åˆ†è¡¨**ï¼š
   - æŒ‰æœˆåˆ†è¡¨ï¼š`chat_messages_202508`
   - ä¿ç•™æœ€è¿‘6ä¸ªæœˆçš„æ•°æ®

5. **ç”¨æˆ·ç»Ÿè®¡åˆ†è¡¨**ï¼š
   - æŒ‰æœˆåˆ†è¡¨ï¼š`user_statistics_202508`
   - ä¿ç•™æœ€è¿‘24ä¸ªæœˆçš„æ•°æ®

6. **æ“ä½œæ—¥å¿—åˆ†è¡¨**ï¼š
   - æŒ‰æœˆåˆ†è¡¨ï¼š`operation_logs_202508`
   - ä¿ç•™æœ€è¿‘3ä¸ªæœˆçš„æ•°æ®

7. **å®¡è®¡æ—¥å¿—åˆ†è¡¨**ï¼š
   - æŒ‰æœˆåˆ†è¡¨ï¼š`audit_logs_202508`
   - ä¿ç•™æœ€è¿‘6ä¸ªæœˆçš„æ•°æ®

### 4.2 åˆ†è¡¨è§„åˆ™

```sql
-- èŽ·å–è¡¨åçš„å‡½æ•°
DELIMITER $$
CREATE FUNCTION getTableName(baseName VARCHAR(50), dateParam DATE) 
RETURNS VARCHAR(100)
DETERMINISTIC
BEGIN
    DECLARE yearStr VARCHAR(4);
    DECLARE monthStr VARCHAR(2);
    DECLARE tableName VARCHAR(100);
    
    SET yearStr = YEAR(dateParam);
    SET monthStr = LPAD(MONTH(dateParam), 2, '0');
    SET tableName = CONCAT(baseName, '_', yearStr, monthStr);
    
    RETURN tableName;
END$$
DELIMITER ;

-- åˆ›å»ºåˆ†è¡¨çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE createMonthlyTable(IN baseTableName VARCHAR(50), IN targetDate DATE)
BEGIN
    DECLARE tableName VARCHAR(100);
    DECLARE sqlStatement TEXT;
    
    SET tableName = getTableName(baseTableName, targetDate);
    
    -- æ£€æŸ¥è¡¨æ˜¯å¦å·²å­˜åœ¨
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = tableName) THEN
        SET sqlStatement = CONCAT('CREATE TABLE ', tableName, ' LIKE ', baseTableName);
        SET @sql = sqlStatement;
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
        SELECT CONCAT('Created table: ', tableName) as result;
    ELSE
        SELECT CONCAT('Table already exists: ', tableName) as result;
    END IF;
END$$
DELIMITER ;

-- ä½¿ç”¨ç¤ºä¾‹
CALL createMonthlyTable('weight_records', CURDATE());
SELECT getTableName('weight_records', CURDATE());
```

---

## 5. æ•°æ®å®‰å…¨è®¾è®¡

### 5.1 æ•°æ®åŠ å¯†

1. **æ•æ„Ÿä¿¡æ¯åŠ å¯†**ï¼š
   - ç”¨æˆ·çœŸå®žå§“åï¼šAES-256åŠ å¯†
   - ç”¨æˆ·æ‰‹æœºå·ï¼šAES-256åŠ å¯†
   - ç”¨æˆ·é‚®ç®±ï¼šAES-256åŠ å¯†
   - å¥åº·é¡¾é—®èº«ä»½è¯å·ï¼šAES-256åŠ å¯†
   - å¥åº·é¡¾é—®æ‰‹æœºå·ï¼šAES-256åŠ å¯†
   - æ”¯ä»˜ä¿¡æ¯ï¼šå¾®ä¿¡æ”¯ä»˜åŠ å¯†

2. **æ•°æ®è„±æ•**ï¼š
   - ç”¨æˆ·å§“åæ˜¾ç¤ºï¼š`æŽXæ˜Ž`
   - æ‰‹æœºå·æ˜¾ç¤ºï¼š`138****8888`
   - èº«ä»½è¯å·æ˜¾ç¤ºï¼š`110***********1234`
   - é‚®ç®±æ˜¾ç¤ºï¼š`a***@example.com`

### 5.2 è®¿é—®æŽ§åˆ¶

1. **ç”¨æˆ·æ•°æ®éš”ç¦»**ï¼š
   - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
   - å¥åº·é¡¾é—®åªèƒ½è®¿é—®å…³è”ç”¨æˆ·çš„æ•°æ®
   - ç®¡ç†å‘˜åªèƒ½è®¿é—®åŒ¿ååŒ–æ•°æ®

2. **æƒé™éªŒè¯**ï¼š
   - APIæŽ¥å£å¿…é¡»éªŒè¯ç”¨æˆ·èº«ä»½
   - æ•°æ®åº“æŸ¥è¯¢å¿…é¡»åŒ…å«ç”¨æˆ·IDè¿‡æ»¤
   - æ•æ„Ÿæ“ä½œéœ€è¦äºŒæ¬¡éªŒè¯

### 5.3 æ•°æ®è„±æ•è§†å›¾

**ç”¨æˆ·æ•°æ®è„±æ•è§†å›¾**ï¼š
```sql
CREATE VIEW `users_desensitized` AS
SELECT 
  id,
  openid,
  CONCAT(LEFT(nickname, 1), '***', RIGHT(nickname, 1)) as nickname,
  CONCAT(LEFT(phone, 3), '****', RIGHT(phone, 4)) as phone,
  CONCAT(LEFT(email, 1), '***@', SUBSTRING_INDEX(email, '@', -1)) as email,
  gender,
  age,
  height,
  current_weight,
  target_weight,
  bmi,
  occupation,
  activity_level,
  health_goals,
  medical_history,
  dietary_restrictions,
  allergies,
  preferred_language,
  timezone,
  advisor_id,
  member_level,
  member_expire,
  status,
  notification_settings,
  privacy_settings,
  last_login,
  login_count,
  created_at,
  updated_at
FROM users;
```

### 5.3 æ•°æ®å¤‡ä»½

1. **è‡ªåŠ¨å¤‡ä»½**ï¼š
   - æ¯æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½
   - ä¿ç•™30å¤©çš„å¤‡ä»½æ–‡ä»¶
   - å¼‚åœ°å¤‡ä»½å­˜å‚¨

2. **å¢žé‡å¤‡ä»½**ï¼š
   - æ¯å°æ—¶å¢žé‡å¤‡ä»½
   - ä¿ç•™7å¤©çš„å¢žé‡å¤‡ä»½
   - å®žæ—¶åŒæ­¥å…³é”®æ•°æ®

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 ç´¢å¼•ä¼˜åŒ–

1. **å¤åˆç´¢å¼•**ï¼š
   - ç”¨æˆ·ID + æ—¶é—´ï¼šæé«˜æ—¶é—´èŒƒå›´æŸ¥è¯¢æ€§èƒ½
   - ç”¨æˆ·ID + çŠ¶æ€ï¼šæé«˜çŠ¶æ€ç­›é€‰æ€§èƒ½
   - èµ„æºç±»åž‹ + èµ„æºIDï¼šæé«˜å®¡è®¡æŸ¥è¯¢æ€§èƒ½

2. **è¦†ç›–ç´¢å¼•**ï¼š
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºè¦†ç›–ç´¢å¼•
   - å‡å°‘å›žè¡¨æŸ¥è¯¢
   - ä¼˜åŒ–èšåˆæŸ¥è¯¢æ€§èƒ½

3. **æ–‡æœ¬ç´¢å¼•**ï¼š
   - é£Ÿç‰©æ•°æ®åº“æ–‡æœ¬æœç´¢
   - è¿åŠ¨æ•°æ®åº“æ–‡æœ¬æœç´¢
   - ç”¨æˆ·åé¦ˆå†…å®¹æœç´¢

### 6.2 æŸ¥è¯¢ä¼˜åŒ–

1. **åˆ†é¡µæŸ¥è¯¢**ï¼š
   - ä½¿ç”¨skipå’Œlimitè¿›è¡Œåˆ†é¡µ
   - å¤§æ•°æ®é‡æ—¶ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ
   - é¿å…æ·±åº¦åˆ†é¡µé—®é¢˜

2. **èšåˆæŸ¥è¯¢**ï¼š
   - ä½¿ç”¨MongoDBèšåˆç®¡é“
   - åˆç†ä½¿ç”¨$matchã€$groupã€$sort
   - åˆ©ç”¨ç´¢å¼•ä¼˜åŒ–èšåˆæŸ¥è¯¢

### 6.3 ç¼“å­˜ç­–ç•¥

1. **Redisç¼“å­˜é”®ç»“æž„**ï¼š
```javascript
const CACHE_KEYS = {
  // ç”¨æˆ·ç›¸å…³
  USER_INFO: 'user:{userId}',
  USER_STATS: 'stats:{userId}:{date}',
  USER_GOALS: 'goals:{userId}',
  
  // å¥åº·é¡¾é—®ç›¸å…³
  ADVISOR_INFO: 'advisor:{advisorId}',
  ADVISOR_PATIENTS: 'advisor_patients:{advisorId}',
  
  // æ•°æ®åº“ç›¸å…³
  FOOD_DATABASE: 'food:{foodId}',
  EXERCISE_DATABASE: 'exercise:{exerciseId}',
  
  // ç³»ç»Ÿé…ç½®
  SYSTEM_CONFIG: 'config:{key}',
  
  // ç»Ÿè®¡æ•°æ®
  DAILY_STATS: 'daily_stats:{userId}:{date}',
  WEEKLY_STATS: 'weekly_stats:{userId}:{week}',
  MONTHLY_STATS: 'monthly_stats:{userId}:{month}'
};
```

2. **ç¼“å­˜æ›´æ–°ç­–ç•¥**ï¼š
   - æ•°æ®å˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°ç¼“å­˜
   - è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
   - ç¼“å­˜é¢„çƒ­æœºåˆ¶
   - ç¼“å­˜ç©¿é€ä¿æŠ¤

3. **ç¼“å­˜è¿‡æœŸæ—¶é—´**ï¼š
```javascript
const CACHE_TTL = {
  USER_INFO: 3600,           // 1å°æ—¶
  ADVISOR_INFO: 3600,        // 1å°æ—¶
  FOOD_DATABASE: 86400,      // 24å°æ—¶
  EXERCISE_DATABASE: 86400,  // 24å°æ—¶
  SYSTEM_CONFIG: 3600,       // 1å°æ—¶
  DAILY_STATS: 300,          // 5åˆ†é’Ÿ
  WEEKLY_STATS: 3600,        // 1å°æ—¶
  MONTHLY_STATS: 86400       // 24å°æ—¶
};
```

---

## 7. æ•°æ®éªŒè¯è§„åˆ™

### 7.1 ç”¨æˆ·æ•°æ®éªŒè¯

```javascript
// ç”¨æˆ·æ•°æ®éªŒè¯
function validateUser(user) {
  const errors = [];
  
  if (!user.openid) {
    errors.push("openid is required");
  }
  
  if (user.age < 18 || user.age > 100) {
    errors.push("age must be between 18 and 100");
  }
  
  if (user.height < 100 || user.height > 250) {
    errors.push("height must be between 100 and 250");
  }
  
  if (user.current_weight < 30 || user.current_weight > 300) {
    errors.push("current_weight must be between 30 and 300");
  }
  
  if (user.bmi < 10 || user.bmi > 50) {
    errors.push("bmi must be between 10 and 50");
  }
  
  const validStatuses = ['active', 'inactive', 'blocked', 'pending'];
  if (!validStatuses.includes(user.status)) {
    errors.push("status must be one of: " + validStatuses.join(', '));
  }
  
  const validMemberLevels = ['free', 'standard', 'premium'];
  if (!validMemberLevels.includes(user.member_level)) {
    errors.push("member_level must be one of: " + validMemberLevels.join(', '));
  }
  
  const validActivityLevels = ['sedentary', 'light', 'moderate', 'active'];
  if (!validActivityLevels.includes(user.activity_level)) {
    errors.push("activity_level must be one of: " + validActivityLevels.join(', '));
  }
  
  return errors;
}
```

### 7.2 ä½“é‡è®°å½•éªŒè¯

```javascript
// ä½“é‡è®°å½•éªŒè¯
function validateWeightRecord(record) {
  const errors = [];
  
  if (!record.user_id) {
    errors.push("user_id is required");
  }
  
  if (record.weight < 30 || record.weight > 300) {
    errors.push("weight must be between 30 and 300");
  }
  
  if (record.bmi < 10 || record.bmi > 50) {
    errors.push("bmi must be between 10 and 50");
  }
  
  const validRecordTypes = ['manual', 'photo', 'auto'];
  if (!validRecordTypes.includes(record.record_type)) {
    errors.push("record_type must be one of: " + validRecordTypes.join(', '));
  }
  
  return errors;
}
```

### 7.3 é¥®é£Ÿè®°å½•éªŒè¯

```javascript
// é¥®é£Ÿè®°å½•éªŒè¯
function validateDietRecord(record) {
  const errors = [];
  
  if (!record.user_id) {
    errors.push("user_id is required");
  }
  
  if (record.calories < 0 || record.calories > 10000) {
    errors.push("calories must be between 0 and 10000");
  }
  
  if (record.protein < 0 || record.protein > 1000) {
    errors.push("protein must be between 0 and 1000");
  }
  
  if (record.fat < 0 || record.fat > 1000) {
    errors.push("fat must be between 0 and 1000");
  }
  
  if (record.carbs < 0 || record.carbs > 1000) {
    errors.push("carbs must be between 0 and 1000");
  }
  
  const validMealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
  if (!validMealTypes.includes(record.meal_type)) {
    errors.push("meal_type must be one of: " + validMealTypes.join(', '));
  }
  
  const validRecordTypes = ['manual', 'photo', 'ai'];
  if (!validRecordTypes.includes(record.record_type)) {
    errors.push("record_type must be one of: " + validRecordTypes.join(', '));
  }
  
  return errors;
}
```

### 7.4 è¿åŠ¨è®°å½•éªŒè¯

```javascript
// è¿åŠ¨è®°å½•éªŒè¯
function validateExerciseRecord(record) {
  const errors = [];
  
  if (!record.user_id) {
    errors.push("user_id is required");
  }
  
  if (record.duration < 1 || record.duration > 480) {
    errors.push("duration must be between 1 and 480 minutes");
  }
  
  if (record.calories_burned < 0 || record.calories_burned > 5000) {
    errors.push("calories_burned must be between 0 and 5000");
  }
  
  const validIntensities = ['low', 'medium', 'high'];
  if (!validIntensities.includes(record.intensity)) {
    errors.push("intensity must be one of: " + validIntensities.join(', '));
  }
  
  const validRecordTypes = ['manual', 'photo', 'auto'];
  if (!validRecordTypes.includes(record.record_type)) {
    errors.push("record_type must be one of: " + validRecordTypes.join(', '));
  }
  
  return errors;
}
```

### 9.3 å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

```sql
-- èŽ·å–ç”¨æˆ·ä½“é‡è¶‹åŠ¿
SELECT 
    DATE(record_date) as date,
    AVG(weight) as avg_weight,
    AVG(bmi) as avg_bmi
FROM weight_records 
WHERE user_id = ? 
GROUP BY DATE(record_date) 
ORDER BY date;

-- èŽ·å–ç”¨æˆ·æ¯æ—¥çƒ­é‡ç»Ÿè®¡
SELECT 
    DATE(record_date) as date,
    SUM(calories) as total_calories,
    SUM(protein) as total_protein,
    SUM(fat) as total_fat,
    SUM(carbs) as total_carbs
FROM diet_records 
WHERE user_id = ? 
GROUP BY DATE(record_date) 
ORDER BY date;

-- èŽ·å–å¥åº·é¡¾é—®çš„æ‚£è€…åˆ—è¡¨
SELECT 
    nickname, 
    current_weight, 
    bmi, 
    last_login
FROM users 
WHERE advisor_id = ? AND status = 'active' 
ORDER BY last_login DESC;

-- èŽ·å–ç”¨æˆ·ç›®æ ‡è¿›åº¦
SELECT 
    ug.goal_name,
    ug.target_weight,
    ug.current_weight,
    ug.progress_percentage,
    wr.weight as latest_weight
FROM user_goals ug
LEFT JOIN weight_records wr ON ug.user_id = wr.user_id
WHERE ug.user_id = ? AND ug.status = 'active'
ORDER BY wr.record_date DESC
LIMIT 1;

-- èŽ·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®
SELECT 
    AVG(total_calories) as avg_calories,
    AVG(total_exercise_minutes) as avg_exercise_minutes,
    SUM(weight_change) as total_weight_change
FROM user_statistics 
WHERE user_id = ? 
ORDER BY stat_date DESC 
LIMIT 30;

-- æœç´¢é£Ÿç‰©æ•°æ®åº“
SELECT 
    food_name,
    food_category,
    calories_per_100g,
    protein_per_100g,
    fat_per_100g,
    carbs_per_100g
FROM food_database 
WHERE MATCH(food_name, search_keywords) AGAINST('è‹¹æžœ' IN NATURAL LANGUAGE MODE)
AND is_active = 1
ORDER BY MATCH(food_name, search_keywords) AGAINST('è‹¹æžœ' IN NATURAL LANGUAGE MODE) DESC;

-- èŽ·å–å¾…å®¡æ ¸çš„AIæ–¹æ¡ˆ
SELECT 
    plan_name, 
    user_id, 
    created_at
FROM ai_plans 
WHERE status = 'pending' 
ORDER BY created_at;

-- èŽ·å–ç”¨æˆ·æœªè¯»é€šçŸ¥
SELECT 
    title, 
    content, 
    notification_type, 
    created_at
FROM notifications 
WHERE user_id = ? AND is_read = 0 
ORDER BY created_at DESC;

-- èŽ·å–ç”¨æˆ·ä¼šå‘˜å˜æ›´è®°å½•
SELECT 
    old_level,
    new_level,
    change_type,
    amount,
    effective_date,
    expire_date
FROM membership_records 
WHERE user_id = ? 
ORDER BY created_at DESC;

-- èŽ·å–å¥åº·é¡¾é—®æ”¶å…¥ç»Ÿè®¡
SELECT 
    income_type,
    SUM(amount) as total_amount,
    COUNT(*) as record_count
FROM advisor_income_records 
WHERE advisor_id = ? AND status = 'paid'
GROUP BY income_type;

-- èŽ·å–å¾…å®¡æ ¸çš„AIæ–¹æ¡ˆï¼ˆåŒ…å«å®¡æ ¸äººä¿¡æ¯ï¼‰
SELECT 
    ap.plan_name, 
    ap.user_id,
    ap.created_at,
    a.name as advisor_name
FROM ai_plans ap
LEFT JOIN advisors a ON ap.reviewed_by = a.id
WHERE ap.status = 'pending' 
ORDER BY ap.created_at;
```

---

## 8. æ•°æ®è¿ç§»ç­–ç•¥

### 8.1 ç‰ˆæœ¬å‡çº§

1. **æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†**ï¼š
   - è®°å½•æ¯æ¬¡æ•°æ®åº“ç»“æž„å˜æ›´
   - æä¾›æ•°æ®è¿ç§»è„šæœ¬
   - ç‰ˆæœ¬å·ç®¡ç†ï¼šv1.0.0

2. **å‘åŽå…¼å®¹**ï¼š
   - æ–°ç‰ˆæœ¬ä¿æŒå‘åŽå…¼å®¹
   - é€æ­¥åºŸå¼ƒæ—§å­—æ®µ
   - å­—æ®µé‡å‘½åç­–ç•¥

### 8.2 æ•°æ®æ¸…ç†

1. **è¿‡æœŸæ•°æ®æ¸…ç†**ï¼š
   - å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
   - ä¿ç•™å¿…è¦çš„ç»Ÿè®¡æ•°æ®
   - æ•°æ®å½’æ¡£ç­–ç•¥

2. **æ•°æ®å½’æ¡£**ï¼š
   - å°†åŽ†å²æ•°æ®å½’æ¡£åˆ°å†·å­˜å‚¨
   - å‡å°‘ä¸»æ•°æ®åº“åŽ‹åŠ›
   - å½’æ¡£æ•°æ®æ¢å¤æœºåˆ¶

---

## 9. ç›‘æŽ§å’Œå‘Šè­¦

### 9.1 æ€§èƒ½ç›‘æŽ§

1. **æŸ¥è¯¢æ€§èƒ½**ï¼š
   - ç›‘æŽ§æ…¢æŸ¥è¯¢ï¼ˆ>100msï¼‰
   - ç›‘æŽ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ
   - æŸ¥è¯¢é¢‘çŽ‡ç»Ÿè®¡

2. **å­˜å‚¨ç›‘æŽ§**ï¼š
   - ç›‘æŽ§æ•°æ®åº“å¤§å°
   - ç›‘æŽ§ç£ç›˜ä½¿ç”¨çŽ‡
   - è¿žæŽ¥æ•°ç›‘æŽ§

### 9.2 ä¸šåŠ¡ç›‘æŽ§

1. **æ•°æ®è´¨é‡**ï¼š
   - ç›‘æŽ§æ•°æ®å®Œæ•´æ€§
   - ç›‘æŽ§æ•°æ®ä¸€è‡´æ€§
   - æ•°æ®å¼‚å¸¸æ£€æµ‹

2. **ä¸šåŠ¡æŒ‡æ ‡**ï¼š
   - ç›‘æŽ§ç”¨æˆ·æ´»è·ƒåº¦
   - ç›‘æŽ§ç³»ç»Ÿä½¿ç”¨æƒ…å†µ
   - å…³é”®ä¸šåŠ¡æŒ‡æ ‡ç›‘æŽ§

### 9.3 å®‰å…¨ç›‘æŽ§

1. **è®¿é—®ç›‘æŽ§**ï¼š
   - å¼‚å¸¸ç™»å½•æ£€æµ‹
   - æƒé™å˜æ›´ç›‘æŽ§
   - æ•æ„Ÿæ“ä½œå®¡è®¡

2. **æ•°æ®å®‰å…¨**ï¼š
   - æ•°æ®æ³„éœ²æ£€æµ‹
   - åŠ å¯†çŠ¶æ€ç›‘æŽ§
   - å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥

---

## 10. é™„å½•

### 10.1 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS weight_management 
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE weight_management;

-- åˆ›å»ºè¡¨ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰
-- 1. å¥åº·é¡¾é—®è¡¨ï¼ˆæ— å¤–é”®ä¾èµ–ï¼‰
CREATE TABLE `advisors` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'å¥åº·é¡¾é—®IDï¼ˆä¸»é”®ï¼‰',
  `name` varchar(100) NOT NULL COMMENT 'å§“å',
  `avatar` varchar(500) DEFAULT NULL COMMENT 'å¤´åƒURL',
  `phone` varchar(20) NOT NULL COMMENT 'æ‰‹æœºå·ï¼ˆåŠ å¯†ï¼‰',
  `email` varchar(100) DEFAULT NULL COMMENT 'é‚®ç®±',
  `id_card` varchar(20) DEFAULT NULL COMMENT 'èº«ä»½è¯å·ï¼ˆåŠ å¯†ï¼‰',
  `license_number` varchar(50) DEFAULT NULL COMMENT 'æ‰§ä¸šè¯ä¹¦å·',
  `specialty` json DEFAULT NULL COMMENT 'ä¸“ä¸šé¢†åŸŸæ•°ç»„',
  `specialization` json DEFAULT NULL COMMENT 'ä¸“ä¸šç‰¹é•¿',
  `qualification` varchar(200) DEFAULT NULL COMMENT 'èµ„è´¨è¯ä¹¦',
  `education` varchar(100) DEFAULT NULL COMMENT 'å­¦åŽ†',
  `work_experience` text DEFAULT NULL COMMENT 'å·¥ä½œç»åŽ†',
  `hospital` varchar(200) DEFAULT NULL COMMENT 'åˆä½œåŒ»é™¢',
  `description` text DEFAULT NULL COMMENT 'ä¸“ä¸šæè¿°',
  `experience_years` tinyint unsigned DEFAULT NULL COMMENT 'ä»Žä¸šå¹´é™',
  `consultation_fee` int unsigned DEFAULT 0 COMMENT 'å’¨è¯¢è´¹ç”¨ï¼ˆåˆ†ï¼‰',
  `user_count` int unsigned DEFAULT 0 COMMENT 'æœåŠ¡ç”¨æˆ·æ•°',
  `rating` decimal(2,1) DEFAULT NULL COMMENT 'è¯„åˆ†ï¼ˆ1-5ï¼‰',
  `total_income` bigint unsigned DEFAULT 0 COMMENT 'æ€»æ”¶å…¥ï¼ˆåˆ†ï¼‰',
  `monthly_income` bigint unsigned DEFAULT 0 COMMENT 'æœˆæ”¶å…¥ï¼ˆåˆ†ï¼‰',
  `status` enum('active','inactive','blocked','pending') DEFAULT 'pending' COMMENT 'çŠ¶æ€',
  `verification_status` enum('pending','verified','rejected') DEFAULT 'pending' COMMENT 'è®¤è¯çŠ¶æ€',
  `is_online` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦åœ¨çº¿',
  `max_users` int unsigned DEFAULT 100 COMMENT 'æœ€å¤§æœåŠ¡ç”¨æˆ·æ•°',
  `max_daily_consultations` int unsigned DEFAULT 20 COMMENT 'æ¯æ—¥æœ€å¤§å’¨è¯¢æ•°',
  `response_time` int unsigned DEFAULT NULL COMMENT 'å¹³å‡å“åº”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰',
  `available_time` json DEFAULT NULL COMMENT 'å¯æœåŠ¡æ—¶é—´',
  `service_areas` json DEFAULT NULL COMMENT 'æœåŠ¡åŒºåŸŸ',
  `languages` json DEFAULT NULL COMMENT 'æŽŒæ¡è¯­è¨€',
  `certificates` json DEFAULT NULL COMMENT 'è¯ä¹¦ä¿¡æ¯',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_phone` (`phone`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_id_card` (`id_card`),
  UNIQUE KEY `uk_license_number` (`license_number`),
  KEY `idx_status` (`status`),
  KEY `idx_verification_status` (`verification_status`),
  KEY `idx_rating` (`rating`),
  KEY `idx_user_count` (`user_count`),
  KEY `idx_is_online` (`is_online`),
  KEY `idx_consultation_fee` (`consultation_fee`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å¥åº·é¡¾é—®è¡¨';

-- 2. ç”¨æˆ·è¡¨
CREATE TABLE `users` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·IDï¼ˆä¸»é”®ï¼‰',
  `openid` varchar(64) NOT NULL COMMENT 'å¾®ä¿¡openid',
  `unionid` varchar(64) DEFAULT NULL COMMENT 'å¾®ä¿¡unionid',
  `nickname` varchar(50) DEFAULT NULL COMMENT 'è„±æ•å§“åï¼ˆæŽXæ˜Žï¼‰',
  `real_name` varchar(100) DEFAULT NULL COMMENT 'çœŸå®žå§“åï¼ˆåŠ å¯†å­˜å‚¨ï¼‰',
  `avatar` varchar(500) DEFAULT NULL COMMENT 'å¤´åƒURL',
  `phone` varchar(20) DEFAULT NULL COMMENT 'æ‰‹æœºå·ï¼ˆåŠ å¯†ï¼‰',
  `email` varchar(100) DEFAULT NULL COMMENT 'é‚®ç®±',
  `gender` enum('male','female') DEFAULT NULL COMMENT 'æ€§åˆ«',
  `age` tinyint unsigned DEFAULT NULL COMMENT 'å¹´é¾„',
  `birth_date` date DEFAULT NULL COMMENT 'å‡ºç”Ÿæ—¥æœŸ',
  `height` decimal(5,2) DEFAULT NULL COMMENT 'èº«é«˜(cm)',
  `current_weight` decimal(5,2) DEFAULT NULL COMMENT 'å½“å‰ä½“é‡(kg)',
  `target_weight` decimal(5,2) DEFAULT NULL COMMENT 'ç›®æ ‡ä½“é‡(kg)',
  `bmi` decimal(4,2) DEFAULT NULL COMMENT 'BMIæŒ‡æ•°',
  `occupation` varchar(100) DEFAULT NULL COMMENT 'èŒä¸š',
  `activity_level` enum('sedentary','light','moderate','active') DEFAULT NULL COMMENT 'æ´»åŠ¨æ°´å¹³',
  `health_goals` json DEFAULT NULL COMMENT 'å¥åº·ç›®æ ‡æ•°ç»„',
  `medical_history` json DEFAULT NULL COMMENT 'ç—…å²æ•°ç»„',
  `dietary_restrictions` json DEFAULT NULL COMMENT 'é¥®é£Ÿé™åˆ¶',
  `allergies` json DEFAULT NULL COMMENT 'è¿‡æ•ä¿¡æ¯',
  `preferred_language` varchar(10) DEFAULT 'zh-CN' COMMENT 'é¦–é€‰è¯­è¨€',
  `timezone` varchar(50) DEFAULT 'Asia/Shanghai' COMMENT 'æ—¶åŒº',
  `advisor_id` bigint unsigned DEFAULT NULL COMMENT 'å…³è”å¥åº·é¡¾é—®ID',
  `member_level` enum('free','standard','premium') DEFAULT 'free' COMMENT 'ä¼šå‘˜ç­‰çº§',
  `member_expire` datetime DEFAULT NULL COMMENT 'ä¼šå‘˜åˆ°æœŸæ—¶é—´',
  `status` enum('active','inactive','blocked','pending') DEFAULT 'active' COMMENT 'çŠ¶æ€',
  `notification_settings` json DEFAULT NULL COMMENT 'é€šçŸ¥è®¾ç½®',
  `privacy_settings` json DEFAULT NULL COMMENT 'éšç§è®¾ç½®',
  `last_login` datetime DEFAULT NULL COMMENT 'æœ€åŽç™»å½•æ—¶é—´',
  `login_count` int unsigned DEFAULT 0 COMMENT 'ç™»å½•æ¬¡æ•°',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  KEY `idx_advisor_id` (`advisor_id`),
  KEY `idx_member_level` (`member_level`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è¡¨';

-- æ’å…¥åˆå§‹é…ç½®
INSERT INTO system_configs (config_key, config_value, config_type, description, category, is_active) VALUES
('ai_daily_limit', '5', 'number', 'å…è´¹ç”¨æˆ·æ¯æ—¥AIå¯¹è¯æ¬¡æ•°é™åˆ¶', 'ai', 1),
('review_timeout_hours', '24', 'number', 'å®¡æ ¸è¶…æ—¶æ—¶é—´ï¼ˆå°æ—¶ï¼‰', 'review', 1),
('max_weight_records_per_day', '10', 'number', 'æ¯æ—¥æœ€å¤§ä½“é‡è®°å½•æ¬¡æ•°', 'record', 1),
('max_diet_records_per_day', '20', 'number', 'æ¯æ—¥æœ€å¤§é¥®é£Ÿè®°å½•æ¬¡æ•°', 'record', 1),
('max_exercise_records_per_day', '10', 'number', 'æ¯æ—¥æœ€å¤§è¿åŠ¨è®°å½•æ¬¡æ•°', 'record', 1),
('membership_upgrade_fee', '9900', 'number', 'ä¼šå‘˜å‡çº§è´¹ç”¨ï¼ˆåˆ†ï¼‰', 'payment', 1),
('review_fee', '5000', 'number', 'å®¡æ ¸è´¹ç”¨ï¼ˆåˆ†ï¼‰', 'payment', 1),
('advisor_commission_rate', '0.7', 'number', 'å¥åº·é¡¾é—®åˆ†æˆæ¯”ä¾‹', 'payment', 1);
```

### 10.2 å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

```javascript
// èŽ·å–ç”¨æˆ·ä½“é‡è¶‹åŠ¿
db.weight_records.aggregate([
  { $match: { user_id: ObjectId("...") } },
  { $sort: { record_date: 1 } },
  { $group: {
    _id: { $dateToString: { format: "%Y-%m-%d", date: "$record_date" } },
    weight: { $avg: "$weight" },
    bmi: { $avg: "$bmi" }
  }},
  { $sort: { _id: 1 } }
]);

// èŽ·å–ç”¨æˆ·æ¯æ—¥çƒ­é‡ç»Ÿè®¡
db.diet_records.aggregate([
  { $match: { user_id: ObjectId("...") } },
  { $group: {
    _id: { $dateToString: { format: "%Y-%m-%d", date: "$record_date" } },
    total_calories: { $sum: "$calories" },
    total_protein: { $sum: "$protein" },
    total_fat: { $sum: "$fat" },
    total_carbs: { $sum: "$carbs" }
  }},
  { $sort: { _id: 1 } }
]);

// èŽ·å–å¥åº·é¡¾é—®çš„æ‚£è€…åˆ—è¡¨
db.users.find(
  { advisor_id: ObjectId("..."), status: "active" },
  { nickname: 1, current_weight: 1, bmi: 1, last_login: 1 }
).sort({ last_login: -1 });

// èŽ·å–ç”¨æˆ·ç›®æ ‡è¿›åº¦
db.user_goals.aggregate([
  { $match: { user_id: ObjectId("..."), status: "active" } },
  { $lookup: {
    from: "weight_records",
    localField: "user_id",
    foreignField: "user_id",
    as: "weight_records"
  }},
  { $project: {
    goal_name: 1,
    target_weight: 1,
    current_weight: 1,
    progress_percentage: 1,
    latest_weight: { $arrayElemAt: ["$weight_records.weight", -1] }
  }}
]);

// èŽ·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®
db.user_statistics.aggregate([
  { $match: { user_id: ObjectId("...") } },
  { $sort: { stat_date: -1 } },
  { $limit: 30 },
  { $group: {
    _id: null,
    avg_calories: { $avg: "$total_calories" },
    avg_exercise_minutes: { $avg: "$total_exercise_minutes" },
    total_weight_change: { $sum: "$weight_change" }
  }}
]);

// æœç´¢é£Ÿç‰©æ•°æ®åº“
db.food_database.find(
  { $text: { $search: "è‹¹æžœ" } },
  { score: { $meta: "textScore" } }
).sort({ score: { $meta: "textScore" } });

// èŽ·å–å¾…å®¡æ ¸çš„AIæ–¹æ¡ˆ
db.ai_plans.find(
  { status: "pending" },
  { plan_name: 1, user_id: 1, created_at: 1 }
).sort({ created_at: 1 });

// èŽ·å–ç”¨æˆ·æœªè¯»é€šçŸ¥
db.notifications.find(
  { user_id: ObjectId("..."), is_read: false },
  { title: 1, content: 1, notification_type: 1, created_at: 1 }
).sort({ created_at: -1 });
```

### 10.3 æ•°æ®å¤‡ä»½è„šæœ¬

```javascript
// æ•°æ®å¤‡ä»½è„šæœ¬
const backupCollections = [
  'users',
  'advisors', 
  'weight_records',
  'diet_records',
  'exercise_records',
  'ai_plans',
  'chat_messages',
  'review_records',
  'payment_records',
  'membership_records',
  'advisor_income_records',
  'system_configs',
  'operation_logs',
  'food_database',
  'exercise_database',
  'user_goals',
  'user_statistics',
  'notifications',
  'user_feedback',
  'audit_logs'
];

// å¤‡ä»½å‡½æ•°
function backupCollection(collectionName) {
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const backupName = `${collectionName}_backup_${timestamp}`;
  
  db.runCommand({
    cloneCollection: `weight_management.${collectionName}`,
    collection: backupName
  });
  
  print(`Backed up ${collectionName} to ${backupName}`);
}

// æ‰§è¡Œå¤‡ä»½
backupCollections.forEach(backupCollection);
```

### 10.4 æ•°æ®æ¸…ç†è„šæœ¬

```javascript
// æ•°æ®æ¸…ç†è„šæœ¬
const CLEANUP_RULES = {
  // æ¸…ç†è¶…è¿‡6ä¸ªæœˆçš„èŠå¤©è®°å½•
  chat_messages: {
    condition: { created_at: { $lt: new Date(Date.now() - 180 * 24 * 60 * 60 * 1000) } },
    action: "delete"
  },
  
  // æ¸…ç†è¶…è¿‡3ä¸ªæœˆçš„æ“ä½œæ—¥å¿—
  operation_logs: {
    condition: { created_at: { $lt: new Date(Date.now() - 90 * 24 * 60 * 60 * 1000) } },
    action: "delete"
  },
  
  // æ¸…ç†è¶…è¿‡1å¹´çš„å®¡è®¡æ—¥å¿—
  audit_logs: {
    condition: { created_at: { $lt: new Date(Date.now() - 365 * 24 * 60 * 60 * 1000) } },
    action: "archive"
  },
  
  // æ¸…ç†å·²å®Œæˆçš„ç”¨æˆ·ç›®æ ‡
  user_goals: {
    condition: { 
      status: "completed", 
      updated_at: { $lt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) } 
    },
    action: "archive"
  }
};

// æ¸…ç†å‡½æ•°
function cleanupData() {
  Object.keys(CLEANUP_RULES).forEach(collectionName => {
    const rule = CLEANUP_RULES[collectionName];
    const count = db[collectionName].count(rule.condition);
    
    if (count > 0) {
      if (rule.action === "delete") {
        db[collectionName].deleteMany(rule.condition);
        print(`Deleted ${count} records from ${collectionName}`);
      } else if (rule.action === "archive") {
        // å½’æ¡£åˆ°å†·å­˜å‚¨
        const archivedData = db[collectionName].find(rule.condition).toArray();
        db[`${collectionName}_archive`].insertMany(archivedData);
        db[collectionName].deleteMany(rule.condition);
        print(`Archived ${count} records from ${collectionName}`);
      }
    }
  });
}

// æ‰§è¡Œæ¸…ç†
cleanupData();
```

### 10.5 æ€§èƒ½ä¼˜åŒ–è„šæœ¬

```javascript
// æ€§èƒ½ä¼˜åŒ–è„šæœ¬
function optimizeDatabase() {
  // 1. åˆ†æžç´¢å¼•ä½¿ç”¨æƒ…å†µ
  const indexStats = db.runCommand({ collStats: "users" });
  print("Index usage statistics:", JSON.stringify(indexStats, null, 2));
  
  // 2. åˆ›å»ºç¼ºå¤±çš„ç´¢å¼•
  const missingIndexes = [
    { collection: "weight_records", index: { "user_id": 1, "record_date": -1 } },
    { collection: "diet_records", index: { "user_id": 1, "meal_type": 1, "record_date": -1 } },
    { collection: "exercise_records", index: { "user_id": 1, "exercise_type": 1 } },
    { collection: "ai_plans", index: { "user_id": 1, "status": 1 } },
    { collection: "chat_messages", index: { "user_id": 1, "advisor_id": 1, "created_at": -1 } }
  ];
  
  missingIndexes.forEach(({ collection, index }) => {
    try {
      db[collection].createIndex(index);
      print(`Created index for ${collection}`);
    } catch (error) {
      print(`Index already exists for ${collection}`);
    }
  });
  
  // 3. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  db.runCommand({ compact: "users" });
  db.runCommand({ compact: "weight_records" });
  db.runCommand({ compact: "diet_records" });
  
  print("Database optimization completed");
}

// æ‰§è¡Œä¼˜åŒ–
optimizeDatabase();
```

è¿™ä»½å®Œå–„çš„æ•°æ®åº“è®¾è®¡æ–‡æ¡£çŽ°åœ¨åŒ…å«äº†ï¼š

1. **å®Œæ•´çš„é›†åˆè®¾è®¡**ï¼š18ä¸ªæ ¸å¿ƒé›†åˆï¼Œæ¶µç›–æ‰€æœ‰ä¸šåŠ¡åœºæ™¯
2. **è¯¦ç»†çš„å­—æ®µç»“æž„**ï¼šæ¯ä¸ªå­—æ®µéƒ½æœ‰æ˜Žç¡®çš„ç±»åž‹ã€çº¦æŸå’Œè¯´æ˜Ž
3. **ä¼˜åŒ–çš„ç´¢å¼•è®¾è®¡**ï¼šå¤åˆç´¢å¼•ã€æ–‡æœ¬ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•çš„åˆç†é…ç½®
4. **å®Œå–„çš„å®‰å…¨æŽªæ–½**ï¼šæ•°æ®åŠ å¯†ã€è„±æ•ã€è®¿é—®æŽ§åˆ¶ã€å®¡è®¡æ—¥å¿—
5. **æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼šåˆ†è¡¨ç­–ç•¥ã€ç¼“å­˜ç­–ç•¥ã€æŸ¥è¯¢ä¼˜åŒ–
6. **æ•°æ®éªŒè¯è§„åˆ™**ï¼šå®Œæ•´çš„æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
7. **å®žç”¨å·¥å…·è„šæœ¬**ï¼šåˆå§‹åŒ–ã€å¤‡ä»½ã€æ¸…ç†ã€ä¼˜åŒ–è„šæœ¬

è¿™ä¸ªæ•°æ®åº“è®¾è®¡æ–‡æ¡£ä¸ºä½“é‡ç®¡ç†æ•°å­—åŒ»ç”Ÿå°ç¨‹åºé¡¹ç›®æä¾›äº†åšå®žçš„æŠ€æœ¯åŸºç¡€ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿé«˜æ•ˆã€å®‰å…¨ã€å¯æ‰©å±•åœ°è¿è¡Œã€‚
