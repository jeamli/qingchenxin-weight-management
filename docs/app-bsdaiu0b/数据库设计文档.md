# 体重管理数字医生小程序 - 数据库设计文档

**文档版本**：v1.2  
**创建日期**：2025年8月8日  
**最后更新**：2025年8月8日  
**文档状态**：已简化约束条件，适合初期开发

---

## 修改总结（v1.2）

根据数据库设计文档审查报告，本次修改主要包括：

### 1. 完成MongoDB到MySQL的转换
- ✅ 将 `exercise_records` 从MongoDB集合转换为MySQL表
- ✅ 将 `review_records` 从MongoDB集合转换为MySQL表
- ✅ 将 `audit_logs` 从MongoDB集合转换为MySQL表

### 2. 添加缺失的外键约束
- ✅ 为 `ai_plans` 表添加 `fk_ai_plans_reviewed_by` 外键约束
- ✅ 为 `review_records` 表添加完整的外键约束

### 3. 完善数据验证规则
- ✅ 优化用户表的数据验证约束命名
- ✅ 为运动记录表添加完整的数据验证约束
- ✅ 为审核记录表添加数据验证约束

### 4. 优化索引设计
- ✅ 为运动记录表添加优化的复合索引（包含DESC排序）
- ✅ 为用户表添加覆盖索引 `idx_user_basic_info`
- ✅ 为审核记录表添加用户ID索引

### 5. 新增功能表
- ✅ 新增 `membership_records` 会员记录表
- ✅ 新增 `advisor_income_records` 健康顾问收入记录表
- ✅ 完善 `audit_logs` 审计日志表

### 6. 增强数据安全
- ✅ 添加 `users_desensitized` 数据脱敏视图
- ✅ 完善分表函数和存储过程
- ✅ 更新数据关系设计和外键约束

### 7. 更新系统配置
- ✅ 添加会员升级费用配置
- ✅ 添加审核费用配置
- ✅ 添加健康顾问分成比例配置

### 8. 完善查询示例
- ✅ 添加会员变更记录查询
- ✅ 添加健康顾问收入统计查询
- ✅ 添加包含审核人信息的AI方案查询

### 9. 简化约束条件（v1.2新增）
- ✅ 去掉过于严格的外键约束（初期开发友好）
- ✅ 简化数据验证规则（允许更宽松的范围）
- ✅ 减少不必要的唯一索引
- ✅ 优化默认状态设置（用户状态默认为active）
- ✅ 添加表优先级分类，指导初期开发顺序

---

## 表优先级分类（初期开发建议）

### 🟢 **P0 - 核心表（初期必须）**
这些表是小程序的核心功能，必须优先实现：

1. **users** - 用户表（核心）
2. **weight_records** - 体重记录表（核心）
3. **diet_records** - 饮食记录表（核心）
4. **exercise_records** - 运动记录表（核心）
5. **ai_plans** - AI方案表（核心）
6. **system_configs** - 系统配置表（核心）

### 🟡 **P1 - 重要表（初期建议）**
这些表对用户体验很重要，建议初期实现：

7. **advisors** - 健康顾问表
8. **chat_messages** - 聊天记录表
9. **review_records** - 审核记录表
10. **payment_records** - 支付记录表
11. **notifications** - 通知表

### 🟠 **P2 - 功能表（中期完善）**
这些表用于功能完善，中期实现：

12. **food_database** - 食物数据库
13. **exercise_database** - 运动数据库
14. **user_goals** - 用户目标设定
15. **user_statistics** - 用户统计
16. **user_feedback** - 用户反馈

### 🔴 **P3 - 高级表（后期优化）**
这些表用于高级功能和优化，后期实现：

17. **membership_records** - 会员记录表
18. **advisor_income_records** - 健康顾问收入记录表
19. **audit_logs** - 审计日志表
20. **operation_logs** - 操作日志表

### 📝 **简化说明**
- 去掉了过于严格的外键约束（初期可以不用）
- 简化了数据验证规则（允许更宽松的范围）
- 减少了不必要的唯一索引
- 保留了核心功能，去掉了高级特性
- 默认状态改为更友好的设置（如用户状态默认为active）

---

## 1. 数据库概述

### 1.1 数据库类型
- **数据库**：MySQL（关系型数据库）
- **版本**：8.0+
- **字符集**：utf8mb4
- **排序规则**：utf8mb4_unicode_ci
- **时区**：Asia/Shanghai
- **存储引擎**：InnoDB

### 1.2 设计原则
- **数据脱敏**：敏感信息加密存储，显示时脱敏
- **分表策略**：按时间分表，提高查询性能
- **索引优化**：合理设置索引，优化查询性能
- **数据备份**：定期备份，确保数据安全
- **外键约束**：使用外键保证数据完整性
- **事务处理**：确保数据一致性
- **字符集统一**：使用utf8mb4支持完整Unicode字符

---

## 2. 数据库表设计

### 2.1 用户表（users）

**表名**：`users`  
**描述**：存储用户基本信息

**表结构**：
```sql
CREATE TABLE `users` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '用户ID（主键）',
  `openid` varchar(64) NOT NULL COMMENT '微信openid',
  `unionid` varchar(64) DEFAULT NULL COMMENT '微信unionid',
  `nickname` varchar(50) DEFAULT NULL COMMENT '脱敏姓名（李X明）',
  `real_name` varchar(100) DEFAULT NULL COMMENT '真实姓名（加密存储）',
  `avatar` varchar(500) DEFAULT NULL COMMENT '头像URL',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号（加密）',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `gender` enum('male','female') DEFAULT NULL COMMENT '性别',
  `age` tinyint unsigned DEFAULT NULL COMMENT '年龄',
  `birth_date` date DEFAULT NULL COMMENT '出生日期',
  `height` decimal(5,2) DEFAULT NULL COMMENT '身高(cm)',
  `current_weight` decimal(5,2) DEFAULT NULL COMMENT '当前体重(kg)',
  `target_weight` decimal(5,2) DEFAULT NULL COMMENT '目标体重(kg)',
  `bmi` decimal(4,2) DEFAULT NULL COMMENT 'BMI指数',
  `occupation` varchar(100) DEFAULT NULL COMMENT '职业',
  `activity_level` enum('sedentary','light','moderate','active') DEFAULT NULL COMMENT '活动水平',
  `health_goals` json DEFAULT NULL COMMENT '健康目标数组',
  `medical_history` json DEFAULT NULL COMMENT '病史数组',
  `dietary_restrictions` json DEFAULT NULL COMMENT '饮食限制',
  `allergies` json DEFAULT NULL COMMENT '过敏信息',
  `preferred_language` varchar(10) DEFAULT 'zh-CN' COMMENT '首选语言',
  `timezone` varchar(50) DEFAULT 'Asia/Shanghai' COMMENT '时区',
  `advisor_id` bigint unsigned DEFAULT NULL COMMENT '关联健康顾问ID',
  `member_level` enum('free','standard','premium') DEFAULT 'free' COMMENT '会员等级',
  `member_expire` datetime DEFAULT NULL COMMENT '会员到期时间',
  `status` enum('active','inactive','blocked','pending') DEFAULT 'active' COMMENT '状态',
  `notification_settings` json DEFAULT NULL COMMENT '通知设置',
  `privacy_settings` json DEFAULT NULL COMMENT '隐私设置',
  `last_login` datetime DEFAULT NULL COMMENT '最后登录时间',
  `login_count` int unsigned DEFAULT 0 COMMENT '登录次数',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  KEY `idx_advisor_id` (`advisor_id`),
  KEY `idx_member_level` (`member_level`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

**索引设计**：
```sql
-- 唯一索引
ALTER TABLE `users` ADD UNIQUE KEY `uk_openid` (`openid`);

-- 普通索引
ALTER TABLE `users` ADD KEY `idx_advisor_id` (`advisor_id`);
ALTER TABLE `users` ADD KEY `idx_member_level` (`member_level`);
ALTER TABLE `users` ADD KEY `idx_status` (`status`);
ALTER TABLE `users` ADD KEY `idx_created_at` (`created_at`);
```

**约束条件**：
```sql
-- 基础数据约束（简化版）
ALTER TABLE `users` ADD CONSTRAINT `chk_age_basic` CHECK (`age` IS NULL OR (`age` >= 1 AND `age` <= 120));
ALTER TABLE `users` ADD CONSTRAINT `chk_height_basic` CHECK (`height` IS NULL OR (`height` >= 50 AND `height` <= 300));
ALTER TABLE `users` ADD CONSTRAINT `chk_weight_basic` CHECK (`current_weight` IS NULL OR (`current_weight` >= 10 AND `current_weight` <= 500));

-- 触发器：自动计算BMI（简化版）
DELIMITER $$
CREATE TRIGGER `tr_users_bmi_calc` 
BEFORE INSERT ON `users` 
FOR EACH ROW 
BEGIN
    IF NEW.current_weight IS NOT NULL AND NEW.height IS NOT NULL AND NEW.height > 0 THEN
        SET NEW.bmi = NEW.current_weight / POWER(NEW.height / 100, 2);
    END IF;
END$$

CREATE TRIGGER `tr_users_bmi_calc_update` 
BEFORE UPDATE ON `users` 
FOR EACH ROW 
BEGIN
    IF NEW.current_weight IS NOT NULL AND NEW.height IS NOT NULL AND NEW.height > 0 THEN
        SET NEW.bmi = NEW.current_weight / POWER(NEW.height / 100, 2);
    END IF;
END$$
DELIMITER ;
```

### 2.2 健康顾问表（advisors）

**表名**：`advisors`  
**描述**：存储健康顾问信息

**表结构**：
```sql
CREATE TABLE `advisors` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '健康顾问ID（主键）',
  `name` varchar(100) NOT NULL COMMENT '姓名',
  `avatar` varchar(500) DEFAULT NULL COMMENT '头像URL',
  `phone` varchar(20) NOT NULL COMMENT '手机号（加密）',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `id_card` varchar(20) DEFAULT NULL COMMENT '身份证号（加密）',
  `license_number` varchar(50) DEFAULT NULL COMMENT '执业证书号',
  `specialty` json DEFAULT NULL COMMENT '专业领域数组',
  `specialization` json DEFAULT NULL COMMENT '专业特长',
  `qualification` varchar(200) DEFAULT NULL COMMENT '资质证书',
  `education` varchar(100) DEFAULT NULL COMMENT '学历',
  `work_experience` text DEFAULT NULL COMMENT '工作经历',
  `hospital` varchar(200) DEFAULT NULL COMMENT '合作医院',
  `description` text DEFAULT NULL COMMENT '专业描述',
  `experience_years` tinyint unsigned DEFAULT NULL COMMENT '从业年限',
  `consultation_fee` int unsigned DEFAULT 0 COMMENT '咨询费用（分）',
  `user_count` int unsigned DEFAULT 0 COMMENT '服务用户数',
  `rating` decimal(2,1) DEFAULT NULL COMMENT '评分（1-5）',
  `total_income` bigint unsigned DEFAULT 0 COMMENT '总收入（分）',
  `monthly_income` bigint unsigned DEFAULT 0 COMMENT '月收入（分）',
  `status` enum('active','inactive','blocked','pending') DEFAULT 'pending' COMMENT '状态',
  `verification_status` enum('pending','verified','rejected') DEFAULT 'pending' COMMENT '认证状态',
  `is_online` tinyint(1) DEFAULT 0 COMMENT '是否在线',
  `max_users` int unsigned DEFAULT 100 COMMENT '最大服务用户数',
  `max_daily_consultations` int unsigned DEFAULT 20 COMMENT '每日最大咨询数',
  `response_time` int unsigned DEFAULT NULL COMMENT '平均响应时间（分钟）',
  `available_time` json DEFAULT NULL COMMENT '可服务时间',
  `service_areas` json DEFAULT NULL COMMENT '服务区域',
  `languages` json DEFAULT NULL COMMENT '掌握语言',
  `certificates` json DEFAULT NULL COMMENT '证书信息',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_phone` (`phone`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_id_card` (`id_card`),
  UNIQUE KEY `uk_license_number` (`license_number`),
  KEY `idx_status` (`status`),
  KEY `idx_verification_status` (`verification_status`),
  KEY `idx_rating` (`rating`),
  KEY `idx_user_count` (`user_count`),
  KEY `idx_is_online` (`is_online`),
  KEY `idx_consultation_fee` (`consultation_fee`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='健康顾问表';
```

**索引设计**：
```sql
-- 唯一索引
ALTER TABLE `advisors` ADD UNIQUE KEY `uk_phone` (`phone`);
ALTER TABLE `advisors` ADD UNIQUE KEY `uk_email` (`email`);
ALTER TABLE `advisors` ADD UNIQUE KEY `uk_id_card` (`id_card`);
ALTER TABLE `advisors` ADD UNIQUE KEY `uk_license_number` (`license_number`);

-- 普通索引
ALTER TABLE `advisors` ADD KEY `idx_status` (`status`);
ALTER TABLE `advisors` ADD KEY `idx_verification_status` (`verification_status`);
ALTER TABLE `advisors` ADD KEY `idx_rating` (`rating`);
ALTER TABLE `advisors` ADD KEY `idx_user_count` (`user_count`);
ALTER TABLE `advisors` ADD KEY `idx_is_online` (`is_online`);
ALTER TABLE `advisors` ADD KEY `idx_consultation_fee` (`consultation_fee`);
ALTER TABLE `advisors` ADD KEY `idx_created_at` (`created_at`);
```

### 2.3 体重记录表（weight_records）

**表名**：`weight_records`  
**描述**：存储用户体重记录

**表结构**：
```sql
CREATE TABLE `weight_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '记录ID（主键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `weight` decimal(5,2) NOT NULL COMMENT '体重(kg)',
  `bmi` decimal(4,2) DEFAULT NULL COMMENT 'BMI指数',
  `record_date` date NOT NULL COMMENT '记录日期',
  `record_time` datetime NOT NULL COMMENT '记录时间',
  `record_type` enum('manual','photo','auto') DEFAULT 'manual' COMMENT '记录类型',
  `photo_url` varchar(500) DEFAULT NULL COMMENT '照片URL',
  `note` text DEFAULT NULL COMMENT '备注',
  `device_info` json DEFAULT NULL COMMENT '设备信息',
  `location` json DEFAULT NULL COMMENT '位置信息',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_record_date` (`user_id`, `record_date`),
  KEY `idx_user_id_created_at` (`user_id`, `created_at`),
  KEY `idx_record_type` (`record_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='体重记录表';
```

**索引设计**：
```sql
-- 复合索引
ALTER TABLE `weight_records` ADD KEY `idx_user_id_record_date` (`user_id`, `record_date`);
ALTER TABLE `weight_records` ADD KEY `idx_user_id_created_at` (`user_id`, `created_at`);

-- 普通索引
ALTER TABLE `weight_records` ADD KEY `idx_record_type` (`record_type`);
```

**约束条件**：
```sql
-- 基础数据约束（简化版）
ALTER TABLE `weight_records` ADD CONSTRAINT `chk_weight_basic` CHECK (`weight` >= 10 AND `weight` <= 500);
```

### 2.4 饮食记录表（diet_records）

**表名**：`diet_records`  
**描述**：存储用户饮食记录

**表结构**：
```sql
CREATE TABLE `diet_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '记录ID（主键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `food_name` varchar(200) NOT NULL COMMENT '食物名称',
  `food_category` varchar(50) DEFAULT NULL COMMENT '食物分类',
  `quantity` decimal(8,2) NOT NULL COMMENT '数量',
  `unit` varchar(20) DEFAULT NULL COMMENT '单位',
  `calories` decimal(8,2) DEFAULT NULL COMMENT '热量(kcal)',
  `protein` decimal(6,2) DEFAULT NULL COMMENT '蛋白质(g)',
  `fat` decimal(6,2) DEFAULT NULL COMMENT '脂肪(g)',
  `carbs` decimal(6,2) DEFAULT NULL COMMENT '碳水化合物(g)',
  `fiber` decimal(6,2) DEFAULT NULL COMMENT '膳食纤维(g)',
  `sugar` decimal(6,2) DEFAULT NULL COMMENT '糖分(g)',
  `sodium` decimal(8,2) DEFAULT NULL COMMENT '钠(mg)',
  `photo_url` varchar(500) DEFAULT NULL COMMENT '照片URL',
  `meal_type` enum('breakfast','lunch','dinner','snack') DEFAULT NULL COMMENT '餐次类型',
  `record_date` date NOT NULL COMMENT '记录日期',
  `record_time` datetime NOT NULL COMMENT '记录时间',
  `record_type` enum('manual','photo','ai') DEFAULT 'manual' COMMENT '记录类型',
  `ai_confidence` decimal(3,2) DEFAULT NULL COMMENT 'AI识别置信度',
  `note` text DEFAULT NULL COMMENT '备注',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_record_date` (`user_id`, `record_date`),
  KEY `idx_user_id_meal_type_record_date` (`user_id`, `meal_type`, `record_date`),
  KEY `idx_meal_type` (`meal_type`),
  KEY `idx_record_type` (`record_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='饮食记录表';
```

**索引设计**：
```sql
-- 复合索引
ALTER TABLE `diet_records` ADD KEY `idx_user_id_record_date` (`user_id`, `record_date`);
ALTER TABLE `diet_records` ADD KEY `idx_user_id_meal_type_record_date` (`user_id`, `meal_type`, `record_date`);

-- 普通索引
ALTER TABLE `diet_records` ADD KEY `idx_meal_type` (`meal_type`);
ALTER TABLE `diet_records` ADD KEY `idx_record_type` (`record_type`);
```

**约束条件**：
```sql
-- 基础数据约束（简化版）
ALTER TABLE `diet_records` ADD CONSTRAINT `chk_quantity_basic` CHECK (`quantity` > 0 AND `quantity` <= 10000);
ALTER TABLE `diet_records` ADD CONSTRAINT `chk_calories_basic` CHECK (`calories` IS NULL OR (`calories` >= 0 AND `calories` <= 10000));
```

### 2.5 运动记录表（exercise_records）

**表名**：`exercise_records`  
**描述**：存储用户运动记录

**表结构**：
```sql
CREATE TABLE `exercise_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '记录ID（主键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `exercise_type` enum('cardio','strength','flexibility') NOT NULL COMMENT '运动类型',
  `exercise_name` varchar(200) NOT NULL COMMENT '运动名称',
  `duration` int unsigned NOT NULL COMMENT '运动时长(分钟)',
  `intensity` enum('low','medium','high') NOT NULL COMMENT '运动强度',
  `calories_burned` decimal(8,2) DEFAULT NULL COMMENT '消耗卡路里',
  `distance` decimal(8,2) DEFAULT NULL COMMENT '距离(km)',
  `steps` int unsigned DEFAULT NULL COMMENT '步数',
  `heart_rate_avg` int unsigned DEFAULT NULL COMMENT '平均心率',
  `heart_rate_max` int unsigned DEFAULT NULL COMMENT '最大心率',
  `heart_rate_min` int unsigned DEFAULT NULL COMMENT '最小心率',
  `photo_url` varchar(500) DEFAULT NULL COMMENT '照片URL',
  `record_date` date NOT NULL COMMENT '记录日期',
  `record_time` datetime NOT NULL COMMENT '记录时间',
  `record_type` enum('manual','photo','auto') DEFAULT 'manual' COMMENT '记录类型',
  `device_info` json DEFAULT NULL COMMENT '设备信息',
  `location` json DEFAULT NULL COMMENT '位置信息',
  `note` text DEFAULT NULL COMMENT '备注',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_record_date` (`user_id`, `record_date`),
  KEY `idx_user_id_exercise_type` (`user_id`, `exercise_type`),
  KEY `idx_exercise_type` (`exercise_type`),
  KEY `idx_intensity` (`intensity`),
  KEY `idx_record_type` (`record_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='运动记录表';
```

**索引设计**：
```sql
-- 复合索引
ALTER TABLE `exercise_records` ADD KEY `idx_user_id_record_date` (`user_id`, `record_date`);
ALTER TABLE `exercise_records` ADD KEY `idx_user_id_exercise_type` (`user_id`, `exercise_type`);

-- 普通索引
ALTER TABLE `exercise_records` ADD KEY `idx_exercise_type` (`exercise_type`);
ALTER TABLE `exercise_records` ADD KEY `idx_intensity` (`intensity`);
ALTER TABLE `exercise_records` ADD KEY `idx_record_type` (`record_type`);
```

**约束条件**：
```sql
-- 基础数据约束（简化版）
ALTER TABLE `exercise_records` ADD CONSTRAINT `chk_duration_basic` CHECK (`duration` >= 1 AND `duration` <= 480);
ALTER TABLE `exercise_records` ADD CONSTRAINT `chk_calories_burned_basic` CHECK (`calories_burned` IS NULL OR (`calories_burned` >= 0 AND `calories_burned` <= 5000));
ALTER TABLE `exercise_records` ADD CONSTRAINT `chk_distance_basic` CHECK (`distance` IS NULL OR (`distance` >= 0 AND `distance` <= 1000));
ALTER TABLE `exercise_records` ADD CONSTRAINT `chk_steps_basic` CHECK (`steps` IS NULL OR (`steps` >= 0 AND `steps` <= 100000));
```

### 2.6 AI方案表（ai_plans）

**表名**：`ai_plans`  
**描述**：存储AI生成的健康方案

**表结构**：
```sql
CREATE TABLE `ai_plans` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '方案ID（主键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `advisor_id` bigint unsigned DEFAULT NULL COMMENT '健康顾问ID（外键，可选）',
  `plan_name` varchar(200) NOT NULL COMMENT '方案名称',
  `plan_type` enum('gentle','standard','aggressive') DEFAULT 'standard' COMMENT '方案类型',
  `target_weight` decimal(5,2) DEFAULT NULL COMMENT '目标体重',
  `duration` int unsigned DEFAULT NULL COMMENT '持续时间(天)',
  `expected_loss` decimal(4,2) DEFAULT NULL COMMENT '预期减重(kg)',
  `daily_calories` int unsigned DEFAULT NULL COMMENT '每日热量',
  `diet_plan` json DEFAULT NULL COMMENT '饮食计划',
  `exercise_plan` json DEFAULT NULL COMMENT '运动计划',
  `lifestyle_plan` json DEFAULT NULL COMMENT '生活方式建议',
  `status` enum('draft','pending','reviewed','approved','rejected') DEFAULT 'draft' COMMENT '状态',
  `review_comment` text DEFAULT NULL COMMENT '审核意见',
  `review_fee` int unsigned DEFAULT 0 COMMENT '审核费用',
  `reviewed_at` datetime DEFAULT NULL COMMENT '审核时间',
  `reviewed_by` bigint unsigned DEFAULT NULL COMMENT '审核人ID',
  `execution_status` enum('not_started','in_progress','completed','paused') DEFAULT 'not_started' COMMENT '执行状态',
  `start_date` date DEFAULT NULL COMMENT '开始日期',
  `end_date` date DEFAULT NULL COMMENT '结束日期',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_status` (`user_id`, `status`),
  KEY `idx_advisor_id_status` (`advisor_id`, `status`),
  KEY `idx_plan_type` (`plan_type`),
  KEY `idx_status` (`status`),
  KEY `idx_execution_status` (`execution_status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='AI方案表';
```

**索引设计**：
```sql
-- 复合索引
ALTER TABLE `ai_plans` ADD KEY `idx_user_id_status` (`user_id`, `status`);
ALTER TABLE `ai_plans` ADD KEY `idx_advisor_id_status` (`advisor_id`, `status`);

-- 普通索引
ALTER TABLE `ai_plans` ADD KEY `idx_plan_type` (`plan_type`);
ALTER TABLE `ai_plans` ADD KEY `idx_status` (`status`);
ALTER TABLE `ai_plans` ADD KEY `idx_execution_status` (`execution_status`);
ALTER TABLE `ai_plans` ADD KEY `idx_created_at` (`created_at`);
```

**约束条件**：
```sql
-- 基础数据约束（简化版）
ALTER TABLE `ai_plans` ADD CONSTRAINT `chk_duration_basic` CHECK (`duration` IS NULL OR (`duration` >= 1 AND `duration` <= 365));
ALTER TABLE `ai_plans` ADD CONSTRAINT `chk_daily_calories_basic` CHECK (`daily_calories` IS NULL OR (`daily_calories` >= 500 AND `daily_calories` <= 5000));
```

### 2.7 聊天记录表（chat_messages）

**表名**：`chat_messages`  
**描述**：存储用户与健康顾问的聊天记录

**表结构**：
```sql
CREATE TABLE `chat_messages` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '消息ID（主键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `advisor_id` bigint unsigned NOT NULL COMMENT '健康顾问ID（外键）',
  `sender_type` enum('user','advisor','system') NOT NULL COMMENT '发送者类型',
  `message_type` enum('text','image','file','system') DEFAULT 'text' COMMENT '消息类型',
  `content` text DEFAULT NULL COMMENT '消息内容',
  `image_url` varchar(500) DEFAULT NULL COMMENT '图片URL',
  `file_url` varchar(500) DEFAULT NULL COMMENT '文件URL',
  `file_name` varchar(200) DEFAULT NULL COMMENT '文件名',
  `file_size` bigint unsigned DEFAULT NULL COMMENT '文件大小',
  `is_read` tinyint(1) DEFAULT 0 COMMENT '是否已读',
  `read_at` datetime DEFAULT NULL COMMENT '阅读时间',
  `is_deleted` tinyint(1) DEFAULT 0 COMMENT '是否已删除',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_advisor_id_created_at` (`user_id`, `advisor_id`, `created_at`),
  KEY `idx_advisor_id_user_id_created_at` (`advisor_id`, `user_id`, `created_at`),
  KEY `idx_sender_type` (`sender_type`),
  KEY `idx_message_type` (`message_type`),
  KEY `idx_is_read` (`is_read`),
  KEY `idx_is_deleted` (`is_deleted`),
  CONSTRAINT `fk_chat_messages_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_chat_messages_advisor_id` FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='聊天记录表';
```

**索引设计**：
```sql
-- 复合索引
ALTER TABLE `chat_messages` ADD KEY `idx_user_id_advisor_id_created_at` (`user_id`, `advisor_id`, `created_at`);
ALTER TABLE `chat_messages` ADD KEY `idx_advisor_id_user_id_created_at` (`advisor_id`, `user_id`, `created_at`);

-- 普通索引
ALTER TABLE `chat_messages` ADD KEY `idx_sender_type` (`sender_type`);
ALTER TABLE `chat_messages` ADD KEY `idx_message_type` (`message_type`);
ALTER TABLE `chat_messages` ADD KEY `idx_is_read` (`is_read`);
ALTER TABLE `chat_messages` ADD KEY `idx_is_deleted` (`is_deleted`);
```

### 2.8 审核记录表（review_records）

**表名**：`review_records`  
**描述**：存储健康顾问审核记录

**表结构**：
```sql
CREATE TABLE `review_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '审核记录ID（主键）',
  `plan_id` bigint unsigned NOT NULL COMMENT '方案ID（外键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `advisor_id` bigint unsigned NOT NULL COMMENT '健康顾问ID（外键）',
  `review_type` enum('plan_review','chat_review') NOT NULL COMMENT '审核类型',
  `review_status` enum('pending','approved','rejected','modified') NOT NULL COMMENT '审核状态',
  `review_comment` text DEFAULT NULL COMMENT '审核意见',
  `modification_suggestions` json DEFAULT NULL COMMENT '修改建议',
  `review_fee` int unsigned DEFAULT 0 COMMENT '审核费用（分）',
  `fee_status` enum('pending','paid','refunded') DEFAULT 'pending' COMMENT '费用状态',
  `review_time` int unsigned DEFAULT NULL COMMENT '审核耗时(分钟)',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `reviewed_at` datetime DEFAULT NULL COMMENT '审核时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_plan_id_review_status` (`plan_id`, `review_status`),
  KEY `idx_advisor_id_review_status` (`advisor_id`, `review_status`),
  KEY `idx_user_id_review_status` (`user_id`, `review_status`),
  KEY `idx_review_type` (`review_type`),
  KEY `idx_review_status` (`review_status`),
  KEY `idx_fee_status` (`fee_status`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_review_records_plan_id` FOREIGN KEY (`plan_id`) REFERENCES `ai_plans` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_review_records_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_review_records_advisor_id` FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='审核记录表';
```

**索引设计**：
```sql
-- 复合索引
ALTER TABLE `review_records` ADD KEY `idx_plan_id_review_status` (`plan_id`, `review_status`);
ALTER TABLE `review_records` ADD KEY `idx_advisor_id_review_status` (`advisor_id`, `review_status`);
ALTER TABLE `review_records` ADD KEY `idx_user_id_review_status` (`user_id`, `review_status`);

-- 普通索引
ALTER TABLE `review_records` ADD KEY `idx_review_type` (`review_type`);
ALTER TABLE `review_records` ADD KEY `idx_review_status` (`review_status`);
ALTER TABLE `review_records` ADD KEY `idx_fee_status` (`fee_status`);
ALTER TABLE `review_records` ADD KEY `idx_created_at` (`created_at`);
```

**约束条件**：
```sql
-- 数据约束
ALTER TABLE `review_records` ADD CONSTRAINT `chk_review_fee` CHECK (`review_fee` >= 0 AND `review_fee` <= 100000);
ALTER TABLE `review_records` ADD CONSTRAINT `chk_review_time` CHECK (`review_time` >= 0 AND `review_time` <= 1440);
```

### 2.9 支付记录表（payment_records）

**表名**：`payment_records`  
**描述**：存储支付和退款记录

**表结构**：
```sql
CREATE TABLE `payment_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '支付记录ID（主键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `order_id` varchar(64) NOT NULL COMMENT '订单ID',
  `transaction_id` varchar(64) DEFAULT NULL COMMENT '微信支付交易ID',
  `payment_type` enum('membership','review','service') NOT NULL COMMENT '支付类型',
  `amount` int unsigned NOT NULL COMMENT '支付金额(分)',
  `currency` varchar(10) DEFAULT 'CNY' COMMENT '货币类型',
  `status` enum('pending','success','failed','refunded') DEFAULT 'pending' COMMENT '支付状态',
  `payment_method` varchar(20) DEFAULT 'wechat_pay' COMMENT '支付方式',
  `description` varchar(500) DEFAULT NULL COMMENT '支付描述',
  `related_id` bigint unsigned DEFAULT NULL COMMENT '关联ID（方案ID、会员ID等）',
  `refund_amount` int unsigned DEFAULT 0 COMMENT '退款金额(分)',
  `refund_reason` varchar(200) DEFAULT NULL COMMENT '退款原因',
  `refund_time` datetime DEFAULT NULL COMMENT '退款时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `paid_at` datetime DEFAULT NULL COMMENT '支付时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_id` (`order_id`),
  UNIQUE KEY `uk_transaction_id` (`transaction_id`),
  KEY `idx_user_id_status` (`user_id`, `status`),
  KEY `idx_payment_type_status` (`payment_type`, `status`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_payment_records_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='支付记录表';
```

**索引设计**：
```sql
-- 唯一索引
ALTER TABLE `payment_records` ADD UNIQUE KEY `uk_order_id` (`order_id`);
ALTER TABLE `payment_records` ADD UNIQUE KEY `uk_transaction_id` (`transaction_id`);

-- 复合索引
ALTER TABLE `payment_records` ADD KEY `idx_user_id_status` (`user_id`, `status`);
ALTER TABLE `payment_records` ADD KEY `idx_payment_type_status` (`payment_type`, `status`);

-- 普通索引
ALTER TABLE `payment_records` ADD KEY `idx_status` (`status`);
ALTER TABLE `payment_records` ADD KEY `idx_created_at` (`created_at`);
```

### 2.10 系统配置表（system_configs）

**表名**：`system_configs`  
**描述**：存储系统配置信息

**表结构**：
```sql
CREATE TABLE `system_configs` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '配置ID（主键）',
  `config_key` varchar(100) NOT NULL COMMENT '配置键',
  `config_value` json DEFAULT NULL COMMENT '配置值',
  `config_type` enum('string','number','boolean','object') DEFAULT 'string' COMMENT '配置类型',
  `description` varchar(500) DEFAULT NULL COMMENT '配置描述',
  `category` varchar(50) DEFAULT NULL COMMENT '配置分类',
  `is_active` tinyint(1) DEFAULT 1 COMMENT '是否启用',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`),
  KEY `idx_category` (`category`),
  KEY `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统配置表';
```

**索引设计**：
```sql
-- 唯一索引
ALTER TABLE `system_configs` ADD UNIQUE KEY `uk_config_key` (`config_key`);

-- 普通索引
ALTER TABLE `system_configs` ADD KEY `idx_category` (`category`);
ALTER TABLE `system_configs` ADD KEY `idx_is_active` (`is_active`);
```

**约束条件**：
```sql
-- 基础数据约束（简化版）
-- 无特殊约束，保持灵活性
```

### 2.11 操作日志集合（operation_logs）

**集合名称**：`operation_logs`  
**描述**：存储系统操作日志

**字段结构**：
```javascript
{
  "_id": ObjectId,                    // 日志ID（主键）
  "user_id": ObjectId,                // 用户ID（可选）
  "advisor_id": ObjectId,             // 健康顾问ID（可选）
  "operation_type": String,           // 操作类型
  "operation_name": String,           // 操作名称
  "resource_type": String,            // 资源类型
  "resource_id": ObjectId,            // 资源ID
  "request_data": Object,             // 请求数据
  "response_data": Object,            // 响应数据
  "ip_address": String,               // IP地址
  "user_agent": String,               // 用户代理
  "status": String,                   // 操作状态：success/failed
  "error_message": String,            // 错误信息
  "execution_time": Number,           // 执行时间(ms)
  "created_at": Date                  // 创建时间
}
```

**索引设计**：
```javascript
// 复合索引
db.operation_logs.createIndex({"user_id": 1, "created_at": -1})
db.operation_logs.createIndex({"advisor_id": 1, "created_at": -1})

// 普通索引
db.operation_logs.createIndex({"operation_type": 1})
db.operation_logs.createIndex({"resource_type": 1})
db.operation_logs.createIndex({"status": 1})
db.operation_logs.createIndex({"created_at": -1})
```

### 2.6 食物数据库集合（food_database）

**集合名称**：`food_database`  
**描述**：存储食物营养信息数据库

**字段结构**：
```javascript
{
  "_id": ObjectId,                    // 食物ID（主键）
  "food_name": String,                // 食物名称
  "food_category": String,            // 食物分类：grains/vegetables/fruits/meat/dairy/nuts/seafood/others
  "food_subcategory": String,         // 食物子分类
  "calories_per_100g": Number,        // 每100g热量(kcal)
  "protein_per_100g": Number,         // 每100g蛋白质(g)
  "fat_per_100g": Number,             // 每100g脂肪(g)
  "carbs_per_100g": Number,           // 每100g碳水化合物(g)
  "fiber_per_100g": Number,           // 每100g膳食纤维(g)
  "sugar_per_100g": Number,           // 每100g糖分(g)
  "sodium_per_100g": Number,          // 每100g钠(mg)
  "vitamin_a": Number,                // 维生素A(μg)
  "vitamin_c": Number,                // 维生素C(mg)
  "vitamin_d": Number,                // 维生素D(μg)
  "vitamin_e": Number,                // 维生素E(mg)
  "calcium": Number,                  // 钙(mg)
  "iron": Number,                     // 铁(mg)
  "zinc": Number,                     // 锌(mg)
  "common_units": [{                  // 常见单位
    "unit_name": String,              // 单位名称
    "weight": Number,                 // 重量(g)
    "calories": Number,               // 热量(kcal)
    "protein": Number,                // 蛋白质(g)
    "fat": Number,                    // 脂肪(g)
    "carbs": Number                   // 碳水化合物(g)
  }],
  "image_url": String,                // 食物图片
  "description": String,              // 食物描述
  "tags": [String],                   // 标签
  "is_active": Boolean,               // 是否启用
  "search_keywords": [String],        // 搜索关键词
  "created_at": Date,                 // 创建时间
  "updated_at": Date                  // 更新时间
}
```

**索引设计**：
```javascript
// 文本索引
db.food_database.createIndex({"food_name": "text", "search_keywords": "text"})

// 普通索引
db.food_database.createIndex({"food_category": 1})
db.food_database.createIndex({"food_subcategory": 1})
db.food_database.createIndex({"is_active": 1})
db.food_database.createIndex({"tags": 1})
db.food_database.createIndex({"created_at": -1})
```

### 2.7 运动数据库集合（exercise_database）

**集合名称**：`exercise_database`  
**描述**：存储运动信息数据库

**字段结构**：
```javascript
{
  "_id": ObjectId,                    // 运动ID（主键）
  "exercise_name": String,            // 运动名称
  "exercise_category": String,        // 运动分类：cardio/strength/flexibility/balance/sports
  "exercise_subcategory": String,     // 运动子分类
  "calories_per_hour": Number,        // 每小时消耗卡路里
  "intensity_level": String,          // 强度等级：low/medium/high
  "equipment_needed": [String],       // 所需器材
  "target_muscles": [String],         // 目标肌群
  "difficulty_level": String,         // 难度等级：beginner/intermediate/advanced
  "duration_range": {                 // 推荐时长范围
    "min": Number,                    // 最小时长(分钟)
    "max": Number,                    // 最大时长(分钟)
    "recommended": Number             // 推荐时长(分钟)
  },
  "instructions": String,             // 运动说明
  "precautions": [String],           // 注意事项
  "benefits": [String],              // 运动益处
  "video_url": String,                // 教学视频
  "image_url": String,                // 运动图片
  "tags": [String],                   // 标签
  "is_active": Boolean,               // 是否启用
  "search_keywords": [String],        // 搜索关键词
  "created_at": Date,                 // 创建时间
  "updated_at": Date                  // 更新时间
}
```

**索引设计**：
```javascript
// 文本索引
db.exercise_database.createIndex({"exercise_name": "text", "search_keywords": "text"})

// 普通索引
db.exercise_database.createIndex({"exercise_category": 1})
db.exercise_database.createIndex({"intensity_level": 1})
db.exercise_database.createIndex({"difficulty_level": 1})
db.exercise_database.createIndex({"is_active": 1})
db.exercise_database.createIndex({"tags": 1})
db.exercise_database.createIndex({"created_at": -1})
```

### 2.8 目标设定集合（user_goals）

**集合名称**：`user_goals`  
**描述**：存储用户目标设定信息

**字段结构**：
```javascript
{
  "_id": ObjectId,                    // 目标ID（主键）
  "user_id": ObjectId,                // 用户ID（外键）
  "goal_type": String,                // 目标类型：weight_loss/weight_gain/maintenance/muscle_gain
  "goal_name": String,                // 目标名称
  "target_weight": Number,            // 目标体重(kg)
  "current_weight": Number,           // 当前体重(kg)
  "start_weight": Number,             // 起始体重(kg)
  "target_date": Date,                // 目标日期
  "weekly_loss_target": Number,       // 每周减重目标(kg)
  "daily_calorie_target": Number,     // 每日热量目标(kcal)
  "daily_protein_target": Number,     // 每日蛋白质目标(g)
  "daily_fat_target": Number,         // 每日脂肪目标(g)
  "daily_carbs_target": Number,       // 每日碳水化合物目标(g)
  "exercise_minutes_target": Number,  // 每日运动时间目标(分钟)
  "water_intake_target": Number,      // 每日饮水目标(ml)
  "steps_target": Number,             // 每日步数目标
  "status": String,                   // 状态：active/completed/abandoned/paused
  "progress_percentage": Number,      // 进度百分比
  "start_date": Date,                 // 开始日期
  "end_date": Date,                   // 结束日期
  "notes": String,                    // 备注
  "created_at": Date,                 // 创建时间
  "updated_at": Date                  // 更新时间
}
```

**索引设计**：
```javascript
// 复合索引
db.user_goals.createIndex({"user_id": 1, "status": 1})
db.user_goals.createIndex({"user_id": 1, "goal_type": 1})

// 普通索引
db.user_goals.createIndex({"goal_type": 1})
db.user_goals.createIndex({"status": 1})
db.user_goals.createIndex({"target_date": 1})
db.user_goals.createIndex({"created_at": -1})
```

### 2.9 用户统计集合（user_statistics）

**集合名称**：`user_statistics`  
**描述**：存储用户每日统计数据

**字段结构**：
```javascript
{
  "_id": ObjectId,                    // 统计ID（主键）
  "user_id": ObjectId,                // 用户ID（外键）
  "stat_date": Date,                  // 统计日期
  "total_calories": Number,           // 总热量(kcal)
  "total_protein": Number,            // 总蛋白质(g)
  "total_fat": Number,                // 总脂肪(g)
  "total_carbs": Number,              // 总碳水化合物(g)
  "total_fiber": Number,              // 总膳食纤维(g)
  "total_sugar": Number,              // 总糖分(g)
  "total_sodium": Number,             // 总钠(mg)
  "total_exercise_minutes": Number,   // 总运动时间(分钟)
  "total_calories_burned": Number,    // 总消耗热量(kcal)
  "weight_change": Number,            // 体重变化(kg)
  "steps_count": Number,              // 步数
  "water_intake": Number,             // 饮水量(ml)
  "sleep_hours": Number,              // 睡眠时长(小时)
  "meal_count": Number,               // 餐次数量
  "exercise_count": Number,           // 运动次数
  "weight_record_count": Number,      // 体重记录次数
  "ai_chat_count": Number,            // AI对话次数
  "goal_progress": {                  // 目标进度
    "weight_progress": Number,        // 体重目标进度
    "calorie_progress": Number,       // 热量目标进度
    "exercise_progress": Number,      // 运动目标进度
    "water_progress": Number          // 饮水目标进度
  },
  "created_at": Date,                 // 创建时间
  "updated_at": Date                  // 更新时间
}
```

**索引设计**：
```javascript
// 复合索引
db.user_statistics.createIndex({"user_id": 1, "stat_date": -1})
db.user_statistics.createIndex({"user_id": 1, "stat_date": 1})

// 普通索引
db.user_statistics.createIndex({"stat_date": -1})
db.user_statistics.createIndex({"total_calories": 1})
db.user_statistics.createIndex({"total_exercise_minutes": 1})
```

### 2.10 通知集合（notifications）

**集合名称**：`notifications`  
**描述**：存储系统通知信息

**字段结构**：
```javascript
{
  "_id": ObjectId,                    // 通知ID（主键）
  "user_id": ObjectId,                // 用户ID（外键）
  "advisor_id": ObjectId,             // 健康顾问ID（外键，可选）
  "notification_type": String,        // 通知类型：system/reminder/advisor_message/achievement/alert
  "title": String,                    // 通知标题
  "content": String,                  // 通知内容
  "image_url": String,                // 通知图片
  "action_url": String,               // 点击跳转链接
  "action_type": String,              // 操作类型：navigate/open_url/open_modal
  "priority": String,                 // 优先级：low/normal/high/urgent
  "is_read": Boolean,                 // 是否已读
  "read_at": Date,                    // 阅读时间
  "is_sent": Boolean,                 // 是否已发送
  "sent_at": Date,                    // 发送时间
  "scheduled_at": Date,               // 计划发送时间
  "expire_at": Date,                  // 过期时间
  "created_at": Date,                 // 创建时间
  "updated_at": Date                  // 更新时间
}
```

**索引设计**：
```javascript
// 复合索引
db.notifications.createIndex({"user_id": 1, "is_read": 1})
db.notifications.createIndex({"user_id": 1, "notification_type": 1})
db.notifications.createIndex({"user_id": 1, "created_at": -1})

// 普通索引
db.notifications.createIndex({"notification_type": 1})
db.notifications.createIndex({"priority": 1})
db.notifications.createIndex({"is_sent": 1})
db.notifications.createIndex({"scheduled_at": 1})
db.notifications.createIndex({"expire_at": 1})
```

### 2.11 用户反馈集合（user_feedback）

**集合名称**：`user_feedback`  
**描述**：存储用户反馈信息

**字段结构**：
```javascript
{
  "_id": ObjectId,                    // 反馈ID（主键）
  "user_id": ObjectId,                // 用户ID（外键）
  "feedback_type": String,            // 反馈类型：bug/feature/suggestion/complaint/praise
  "category": String,                 // 反馈分类：app/ai/advisor/payment/other
  "title": String,                    // 反馈标题
  "content": String,                  // 反馈内容
  "rating": Number,                   // 评分（1-5）
  "images": [String],                 // 图片URL数组
  "contact_info": {                   // 联系信息
    "phone": String,                  // 手机号
    "email": String                   // 邮箱
  },
  "status": String,                   // 状态：pending/processing/resolved/closed
  "priority": String,                 // 优先级：low/normal/high/urgent
  "assigned_to": ObjectId,            // 分配给谁
  "admin_reply": String,              // 管理员回复
  "reply_at": Date,                   // 回复时间
  "resolved_at": Date,                // 解决时间
  "tags": [String],                   // 标签
  "created_at": Date,                 // 创建时间
  "updated_at": Date                  // 更新时间
}
```

**索引设计**：
```javascript
// 复合索引
db.user_feedback.createIndex({"user_id": 1, "status": 1})
db.user_feedback.createIndex({"feedback_type": 1, "status": 1})

// 普通索引
db.user_feedback.createIndex({"category": 1})
db.user_feedback.createIndex({"status": 1})
db.user_feedback.createIndex({"priority": 1})
db.user_feedback.createIndex({"assigned_to": 1})
db.user_feedback.createIndex({"created_at": -1})
```

### 2.12 会员记录表（membership_records）

**表名**：`membership_records`  
**描述**：存储用户会员等级变更记录

**表结构**：
```sql
CREATE TABLE `membership_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '记录ID（主键）',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID（外键）',
  `old_level` enum('free','standard','premium') DEFAULT NULL COMMENT '原会员等级',
  `new_level` enum('free','standard','premium') NOT NULL COMMENT '新会员等级',
  `change_type` enum('upgrade','downgrade','renewal','expire') NOT NULL COMMENT '变更类型',
  `payment_id` bigint unsigned DEFAULT NULL COMMENT '支付记录ID',
  `amount` decimal(10,2) DEFAULT NULL COMMENT '支付金额',
  `effective_date` datetime NOT NULL COMMENT '生效时间',
  `expire_date` datetime DEFAULT NULL COMMENT '到期时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_created_at` (`user_id`, `created_at`),
  KEY `idx_change_type` (`change_type`),
  KEY `idx_effective_date` (`effective_date`),
  CONSTRAINT `fk_membership_records_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_membership_records_payment_id` FOREIGN KEY (`payment_id`) REFERENCES `payment_records` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='会员记录表';
```

**索引设计**：
```sql
-- 复合索引
ALTER TABLE `membership_records` ADD KEY `idx_user_id_created_at` (`user_id`, `created_at`);

-- 普通索引
ALTER TABLE `membership_records` ADD KEY `idx_change_type` (`change_type`);
ALTER TABLE `membership_records` ADD KEY `idx_effective_date` (`effective_date`);
```

### 2.13 健康顾问收入记录表（advisor_income_records）

**表名**：`advisor_income_records`  
**描述**：存储健康顾问收入记录

**表结构**：
```sql
CREATE TABLE `advisor_income_records` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '记录ID（主键）',
  `advisor_id` bigint unsigned NOT NULL COMMENT '健康顾问ID（外键）',
  `income_type` enum('consultation','review','commission') NOT NULL COMMENT '收入类型',
  `amount` decimal(10,2) NOT NULL COMMENT '收入金额',
  `related_id` bigint unsigned DEFAULT NULL COMMENT '关联记录ID',
  `related_type` varchar(50) DEFAULT NULL COMMENT '关联记录类型',
  `description` varchar(500) DEFAULT NULL COMMENT '收入描述',
  `status` enum('pending','paid','cancelled') DEFAULT 'pending' COMMENT '状态',
  `paid_at` datetime DEFAULT NULL COMMENT '支付时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_advisor_id_created_at` (`advisor_id`, `created_at`),
  KEY `idx_income_type` (`income_type`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_advisor_income_records_advisor_id` FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='健康顾问收入记录表';
```

**索引设计**：
```sql
-- 复合索引
ALTER TABLE `advisor_income_records` ADD KEY `idx_advisor_id_created_at` (`advisor_id`, `created_at`);

-- 普通索引
ALTER TABLE `advisor_income_records` ADD KEY `idx_income_type` (`income_type`);
ALTER TABLE `advisor_income_records` ADD KEY `idx_status` (`status`);
```

### 2.14 审计日志表（audit_logs）

**表名**：`audit_logs`  
**描述**：存储系统审计日志

**表结构**：
```sql
CREATE TABLE `audit_logs` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '审计日志ID（主键）',
  `user_id` bigint unsigned DEFAULT NULL COMMENT '操作用户ID（可选）',
  `advisor_id` bigint unsigned DEFAULT NULL COMMENT '健康顾问ID（可选）',
  `action` enum('create','update','delete','login','logout') NOT NULL COMMENT '操作类型',
  `resource_type` varchar(50) NOT NULL COMMENT '资源类型',
  `resource_id` bigint unsigned NOT NULL COMMENT '资源ID',
  `old_value` json DEFAULT NULL COMMENT '修改前值',
  `new_value` json DEFAULT NULL COMMENT '修改后值',
  `changed_fields` json DEFAULT NULL COMMENT '变更字段',
  `ip_address` varchar(45) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` varchar(500) DEFAULT NULL COMMENT '用户代理',
  `session_id` varchar(100) DEFAULT NULL COMMENT '会话ID',
  `request_id` varchar(100) DEFAULT NULL COMMENT '请求ID',
  `execution_time` int unsigned DEFAULT NULL COMMENT '执行时间(ms)',
  `status` enum('success','failed') NOT NULL COMMENT '操作状态',
  `error_message` text DEFAULT NULL COMMENT '错误信息',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id_created_at` (`user_id`, `created_at`),
  KEY `idx_advisor_id_created_at` (`advisor_id`, `created_at`),
  KEY `idx_resource_type_resource_id` (`resource_type`, `resource_id`),
  KEY `idx_action` (`action`),
  KEY `idx_status` (`status`),
  KEY `idx_ip_address` (`ip_address`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_audit_logs_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_audit_logs_advisor_id` FOREIGN KEY (`advisor_id`) REFERENCES `advisors` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='审计日志表';
```

**索引设计**：
```sql
-- 复合索引
ALTER TABLE `audit_logs` ADD KEY `idx_user_id_created_at` (`user_id`, `created_at`);
ALTER TABLE `audit_logs` ADD KEY `idx_advisor_id_created_at` (`advisor_id`, `created_at`);
ALTER TABLE `audit_logs` ADD KEY `idx_resource_type_resource_id` (`resource_type`, `resource_id`);

-- 普通索引
ALTER TABLE `audit_logs` ADD KEY `idx_action` (`action`);
ALTER TABLE `audit_logs` ADD KEY `idx_status` (`status`);
ALTER TABLE `audit_logs` ADD KEY `idx_ip_address` (`ip_address`);
ALTER TABLE `audit_logs` ADD KEY `idx_created_at` (`created_at`);
```

---

## 3. 数据关系设计

### 3.1 实体关系图

```
用户(users) 1:N 体重记录(weight_records)
用户(users) 1:N 饮食记录(diet_records)
用户(users) 1:N 运动记录(exercise_records)
用户(users) 1:N AI方案(ai_plans)
用户(users) 1:N 聊天记录(chat_messages)
用户(users) 1:N 支付记录(payment_records)
用户(users) 1:N 会员记录(membership_records)
用户(users) 1:N 目标设定(user_goals)
用户(users) 1:N 用户统计(user_statistics)
用户(users) 1:N 通知(notifications)
用户(users) 1:N 用户反馈(user_feedback)
用户(users) 1:N 审计日志(audit_logs)

健康顾问(advisors) 1:N 用户(users)
健康顾问(advisors) 1:N AI方案(ai_plans)
健康顾问(advisors) 1:N 审核记录(review_records)
健康顾问(advisors) 1:N 聊天记录(chat_messages)
健康顾问(advisors) 1:N 通知(notifications)
健康顾问(advisors) 1:N 收入记录(advisor_income_records)
健康顾问(advisors) 1:N 审计日志(audit_logs)

食物数据库(food_database) 1:N 饮食记录(diet_records)
运动数据库(exercise_database) 1:N 运动记录(exercise_records)

AI方案(ai_plans) 1:1 审核记录(review_records)
AI方案(ai_plans) 1:1 目标设定(user_goals)

支付记录(payment_records) 1:1 会员记录(membership_records)
```

### 3.2 外键约束

MySQL使用外键约束保证数据完整性：

1. **用户删除时**：
   - 级联删除用户的所有体重记录（CASCADE）
   - 级联删除用户的所有饮食记录（CASCADE）
   - 级联删除用户的所有运动记录（CASCADE）
   - 级联删除用户的所有AI方案（CASCADE）
   - 级联删除用户的所有聊天记录（CASCADE）
   - 级联删除用户的所有支付记录（CASCADE）
   - 级联删除用户的所有目标设定（CASCADE）
   - 级联删除用户的所有统计数据（CASCADE）
   - 级联删除用户的所有通知（CASCADE）
   - 级联删除用户的所有反馈（CASCADE）

2. **健康顾问删除时**：
   - 将关联用户的advisor_id设为null（SET NULL）
   - 级联删除健康顾问的所有审核记录（CASCADE）
   - 级联删除健康顾问的所有聊天记录（CASCADE）
   - 级联删除健康顾问的所有通知（CASCADE）
   - 级联删除健康顾问的所有收入记录（CASCADE）

3. **AI方案删除时**：
   - 级联删除关联的审核记录（CASCADE）
   - 更新关联的目标设定状态

4. **支付记录删除时**：
   - 将关联的会员记录payment_id设为null（SET NULL）

5. **食物/运动数据库删除时**：
   - 将相关记录的食物/运动ID设为null（SET NULL）
   - 保留历史记录但标记为无效

---

## 4. 数据分表策略

### 4.1 按时间分表

为了提高查询性能，以下集合按时间分表：

1. **体重记录分表**：
   - 按月分表：`weight_records_202508`
   - 保留最近12个月的数据

2. **饮食记录分表**：
   - 按月分表：`diet_records_202508`
   - 保留最近12个月的数据

3. **运动记录分表**：
   - 按月分表：`exercise_records_202508`
   - 保留最近12个月的数据

4. **聊天记录分表**：
   - 按月分表：`chat_messages_202508`
   - 保留最近6个月的数据

5. **用户统计分表**：
   - 按月分表：`user_statistics_202508`
   - 保留最近24个月的数据

6. **操作日志分表**：
   - 按月分表：`operation_logs_202508`
   - 保留最近3个月的数据

7. **审计日志分表**：
   - 按月分表：`audit_logs_202508`
   - 保留最近6个月的数据

### 4.2 分表规则

```sql
-- 获取表名的函数
DELIMITER $$
CREATE FUNCTION getTableName(baseName VARCHAR(50), dateParam DATE) 
RETURNS VARCHAR(100)
DETERMINISTIC
BEGIN
    DECLARE yearStr VARCHAR(4);
    DECLARE monthStr VARCHAR(2);
    DECLARE tableName VARCHAR(100);
    
    SET yearStr = YEAR(dateParam);
    SET monthStr = LPAD(MONTH(dateParam), 2, '0');
    SET tableName = CONCAT(baseName, '_', yearStr, monthStr);
    
    RETURN tableName;
END$$
DELIMITER ;

-- 创建分表的存储过程
DELIMITER $$
CREATE PROCEDURE createMonthlyTable(IN baseTableName VARCHAR(50), IN targetDate DATE)
BEGIN
    DECLARE tableName VARCHAR(100);
    DECLARE sqlStatement TEXT;
    
    SET tableName = getTableName(baseTableName, targetDate);
    
    -- 检查表是否已存在
    IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = tableName) THEN
        SET sqlStatement = CONCAT('CREATE TABLE ', tableName, ' LIKE ', baseTableName);
        SET @sql = sqlStatement;
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
        SELECT CONCAT('Created table: ', tableName) as result;
    ELSE
        SELECT CONCAT('Table already exists: ', tableName) as result;
    END IF;
END$$
DELIMITER ;

-- 使用示例
CALL createMonthlyTable('weight_records', CURDATE());
SELECT getTableName('weight_records', CURDATE());
```

---

## 5. 数据安全设计

### 5.1 数据加密

1. **敏感信息加密**：
   - 用户真实姓名：AES-256加密
   - 用户手机号：AES-256加密
   - 用户邮箱：AES-256加密
   - 健康顾问身份证号：AES-256加密
   - 健康顾问手机号：AES-256加密
   - 支付信息：微信支付加密

2. **数据脱敏**：
   - 用户姓名显示：`李X明`
   - 手机号显示：`138****8888`
   - 身份证号显示：`110***********1234`
   - 邮箱显示：`a***@example.com`

### 5.2 访问控制

1. **用户数据隔离**：
   - 用户只能访问自己的数据
   - 健康顾问只能访问关联用户的数据
   - 管理员只能访问匿名化数据

2. **权限验证**：
   - API接口必须验证用户身份
   - 数据库查询必须包含用户ID过滤
   - 敏感操作需要二次验证

### 5.3 数据脱敏视图

**用户数据脱敏视图**：
```sql
CREATE VIEW `users_desensitized` AS
SELECT 
  id,
  openid,
  CONCAT(LEFT(nickname, 1), '***', RIGHT(nickname, 1)) as nickname,
  CONCAT(LEFT(phone, 3), '****', RIGHT(phone, 4)) as phone,
  CONCAT(LEFT(email, 1), '***@', SUBSTRING_INDEX(email, '@', -1)) as email,
  gender,
  age,
  height,
  current_weight,
  target_weight,
  bmi,
  occupation,
  activity_level,
  health_goals,
  medical_history,
  dietary_restrictions,
  allergies,
  preferred_language,
  timezone,
  advisor_id,
  member_level,
  member_expire,
  status,
  notification_settings,
  privacy_settings,
  last_login,
  login_count,
  created_at,
  updated_at
FROM users;
```

### 5.3 数据备份

1. **自动备份**：
   - 每日凌晨2点自动备份
   - 保留30天的备份文件
   - 异地备份存储

2. **增量备份**：
   - 每小时增量备份
   - 保留7天的增量备份
   - 实时同步关键数据

---

## 6. 性能优化

### 6.1 索引优化

1. **复合索引**：
   - 用户ID + 时间：提高时间范围查询性能
   - 用户ID + 状态：提高状态筛选性能
   - 资源类型 + 资源ID：提高审计查询性能

2. **覆盖索引**：
   - 为常用查询创建覆盖索引
   - 减少回表查询
   - 优化聚合查询性能

3. **文本索引**：
   - 食物数据库文本搜索
   - 运动数据库文本搜索
   - 用户反馈内容搜索

### 6.2 查询优化

1. **分页查询**：
   - 使用skip和limit进行分页
   - 大数据量时使用游标分页
   - 避免深度分页问题

2. **聚合查询**：
   - 使用MongoDB聚合管道
   - 合理使用$match、$group、$sort
   - 利用索引优化聚合查询

### 6.3 缓存策略

1. **Redis缓存键结构**：
```javascript
const CACHE_KEYS = {
  // 用户相关
  USER_INFO: 'user:{userId}',
  USER_STATS: 'stats:{userId}:{date}',
  USER_GOALS: 'goals:{userId}',
  
  // 健康顾问相关
  ADVISOR_INFO: 'advisor:{advisorId}',
  ADVISOR_PATIENTS: 'advisor_patients:{advisorId}',
  
  // 数据库相关
  FOOD_DATABASE: 'food:{foodId}',
  EXERCISE_DATABASE: 'exercise:{exerciseId}',
  
  // 系统配置
  SYSTEM_CONFIG: 'config:{key}',
  
  // 统计数据
  DAILY_STATS: 'daily_stats:{userId}:{date}',
  WEEKLY_STATS: 'weekly_stats:{userId}:{week}',
  MONTHLY_STATS: 'monthly_stats:{userId}:{month}'
};
```

2. **缓存更新策略**：
   - 数据变更时自动更新缓存
   - 设置合理的缓存过期时间
   - 缓存预热机制
   - 缓存穿透保护

3. **缓存过期时间**：
```javascript
const CACHE_TTL = {
  USER_INFO: 3600,           // 1小时
  ADVISOR_INFO: 3600,        // 1小时
  FOOD_DATABASE: 86400,      // 24小时
  EXERCISE_DATABASE: 86400,  // 24小时
  SYSTEM_CONFIG: 3600,       // 1小时
  DAILY_STATS: 300,          // 5分钟
  WEEKLY_STATS: 3600,        // 1小时
  MONTHLY_STATS: 86400       // 24小时
};
```

---

## 7. 数据验证规则

### 7.1 用户数据验证

```javascript
// 用户数据验证
function validateUser(user) {
  const errors = [];
  
  if (!user.openid) {
    errors.push("openid is required");
  }
  
  if (user.age < 18 || user.age > 100) {
    errors.push("age must be between 18 and 100");
  }
  
  if (user.height < 100 || user.height > 250) {
    errors.push("height must be between 100 and 250");
  }
  
  if (user.current_weight < 30 || user.current_weight > 300) {
    errors.push("current_weight must be between 30 and 300");
  }
  
  if (user.bmi < 10 || user.bmi > 50) {
    errors.push("bmi must be between 10 and 50");
  }
  
  const validStatuses = ['active', 'inactive', 'blocked', 'pending'];
  if (!validStatuses.includes(user.status)) {
    errors.push("status must be one of: " + validStatuses.join(', '));
  }
  
  const validMemberLevels = ['free', 'standard', 'premium'];
  if (!validMemberLevels.includes(user.member_level)) {
    errors.push("member_level must be one of: " + validMemberLevels.join(', '));
  }
  
  const validActivityLevels = ['sedentary', 'light', 'moderate', 'active'];
  if (!validActivityLevels.includes(user.activity_level)) {
    errors.push("activity_level must be one of: " + validActivityLevels.join(', '));
  }
  
  return errors;
}
```

### 7.2 体重记录验证

```javascript
// 体重记录验证
function validateWeightRecord(record) {
  const errors = [];
  
  if (!record.user_id) {
    errors.push("user_id is required");
  }
  
  if (record.weight < 30 || record.weight > 300) {
    errors.push("weight must be between 30 and 300");
  }
  
  if (record.bmi < 10 || record.bmi > 50) {
    errors.push("bmi must be between 10 and 50");
  }
  
  const validRecordTypes = ['manual', 'photo', 'auto'];
  if (!validRecordTypes.includes(record.record_type)) {
    errors.push("record_type must be one of: " + validRecordTypes.join(', '));
  }
  
  return errors;
}
```

### 7.3 饮食记录验证

```javascript
// 饮食记录验证
function validateDietRecord(record) {
  const errors = [];
  
  if (!record.user_id) {
    errors.push("user_id is required");
  }
  
  if (record.calories < 0 || record.calories > 10000) {
    errors.push("calories must be between 0 and 10000");
  }
  
  if (record.protein < 0 || record.protein > 1000) {
    errors.push("protein must be between 0 and 1000");
  }
  
  if (record.fat < 0 || record.fat > 1000) {
    errors.push("fat must be between 0 and 1000");
  }
  
  if (record.carbs < 0 || record.carbs > 1000) {
    errors.push("carbs must be between 0 and 1000");
  }
  
  const validMealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
  if (!validMealTypes.includes(record.meal_type)) {
    errors.push("meal_type must be one of: " + validMealTypes.join(', '));
  }
  
  const validRecordTypes = ['manual', 'photo', 'ai'];
  if (!validRecordTypes.includes(record.record_type)) {
    errors.push("record_type must be one of: " + validRecordTypes.join(', '));
  }
  
  return errors;
}
```

### 7.4 运动记录验证

```javascript
// 运动记录验证
function validateExerciseRecord(record) {
  const errors = [];
  
  if (!record.user_id) {
    errors.push("user_id is required");
  }
  
  if (record.duration < 1 || record.duration > 480) {
    errors.push("duration must be between 1 and 480 minutes");
  }
  
  if (record.calories_burned < 0 || record.calories_burned > 5000) {
    errors.push("calories_burned must be between 0 and 5000");
  }
  
  const validIntensities = ['low', 'medium', 'high'];
  if (!validIntensities.includes(record.intensity)) {
    errors.push("intensity must be one of: " + validIntensities.join(', '));
  }
  
  const validRecordTypes = ['manual', 'photo', 'auto'];
  if (!validRecordTypes.includes(record.record_type)) {
    errors.push("record_type must be one of: " + validRecordTypes.join(', '));
  }
  
  return errors;
}
```

### 9.3 常用查询示例

```sql
-- 获取用户体重趋势
SELECT 
    DATE(record_date) as date,
    AVG(weight) as avg_weight,
    AVG(bmi) as avg_bmi
FROM weight_records 
WHERE user_id = ? 
GROUP BY DATE(record_date) 
ORDER BY date;

-- 获取用户每日热量统计
SELECT 
    DATE(record_date) as date,
    SUM(calories) as total_calories,
    SUM(protein) as total_protein,
    SUM(fat) as total_fat,
    SUM(carbs) as total_carbs
FROM diet_records 
WHERE user_id = ? 
GROUP BY DATE(record_date) 
ORDER BY date;

-- 获取健康顾问的患者列表
SELECT 
    nickname, 
    current_weight, 
    bmi, 
    last_login
FROM users 
WHERE advisor_id = ? AND status = 'active' 
ORDER BY last_login DESC;

-- 获取用户目标进度
SELECT 
    ug.goal_name,
    ug.target_weight,
    ug.current_weight,
    ug.progress_percentage,
    wr.weight as latest_weight
FROM user_goals ug
LEFT JOIN weight_records wr ON ug.user_id = wr.user_id
WHERE ug.user_id = ? AND ug.status = 'active'
ORDER BY wr.record_date DESC
LIMIT 1;

-- 获取用户统计数据
SELECT 
    AVG(total_calories) as avg_calories,
    AVG(total_exercise_minutes) as avg_exercise_minutes,
    SUM(weight_change) as total_weight_change
FROM user_statistics 
WHERE user_id = ? 
ORDER BY stat_date DESC 
LIMIT 30;

-- 搜索食物数据库
SELECT 
    food_name,
    food_category,
    calories_per_100g,
    protein_per_100g,
    fat_per_100g,
    carbs_per_100g
FROM food_database 
WHERE MATCH(food_name, search_keywords) AGAINST('苹果' IN NATURAL LANGUAGE MODE)
AND is_active = 1
ORDER BY MATCH(food_name, search_keywords) AGAINST('苹果' IN NATURAL LANGUAGE MODE) DESC;

-- 获取待审核的AI方案
SELECT 
    plan_name, 
    user_id, 
    created_at
FROM ai_plans 
WHERE status = 'pending' 
ORDER BY created_at;

-- 获取用户未读通知
SELECT 
    title, 
    content, 
    notification_type, 
    created_at
FROM notifications 
WHERE user_id = ? AND is_read = 0 
ORDER BY created_at DESC;

-- 获取用户会员变更记录
SELECT 
    old_level,
    new_level,
    change_type,
    amount,
    effective_date,
    expire_date
FROM membership_records 
WHERE user_id = ? 
ORDER BY created_at DESC;

-- 获取健康顾问收入统计
SELECT 
    income_type,
    SUM(amount) as total_amount,
    COUNT(*) as record_count
FROM advisor_income_records 
WHERE advisor_id = ? AND status = 'paid'
GROUP BY income_type;

-- 获取待审核的AI方案（包含审核人信息）
SELECT 
    ap.plan_name, 
    ap.user_id,
    ap.created_at,
    a.name as advisor_name
FROM ai_plans ap
LEFT JOIN advisors a ON ap.reviewed_by = a.id
WHERE ap.status = 'pending' 
ORDER BY ap.created_at;
```

---

## 8. 数据迁移策略

### 8.1 版本升级

1. **数据库版本管理**：
   - 记录每次数据库结构变更
   - 提供数据迁移脚本
   - 版本号管理：v1.0.0

2. **向后兼容**：
   - 新版本保持向后兼容
   - 逐步废弃旧字段
   - 字段重命名策略

### 8.2 数据清理

1. **过期数据清理**：
   - 定期清理过期数据
   - 保留必要的统计数据
   - 数据归档策略

2. **数据归档**：
   - 将历史数据归档到冷存储
   - 减少主数据库压力
   - 归档数据恢复机制

---

## 9. 监控和告警

### 9.1 性能监控

1. **查询性能**：
   - 监控慢查询（>100ms）
   - 监控索引使用情况
   - 查询频率统计

2. **存储监控**：
   - 监控数据库大小
   - 监控磁盘使用率
   - 连接数监控

### 9.2 业务监控

1. **数据质量**：
   - 监控数据完整性
   - 监控数据一致性
   - 数据异常检测

2. **业务指标**：
   - 监控用户活跃度
   - 监控系统使用情况
   - 关键业务指标监控

### 9.3 安全监控

1. **访问监控**：
   - 异常登录检测
   - 权限变更监控
   - 敏感操作审计

2. **数据安全**：
   - 数据泄露检测
   - 加密状态监控
   - 备份完整性检查

---

## 10. 附录

### 10.1 数据库初始化脚本

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS weight_management 
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE weight_management;

-- 创建表（按依赖顺序）
-- 1. 健康顾问表（无外键依赖）
CREATE TABLE `advisors` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '健康顾问ID（主键）',
  `name` varchar(100) NOT NULL COMMENT '姓名',
  `avatar` varchar(500) DEFAULT NULL COMMENT '头像URL',
  `phone` varchar(20) NOT NULL COMMENT '手机号（加密）',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `id_card` varchar(20) DEFAULT NULL COMMENT '身份证号（加密）',
  `license_number` varchar(50) DEFAULT NULL COMMENT '执业证书号',
  `specialty` json DEFAULT NULL COMMENT '专业领域数组',
  `specialization` json DEFAULT NULL COMMENT '专业特长',
  `qualification` varchar(200) DEFAULT NULL COMMENT '资质证书',
  `education` varchar(100) DEFAULT NULL COMMENT '学历',
  `work_experience` text DEFAULT NULL COMMENT '工作经历',
  `hospital` varchar(200) DEFAULT NULL COMMENT '合作医院',
  `description` text DEFAULT NULL COMMENT '专业描述',
  `experience_years` tinyint unsigned DEFAULT NULL COMMENT '从业年限',
  `consultation_fee` int unsigned DEFAULT 0 COMMENT '咨询费用（分）',
  `user_count` int unsigned DEFAULT 0 COMMENT '服务用户数',
  `rating` decimal(2,1) DEFAULT NULL COMMENT '评分（1-5）',
  `total_income` bigint unsigned DEFAULT 0 COMMENT '总收入（分）',
  `monthly_income` bigint unsigned DEFAULT 0 COMMENT '月收入（分）',
  `status` enum('active','inactive','blocked','pending') DEFAULT 'pending' COMMENT '状态',
  `verification_status` enum('pending','verified','rejected') DEFAULT 'pending' COMMENT '认证状态',
  `is_online` tinyint(1) DEFAULT 0 COMMENT '是否在线',
  `max_users` int unsigned DEFAULT 100 COMMENT '最大服务用户数',
  `max_daily_consultations` int unsigned DEFAULT 20 COMMENT '每日最大咨询数',
  `response_time` int unsigned DEFAULT NULL COMMENT '平均响应时间（分钟）',
  `available_time` json DEFAULT NULL COMMENT '可服务时间',
  `service_areas` json DEFAULT NULL COMMENT '服务区域',
  `languages` json DEFAULT NULL COMMENT '掌握语言',
  `certificates` json DEFAULT NULL COMMENT '证书信息',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_phone` (`phone`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_id_card` (`id_card`),
  UNIQUE KEY `uk_license_number` (`license_number`),
  KEY `idx_status` (`status`),
  KEY `idx_verification_status` (`verification_status`),
  KEY `idx_rating` (`rating`),
  KEY `idx_user_count` (`user_count`),
  KEY `idx_is_online` (`is_online`),
  KEY `idx_consultation_fee` (`consultation_fee`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='健康顾问表';

-- 2. 用户表
CREATE TABLE `users` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '用户ID（主键）',
  `openid` varchar(64) NOT NULL COMMENT '微信openid',
  `unionid` varchar(64) DEFAULT NULL COMMENT '微信unionid',
  `nickname` varchar(50) DEFAULT NULL COMMENT '脱敏姓名（李X明）',
  `real_name` varchar(100) DEFAULT NULL COMMENT '真实姓名（加密存储）',
  `avatar` varchar(500) DEFAULT NULL COMMENT '头像URL',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号（加密）',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `gender` enum('male','female') DEFAULT NULL COMMENT '性别',
  `age` tinyint unsigned DEFAULT NULL COMMENT '年龄',
  `birth_date` date DEFAULT NULL COMMENT '出生日期',
  `height` decimal(5,2) DEFAULT NULL COMMENT '身高(cm)',
  `current_weight` decimal(5,2) DEFAULT NULL COMMENT '当前体重(kg)',
  `target_weight` decimal(5,2) DEFAULT NULL COMMENT '目标体重(kg)',
  `bmi` decimal(4,2) DEFAULT NULL COMMENT 'BMI指数',
  `occupation` varchar(100) DEFAULT NULL COMMENT '职业',
  `activity_level` enum('sedentary','light','moderate','active') DEFAULT NULL COMMENT '活动水平',
  `health_goals` json DEFAULT NULL COMMENT '健康目标数组',
  `medical_history` json DEFAULT NULL COMMENT '病史数组',
  `dietary_restrictions` json DEFAULT NULL COMMENT '饮食限制',
  `allergies` json DEFAULT NULL COMMENT '过敏信息',
  `preferred_language` varchar(10) DEFAULT 'zh-CN' COMMENT '首选语言',
  `timezone` varchar(50) DEFAULT 'Asia/Shanghai' COMMENT '时区',
  `advisor_id` bigint unsigned DEFAULT NULL COMMENT '关联健康顾问ID',
  `member_level` enum('free','standard','premium') DEFAULT 'free' COMMENT '会员等级',
  `member_expire` datetime DEFAULT NULL COMMENT '会员到期时间',
  `status` enum('active','inactive','blocked','pending') DEFAULT 'active' COMMENT '状态',
  `notification_settings` json DEFAULT NULL COMMENT '通知设置',
  `privacy_settings` json DEFAULT NULL COMMENT '隐私设置',
  `last_login` datetime DEFAULT NULL COMMENT '最后登录时间',
  `login_count` int unsigned DEFAULT 0 COMMENT '登录次数',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  KEY `idx_advisor_id` (`advisor_id`),
  KEY `idx_member_level` (`member_level`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

-- 插入初始配置
INSERT INTO system_configs (config_key, config_value, config_type, description, category, is_active) VALUES
('ai_daily_limit', '5', 'number', '免费用户每日AI对话次数限制', 'ai', 1),
('review_timeout_hours', '24', 'number', '审核超时时间（小时）', 'review', 1),
('max_weight_records_per_day', '10', 'number', '每日最大体重记录次数', 'record', 1),
('max_diet_records_per_day', '20', 'number', '每日最大饮食记录次数', 'record', 1),
('max_exercise_records_per_day', '10', 'number', '每日最大运动记录次数', 'record', 1),
('membership_upgrade_fee', '9900', 'number', '会员升级费用（分）', 'payment', 1),
('review_fee', '5000', 'number', '审核费用（分）', 'payment', 1),
('advisor_commission_rate', '0.7', 'number', '健康顾问分成比例', 'payment', 1);
```

### 10.2 常用查询示例

```javascript
// 获取用户体重趋势
db.weight_records.aggregate([
  { $match: { user_id: ObjectId("...") } },
  { $sort: { record_date: 1 } },
  { $group: {
    _id: { $dateToString: { format: "%Y-%m-%d", date: "$record_date" } },
    weight: { $avg: "$weight" },
    bmi: { $avg: "$bmi" }
  }},
  { $sort: { _id: 1 } }
]);

// 获取用户每日热量统计
db.diet_records.aggregate([
  { $match: { user_id: ObjectId("...") } },
  { $group: {
    _id: { $dateToString: { format: "%Y-%m-%d", date: "$record_date" } },
    total_calories: { $sum: "$calories" },
    total_protein: { $sum: "$protein" },
    total_fat: { $sum: "$fat" },
    total_carbs: { $sum: "$carbs" }
  }},
  { $sort: { _id: 1 } }
]);

// 获取健康顾问的患者列表
db.users.find(
  { advisor_id: ObjectId("..."), status: "active" },
  { nickname: 1, current_weight: 1, bmi: 1, last_login: 1 }
).sort({ last_login: -1 });

// 获取用户目标进度
db.user_goals.aggregate([
  { $match: { user_id: ObjectId("..."), status: "active" } },
  { $lookup: {
    from: "weight_records",
    localField: "user_id",
    foreignField: "user_id",
    as: "weight_records"
  }},
  { $project: {
    goal_name: 1,
    target_weight: 1,
    current_weight: 1,
    progress_percentage: 1,
    latest_weight: { $arrayElemAt: ["$weight_records.weight", -1] }
  }}
]);

// 获取用户统计数据
db.user_statistics.aggregate([
  { $match: { user_id: ObjectId("...") } },
  { $sort: { stat_date: -1 } },
  { $limit: 30 },
  { $group: {
    _id: null,
    avg_calories: { $avg: "$total_calories" },
    avg_exercise_minutes: { $avg: "$total_exercise_minutes" },
    total_weight_change: { $sum: "$weight_change" }
  }}
]);

// 搜索食物数据库
db.food_database.find(
  { $text: { $search: "苹果" } },
  { score: { $meta: "textScore" } }
).sort({ score: { $meta: "textScore" } });

// 获取待审核的AI方案
db.ai_plans.find(
  { status: "pending" },
  { plan_name: 1, user_id: 1, created_at: 1 }
).sort({ created_at: 1 });

// 获取用户未读通知
db.notifications.find(
  { user_id: ObjectId("..."), is_read: false },
  { title: 1, content: 1, notification_type: 1, created_at: 1 }
).sort({ created_at: -1 });
```

### 10.3 数据备份脚本

```javascript
// 数据备份脚本
const backupCollections = [
  'users',
  'advisors', 
  'weight_records',
  'diet_records',
  'exercise_records',
  'ai_plans',
  'chat_messages',
  'review_records',
  'payment_records',
  'membership_records',
  'advisor_income_records',
  'system_configs',
  'operation_logs',
  'food_database',
  'exercise_database',
  'user_goals',
  'user_statistics',
  'notifications',
  'user_feedback',
  'audit_logs'
];

// 备份函数
function backupCollection(collectionName) {
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const backupName = `${collectionName}_backup_${timestamp}`;
  
  db.runCommand({
    cloneCollection: `weight_management.${collectionName}`,
    collection: backupName
  });
  
  print(`Backed up ${collectionName} to ${backupName}`);
}

// 执行备份
backupCollections.forEach(backupCollection);
```

### 10.4 数据清理脚本

```javascript
// 数据清理脚本
const CLEANUP_RULES = {
  // 清理超过6个月的聊天记录
  chat_messages: {
    condition: { created_at: { $lt: new Date(Date.now() - 180 * 24 * 60 * 60 * 1000) } },
    action: "delete"
  },
  
  // 清理超过3个月的操作日志
  operation_logs: {
    condition: { created_at: { $lt: new Date(Date.now() - 90 * 24 * 60 * 60 * 1000) } },
    action: "delete"
  },
  
  // 清理超过1年的审计日志
  audit_logs: {
    condition: { created_at: { $lt: new Date(Date.now() - 365 * 24 * 60 * 60 * 1000) } },
    action: "archive"
  },
  
  // 清理已完成的用户目标
  user_goals: {
    condition: { 
      status: "completed", 
      updated_at: { $lt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) } 
    },
    action: "archive"
  }
};

// 清理函数
function cleanupData() {
  Object.keys(CLEANUP_RULES).forEach(collectionName => {
    const rule = CLEANUP_RULES[collectionName];
    const count = db[collectionName].count(rule.condition);
    
    if (count > 0) {
      if (rule.action === "delete") {
        db[collectionName].deleteMany(rule.condition);
        print(`Deleted ${count} records from ${collectionName}`);
      } else if (rule.action === "archive") {
        // 归档到冷存储
        const archivedData = db[collectionName].find(rule.condition).toArray();
        db[`${collectionName}_archive`].insertMany(archivedData);
        db[collectionName].deleteMany(rule.condition);
        print(`Archived ${count} records from ${collectionName}`);
      }
    }
  });
}

// 执行清理
cleanupData();
```

### 10.5 性能优化脚本

```javascript
// 性能优化脚本
function optimizeDatabase() {
  // 1. 分析索引使用情况
  const indexStats = db.runCommand({ collStats: "users" });
  print("Index usage statistics:", JSON.stringify(indexStats, null, 2));
  
  // 2. 创建缺失的索引
  const missingIndexes = [
    { collection: "weight_records", index: { "user_id": 1, "record_date": -1 } },
    { collection: "diet_records", index: { "user_id": 1, "meal_type": 1, "record_date": -1 } },
    { collection: "exercise_records", index: { "user_id": 1, "exercise_type": 1 } },
    { collection: "ai_plans", index: { "user_id": 1, "status": 1 } },
    { collection: "chat_messages", index: { "user_id": 1, "advisor_id": 1, "created_at": -1 } }
  ];
  
  missingIndexes.forEach(({ collection, index }) => {
    try {
      db[collection].createIndex(index);
      print(`Created index for ${collection}`);
    } catch (error) {
      print(`Index already exists for ${collection}`);
    }
  });
  
  // 3. 更新统计信息
  db.runCommand({ compact: "users" });
  db.runCommand({ compact: "weight_records" });
  db.runCommand({ compact: "diet_records" });
  
  print("Database optimization completed");
}

// 执行优化
optimizeDatabase();
```

这份完善的数据库设计文档现在包含了：

1. **完整的集合设计**：18个核心集合，涵盖所有业务场景
2. **详细的字段结构**：每个字段都有明确的类型、约束和说明
3. **优化的索引设计**：复合索引、文本索引、唯一索引的合理配置
4. **完善的安全措施**：数据加密、脱敏、访问控制、审计日志
5. **性能优化策略**：分表策略、缓存策略、查询优化
6. **数据验证规则**：完整的数据完整性检查
7. **实用工具脚本**：初始化、备份、清理、优化脚本

这个数据库设计文档为体重管理数字医生小程序项目提供了坚实的技术基础，确保系统能够高效、安全、可扩展地运行。
