# 体重管理数字医生小程序 - 技术架构文档

## 1. 系统架构

### 1.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   微信小程序    │    │   健康顾问端    │    │   管理后台      │
│   (用户端)      │    │   (Web/H5)      │    │   (Web)         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   腾讯云CloudBase│
                    │                 │
                    │  ┌─────────────┐ │
                    │  │  云函数     │ │
                    │  │  (后端API)  │ │
                    │  └─────────────┘ │
                    │                 │
                    │  ┌─────────────┐ │
                    │  │  云数据库   │ │
                    │  │  (MongoDB)  │ │
                    │  └─────────────┘ │
                    │                 │
                    │  ┌─────────────┐ │
                    │  │  云存储     │ │
                    │  │  (图片/文件)│ │
                    │  └─────────────┘ │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │   DeepSeek API  │
                    │  (AI对话/识别)  │
                    └─────────────────┘
```

### 1.2 技术栈
- **前端**：微信小程序 + WXML/WXSS/JavaScript
- **后端**：腾讯云 CloudBase + 云函数
- **数据库**：云数据库（MongoDB）
- **AI服务**：DeepSeek API
- **图片识别**：DeepSeek图像识别
- **存储**：云存储
- **支付**：微信支付

## 2. 数据库设计

### 2.1 数据库集合结构

#### 2.1.1 用户集合（users）
```javascript
{
  "_id": "ObjectId",           // 用户ID
  "openid": "String",          // 微信openid
  "nickname": "String",        // 脱敏姓名（李X明）
  "real_name": "String",       // 真实姓名（加密存储）
  "avatar": "String",          // 头像URL
  "gender": "String",          // 性别：male/female
  "age": "Number",             // 年龄
  "height": "Number",          // 身高(cm)
  "current_weight": "Number",  // 当前体重(kg)
  "target_weight": "Number",   // 目标体重(kg)
  "bmi": "Number",             // BMI指数
  "health_goals": ["String"],  // 健康目标数组
  "medical_history": ["String"], // 病史数组
  "advisor_id": "ObjectId",    // 关联健康顾问ID
  "member_level": "String",    // 会员等级：free/standard/premium
  "member_expire": "Date",     // 会员到期时间
  "status": "String",          // 状态：active/inactive
  "created_at": "Date",        // 创建时间
  "updated_at": "Date"         // 更新时间
}
```

#### 2.1.2 健康顾问集合（advisors）
```javascript
{
  "_id": "ObjectId",           // 健康顾问ID
  "name": "String",            // 姓名
  "avatar": "String",          // 头像URL
  "phone": "String",           // 手机号
  "specialty": ["String"],     // 专业领域数组
  "qualification": "String",   // 资质证书
  "hospital": "String",        // 合作医院
  "description": "String",     // 专业描述
  "user_count": "Number",      // 服务用户数
  "rating": "Number",          // 评分
  "total_income": "Number",    // 总收入
  "status": "String",          // 状态：active/inactive
  "created_at": "Date",        // 创建时间
  "updated_at": "Date"         // 更新时间
}
```

#### 2.1.3 体重记录集合（weight_records）
```javascript
{
  "_id": "ObjectId",           // 记录ID
  "user_id": "ObjectId",       // 用户ID
  "weight": "Number",          // 体重(kg)
  "bmi": "Number",             // BMI指数
  "record_date": "Date",       // 记录日期
  "record_type": "String",     // 记录类型：manual/photo
  "photo_url": "String",       // 照片URL
  "note": "String",            // 备注
  "created_at": "Date"         // 创建时间
}
```

#### 2.1.4 饮食记录集合（diet_records）
```javascript
{
  "_id": "ObjectId",           // 记录ID
  "user_id": "ObjectId",       // 用户ID
  "food_name": "String",       // 食物名称
  "calories": "Number",        // 热量(kcal)
  "protein": "Number",         // 蛋白质(g)
  "fat": "Number",             // 脂肪(g)
  "carbs": "Number",           // 碳水化合物(g)
  "fiber": "Number",           // 膳食纤维(g)
  "photo_url": "String",       // 照片URL
  "meal_type": "String",       // 餐次：breakfast/lunch/dinner/snack
  "record_date": "Date",       // 记录日期
  "note": "String",            // 备注
  "created_at": "Date"         // 创建时间
}
```

#### 2.1.5 AI方案集合（ai_plans）
```javascript
{
  "_id": "ObjectId",           // 方案ID
  "user_id": "ObjectId",       // 用户ID
  "advisor_id": "ObjectId",    // 健康顾问ID
  "plan_name": "String",       // 方案名称
  "plan_type": "String",       // 方案类型：weight_loss/health_improve
  "target_weight": "Number",   // 目标体重
  "duration": "Number",        // 持续时间(天)
  "expected_loss": "Number",   // 预期减重(kg)
  "daily_calories": "Number",  // 每日热量
  "diet_plan": "String",       // 饮食计划
  "exercise_plan": "String",   // 运动计划
  "status": "String",          // 状态：pending/approved/rejected
  "review_comment": "String",  // 审核意见
  "review_fee": "Number",      // 审核费用
  "created_at": "Date",        // 创建时间
  "reviewed_at": "Date"        // 审核时间
}
```

#### 2.1.6 聊天记录集合（advisor_messages）
```javascript
{
  "_id": "ObjectId",           // 消息ID
  "user_id": "ObjectId",       // 用户ID
  "advisor_id": "ObjectId",    // 健康顾问ID
  "sender_type": "String",     // 发送者类型：user/advisor
  "message_type": "String",    // 消息类型：text/image
  "content": "String",         // 消息内容
  "image_url": "String",       // 图片URL
  "is_read": "Boolean",        // 是否已读
  "created_at": "Date"         // 创建时间
}
```

#### 2.1.7 收入记录集合（income_records）
```javascript
{
  "_id": "ObjectId",           // 记录ID
  "advisor_id": "ObjectId",    // 健康顾问ID
  "user_id": "ObjectId",       // 用户ID
  "type": "String",            // 收入类型：review/member/extra
  "amount": "Number",          // 金额
  "description": "String",     // 描述
  "status": "String",          // 状态：pending/paid
  "created_at": "Date"         // 创建时间
}
```

### 2.2 索引设计
```javascript
// users集合索引
db.users.createIndex({"openid": 1}, {unique: true})
db.users.createIndex({"advisor_id": 1})
db.users.createIndex({"member_level": 1})

// weight_records集合索引
db.weight_records.createIndex({"user_id": 1, "record_date": -1})
db.weight_records.createIndex({"user_id": 1, "created_at": -1})

// diet_records集合索引
db.diet_records.createIndex({"user_id": 1, "record_date": -1})
db.diet_records.createIndex({"user_id": 1, "meal_type": 1})

// ai_plans集合索引
db.ai_plans.createIndex({"user_id": 1, "status": 1})
db.ai_plans.createIndex({"advisor_id": 1, "status": 1})

// advisor_messages集合索引
db.advisor_messages.createIndex({"user_id": 1, "advisor_id": 1, "created_at": -1})
```

## 3. API设计

### 3.1 用户端API

#### 3.1.1 用户管理
```javascript
// 用户注册
POST /api/user/register
{
  "nickname": "String",
  "gender": "String",
  "age": "Number",
  "height": "Number",
  "current_weight": "Number",
  "target_weight": "Number",
  "health_goals": ["String"],
  "medical_history": ["String"]
}

// 获取用户信息
GET /api/user/profile

// 更新用户信息
PUT /api/user/profile
{
  "nickname": "String",
  "height": "Number",
  "target_weight": "Number"
}
```

#### 3.1.2 体重管理
```javascript
// 记录体重
POST /api/weight/record
{
  "weight": "Number",
  "record_type": "String",
  "photo_url": "String",
  "note": "String"
}

// 获取体重记录
GET /api/weight/records?page=1&limit=20

// 获取体重趋势
GET /api/weight/trend?days=30
```

#### 3.1.3 饮食管理
```javascript
// 记录饮食
POST /api/diet/record
{
  "food_name": "String",
  "calories": "Number",
  "protein": "Number",
  "fat": "Number",
  "carbs": "Number",
  "meal_type": "String",
  "photo_url": "String"
}

// 获取饮食记录
GET /api/diet/records?date=2025-08-08

// 获取营养分析
GET /api/diet/analysis?days=7
```

#### 3.1.4 AI对话
```javascript
// 发送消息
POST /api/ai/chat
{
  "message": "String",
  "message_type": "String"
}

// 获取聊天记录
GET /api/ai/chat/history?page=1&limit=20

// 生成方案
POST /api/ai/generate-plan
{
  "goal": "String",
  "preferences": "Object"
}
```

### 3.2 健康顾问端API

#### 3.2.1 患者管理
```javascript
// 获取患者列表
GET /api/advisor/patients?status=all&page=1&limit=20

// 获取患者详情
GET /api/advisor/patient/:userId

// 获取患者数据
GET /api/advisor/patient/:userId/data?type=weight&days=30
```

#### 3.2.2 方案审核
```javascript
// 获取待审核方案
GET /api/advisor/pending-plans?page=1&limit=20

// 审核方案
POST /api/advisor/review-plan
{
  "plan_id": "String",
  "status": "String",
  "comment": "String"
}

// 获取审核历史
GET /api/advisor/review-history?page=1&limit=20
```

#### 3.2.3 聊天功能
```javascript
// 发送消息
POST /api/advisor/send-message
{
  "user_id": "String",
  "message": "String",
  "message_type": "String"
}

// 获取聊天记录
GET /api/advisor/chat/:userId?page=1&limit=20
```

## 4. 云函数设计

### 4.1 核心云函数

#### 4.1.1 用户管理函数
```javascript
// user-register.js
exports.main = async (event, context) => {
  // 用户注册逻辑
  // 验证微信登录
  // 创建用户记录
  // 返回用户信息
}

// user-profile.js
exports.main = async (event, context) => {
  // 获取/更新用户信息
  // 数据脱敏处理
  // 权限验证
}
```

#### 4.1.2 AI服务函数
```javascript
// ai-chat.js
exports.main = async (event, context) => {
  // 调用DeepSeek API
  // 处理对话逻辑
  // 保存聊天记录
}

// ai-image-recognition.js
exports.main = async (event, context) => {
  // 调用DeepSeek图像识别
  // 识别食物/体重秤
  // 返回识别结果
}

// ai-plan-generator.js
exports.main = async (event, context) => {
  // 分析用户数据
  // 生成个性化方案
  // 保存方案记录
}
```

#### 4.1.3 数据管理函数
```javascript
// weight-record.js
exports.main = async (event, context) => {
  // 记录体重数据
  // 计算BMI
  // 更新用户信息
}

// diet-record.js
exports.main = async (event, context) => {
  // 记录饮食数据
  // 计算营养信息
  // 保存记录
}
```

#### 4.1.4 健康顾问函数
```javascript
// advisor-patients.js
exports.main = async (event, context) => {
  // 获取患者列表
  // 数据权限验证
  // 返回脱敏数据
}

// advisor-review.js
exports.main = async (event, context) => {
  // 审核方案
  // 计算收入
  // 发送通知
}
```

### 4.2 定时任务函数
```javascript
// daily-reminder.js
exports.main = async (event, context) => {
  // 每日提醒任务
  // 发送体重记录提醒
  // 发送饮食记录提醒
}

// weekly-report.js
exports.main = async (event, context) => {
  // 周报生成
  // 分析用户数据
  // 生成报告
}
```

## 5. 安全设计

### 5.1 数据安全
- **数据脱敏**：用户姓名脱敏显示
- **数据加密**：敏感信息加密存储
- **权限控制**：基于用户ID的数据访问控制
- **数据备份**：定期备份重要数据

### 5.2 接口安全
- **身份验证**：微信登录验证
- **权限验证**：健康顾问只能访问自己的用户数据
- **频率限制**：API调用频率限制
- **参数验证**：严格的参数验证

### 5.3 隐私保护
- **最小权限**：只收集必要的数据
- **用户控制**：用户可以删除自己的数据
- **数据匿名化**：统计分析使用匿名数据
- **合规性**：符合相关法律法规

## 6. 性能优化

### 6.1 数据库优化
- **索引优化**：合理设计数据库索引
- **查询优化**：避免复杂的聚合查询
- **分页查询**：大数据量使用分页
- **缓存策略**：热点数据使用缓存

### 6.2 接口优化
- **响应时间**：平均响应时间<2秒
- **并发处理**：支持高并发访问
- **错误处理**：完善的错误处理机制
- **监控告警**：实时监控系统状态

### 6.3 用户体验优化
- **加载优化**：首屏加载时间<3秒
- **交互优化**：流畅的用户交互
- **离线支持**：基础功能支持离线使用
- **推送通知**：及时的消息推送

## 7. 部署方案

### 7.1 环境配置
- **开发环境**：本地开发测试
- **测试环境**：功能测试和集成测试
- **生产环境**：正式上线运行

### 7.2 监控方案
- **系统监控**：服务器状态监控
- **业务监控**：关键业务指标监控
- **错误监控**：异常错误监控
- **用户监控**：用户行为监控

### 7.3 备份策略
- **数据备份**：每日自动备份
- **代码备份**：版本控制管理
- **配置备份**：重要配置备份
- **恢复方案**：数据恢复流程

## 8. 开发规范

### 8.1 代码规范
- **命名规范**：统一的命名规范
- **注释规范**：完善的代码注释
- **格式规范**：统一的代码格式
- **版本控制**：Git版本管理

### 8.2 测试规范
- **单元测试**：核心功能单元测试
- **集成测试**：接口集成测试
- **用户测试**：用户体验测试
- **性能测试**：系统性能测试

### 8.3 文档规范
- **API文档**：完整的API文档
- **部署文档**：详细的部署说明
- **用户手册**：用户使用手册
- **开发文档**：开发技术文档
